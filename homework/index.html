<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Bacheca Compiti Settimana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Stili per l'aspetto mobile-first */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none; /* Previene il "pull-to-refresh" laterale */
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory; /* Aggancia le colonne during lo scorrimento */
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 90%; /* Su mobile, ogni colonna occupa il 90% */
            scroll-snap-align: start; /* Aggancia l'inizio della colonna */
            margin-right: 10px;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi più grandi, si dividono lo spazio */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Stili per il modal di conferma (più piccolo) */
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        /* Stile per il contenuto dei modal AI (per formattare la risposta) */
        .ai-modal-content p {
            margin-bottom: 0.75rem; /* 12px */
            line-height: 1.6;
        }
        .ai-modal-content ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-bottom: 0.75rem;
        }
        .ai-modal-content li {
            margin-bottom: 0.25rem; /* 4px */
        }
        .ai-modal-content strong, .ai-modal-content h3 {
            font-weight: 600;
            color: #1F2937; /* gray-800 */
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                <!-- Titolo e Navigazione Settimana -->
                <div class="flex items-center justify-between w-full sm:w-auto">
                    <h1 class="text-xl font-bold text-gray-800">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>
                <!-- Pulsanti Azione -->
                <div class="flex flex-wrap justify-center gap-2 mt-4 sm:mt-0">
                    <button id="openAiPlannerButton" class="px-4 py-2 text-base font-medium text-purple-600 bg-purple-100 rounded-lg shadow-sm hover:bg-purple-200 transition">
                        AI Planner
                    </button>
                    <button id="todayBtn" class="px-4 py-2 text-base font-medium text-blue-600 bg-blue-100 rounded-lg shadow-sm hover:bg-blue-200 transition">
                        Oggi
                    </button>
                    <!-- Pulsante Impegni (NUOVO) -->
                    <button id="openCommitmentsButton" class="px-4 py-2 text-base font-medium text-green-600 bg-green-100 rounded-lg shadow-sm hover:bg-green-200 transition">
                        Impegni
                    </button>
                    <button id="openTimetableButton" class="px-4 py-2 text-base font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition">
                        Orario
                    </button>
                </div>
            </div>
        </header>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="flex-1 overflow-hidden p-3 sm:p-4">
            <!-- Contenitore con scorrimento orizzontale -->
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full gap-3">
                <!-- Le colonne dei giorni (Lunedì-Venerdì) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">-- Seleziona Giorno --</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Visualizzare l'Orario -->
    <div id="viewTimetableModal" class="modal">
        <div class="modal-content max-w-3xl">
            <h2 class="text-lg font-semibold mb-4">Orario Settimanale</h2>
            
            <div id="viewTimetableModalContent" class="max-h-[70vh] overflow-x-auto overflow-y-auto">
                <!-- Tabella orario generata da JS -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" id="closeViewTimetableModalButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione (Personalizzato) -->
    <div id="confirmModal" class="modal" style="z-index: 60;">
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>
    
    <!-- 6. Modal Assistente AI (per singolo compito) -->
    <div id="aiModal" class="modal" style="z-index: 60;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-blue-600">Assistente AI</h2>
                <button id="closeAiModalButton" class="p-2 rounded-full hover:bg-gray-100">
                    <span data-lucide="X" class="w-5 h-5 text-gray-600"></span>
                </button>
            </div>
            
            <div id="aiModalContent" class="ai-modal-content max-h-[60vh] overflow-y-auto text-gray-700 text-sm">
                <!-- Contenuto generato dall'AI -->
            </div>
        </div>
    </div>
    
    <!-- 7. Modal AI Planner -->
    <div id="aiPlannerModal" class="modal" style="z-index: 60;">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-purple-600">Piano di Studio AI</h2>
                <button id="closeAiPlannerModalButton" class="p-2 rounded-full hover:bg-gray-100">
                    <span data-lucide="X" class="w-5 h-5 text-gray-600"></span>
                </button>
            </div>
            
            <div id="aiPlannerModalContent" class="ai-modal-content max-h-[60vh] overflow-y-auto text-gray-700 text-sm">
                <!-- Contenuto generato dall'AI Planner -->
            </div>
        </div>
    </div>
    
    <!-- 8. Modal per Impegni Settimanali (NUOVO) -->
    <div id="commitmentsModal" class="modal">
        <div class="modal-content max-w-lg">
            <h2 class="text-lg font-semibold mb-4">Impegni Settimanali Fissi</h2>
            <form id="commitmentsForm">
                <p class="text-sm text-gray-600 mb-4">Inserisci qui gli impegni pomeridiani fissi (es. sport, musica) per aiutare l'AI a pianificare meglio.</p>
                <div class="space-y-3">
                    <div>
                        <label for="commit-mon" class="block text-sm font-medium text-gray-700">Lunedì</label>
                        <input type="text" id="commit-mon" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Es. 17:00 - 18:00: Pianoforte">
                    </div>
                    <div>
                        <label for="commit-tue" class="block text-sm font-medium text-gray-700">Martedì</label>
                        <input type="text" id="commit-tue" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Es. 17:00 - 19:00: Pallavolo">
                    </div>
                    <div>
                        <label for="commit-wed" class="block text-sm font-medium text-gray-700">Mercoledì</label>
                        <input type="text" id="commit-wed" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="commit-thu" class="block text-sm font-medium text-gray-700">Giovedì</label>
                        <input type="text" id="commit-thu" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="commit-fri" class="block text-sm font-medium text-gray-700">Venerdì</label>
                        <input type="text" id="commit-fri" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" id="closeCommitmentsModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Impegni</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {};
        let taskUnsubscribe = null;
        let commitmentsUnsubscribe = null; // Listener per Impegni
        let localCommitments = {}; // Cache locale per Impegni
        let isAiCallPending = false;

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        
        // Modal Compiti
        const modalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        // Modal Orario (Visualizzazione)
        const viewTimetableModalEl = document.getElementById('viewTimetableModal');
        const viewTimetableModalContentEl = document.getElementById('viewTimetableModalContent');
        
        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null;
        
        // Modal AI (Compito singolo)
        const aiModalEl = document.getElementById('aiModal');
        const aiModalContentEl = document.getElementById('aiModalContent');
        const closeAiModalButtonEl = document.getElementById('closeAiModalButton');
        
        // Modal AI Planner
        const aiPlannerModalEl = document.getElementById('aiPlannerModal');
        const aiPlannerModalContentEl = document.getElementById('aiPlannerModalContent');
        const openAiPlannerButtonEl = document.getElementById('openAiPlannerButton');
        const closeAiPlannerModalButtonEl = document.getElementById('closeAiPlannerModalButton');
        
        // Modal Impegni (NUOVO)
        const commitmentsModalEl = document.getElementById('commitmentsModal');
        const commitmentsFormEl = document.getElementById('commitmentsForm');
        const openCommitmentsButtonEl = document.getElementById('openCommitmentsButton');
        const closeCommitmentsModalButtonEl = document.getElementById('closeCommitmentsModalButton');

        // Configurazione Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- LOGICA ORARIO FISSO ---
        const dayNames = { mon: 'Lunedì', tue: 'Martedì', wed: 'Mercoledì', thu: 'Giovedì', fri: 'Venerdì' };
        
        const TIMETABLE_HOURS_MAP = {
            mon: [8, 9, 10, 11, 12], // 5 ore
            tue: [8, 9, 10, 11, 12, 13], // 6 ore
            wed: [8, 9, 10, 11, 12], // 5 ore
            thu: [8, 9, 10, 11, 12, 13], // 6 ore
            fri: [8, 9, 10, 11, 12]  // 5 ore
        };

        const FIXED_TIMETABLE = {
            mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"],
            tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"],
            wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"],
            thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"],
            fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"]
        };
        // --- Fine Logica Orario Fisso ---

        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova più tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        async function loadUserData() {
            if (!userId) return;
            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';
            
            // Carica gli impegni (e popola il modal) PRIMA di renderizzare la settimana
            await attachCommitmentsListener(); 
            
            // Ora renderizza la settimana (userà localCommitments)
            renderWeekDisplay(currentWeekStart);
            
            // Infine, attacca il listener dei compiti
            await attachTaskListener();
        }

        // --- Funzioni Orario (Visualizzazione) ---
        
        function openTimetableModal() {
            const hours = [8, 9, 10, 11, 12, 13];
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ora</th>
            `;
            days.forEach(dayKey => {
                tableHtml += `<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${dayNames[dayKey]}</th>`;
            });
            tableHtml += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            hours.forEach((hour, hourIndex) => {
                tableHtml += `<tr class="even:bg-gray-50">`; // Righe alternate
                tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${hour}:00 - ${hour+1}:00</td>`;
                
                days.forEach(dayKey => {
                    const subject = FIXED_TIMETABLE[dayKey][hourIndex];
                    if (subject) {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${subject}</td>`;
                    } else {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">-</td>`; // Ora vuota
                    }
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table>`;
            
            viewTimetableModalContentEl.innerHTML = tableHtml;
            viewTimetableModalEl.style.display = 'flex';
        }
        
        function closeTimetableModal() {
            viewTimetableModalEl.style.display = 'none';
        }

        function generateTimetableHTML(dayKey) {
            const hours = TIMETABLE_HOURS_MAP[dayKey];
            const subjects = FIXED_TIMETABLE[dayKey];
            if (!hours || !subjects) return '<p class="text-xs text-gray-400 italic">Orario non definito</p>';
            
            let htmlEntries = [];
            let i = 0;
            while (i < subjects.length) {
                let subject = subjects[i];
                let startHour = hours[i];
                let j = i + 1;
                while (j < subjects.length && subjects[j] === subject) {
                    j++;
                }
                let endHour = hours[j - 1] + 1; 
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${subject}</span></p>`);
                i = j;
            }
            if (htmlEntries.length === 0) return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            return htmlEntries.join('\n');
        }
        
        // --- Funzioni Gestione Impegni (NUOVE) ---

        async function attachCommitmentsListener() {
            if (commitmentsUnsubscribe) commitmentsUnsubscribe();
            
            const commitmentsDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            
            return new Promise((resolve) => {
                commitmentsUnsubscribe = onSnapshot(commitmentsDocRef, (docSnap) => {
                    console.log("Dati impegni ricevuti:", docSnap.exists() ? docSnap.data() : "Nessun dato");
                    localCommitments = docSnap.exists() ? docSnap.data() : {};
                    
                    // Popola il modal
                    for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        const inputEl = document.getElementById(`commit-${dayKey}`);
                        if (inputEl) {
                            inputEl.value = localCommitments[dayKey] || '';
                        }
                    }
                    
                    // Aggiorna la vista
                    renderWeekCommitments();
                    resolve(); // Risolve la promessa una volta caricati i dati
                }, (error) => {
                    console.error("Errore nel listener degli impegni:", error);
                    showError("Impossibile caricare gli impegni.");
                    resolve(); // Risolve comunque per non bloccare l'app
                });
            });
        }

        async function handleSaveCommitments(e) {
            e.preventDefault();
            if (!userId) return;

            const commitmentsData = {};
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                const inputEl = document.getElementById(`commit-${dayKey}`);
                commitmentsData[dayKey] = inputEl.value.trim() || '';
            }

            try {
                const commitmentsDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
                await setDoc(commitmentsDocRef, commitmentsData);
                console.log("Impegni salvati:", commitmentsData);
                closeCommitmentsModal();
                // onSnapshot aggiornerà localCommitments e la UI
            } catch (error) {
                console.error("Errore salvataggio impegni:", error);
                showError("Errore nel salvataggio degli impegni.");
            }
        }
        
        function openCommitmentsModal() {
            // I dati sono già popolati nel modal dal listener
            commitmentsModalEl.style.display = 'flex';
        }

        function closeCommitmentsModal() {
            commitmentsModalEl.style.display = 'none';
        }

        // Popola la sezione "Impegni" nelle colonne dei giorni
        function renderWeekCommitments() {
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                const displayEl = document.getElementById(`commitments-display-${dayKey}`);
                if (displayEl) {
                    const commitmentText = localCommitments[dayKey];
                    if (commitmentText) {
                        displayEl.innerHTML = `<p class="text-xs text-gray-800 font-semibold">${commitmentText}</p>`;
                    } else {
                        displayEl.innerHTML = `<p class="text-xs text-gray-400 italic">Nessun impegno</p>`;
                    }
                }
            }
        }


        // --- Funzioni Gestione Compiti (Tasks) ---

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {};
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = doc.data();
                });
                renderWeekDisplay(currentWeekStart); 
            }, (error) => {
                console.error("Errore nel listener dei compiti:", error);
                showError("Impossibile caricare i compiti.");
            });
        }

        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;
            const id = taskIdEl.value;
            const taskData = {
                subject: taskFormEl.subject.value,
                description: taskFormEl.description.value,
                dueDate: taskFormEl.dueDate.value,
                completed: taskFormEl.querySelector(`#task-${id}`)?.dataset.completed === 'true' || false
            };
            
            try {
                if (id) {
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal();
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
                showError("Impossibile salvare il compito.");
            }
        }

        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;

            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            
            populateSubjectDropdown(task.dueDate);
            
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;

            const subjectSelectEl = document.getElementById('subject');
            if (task.subject && !subjectSelectEl.querySelector(`option[value="${task.subject}"]`)) {
                const oldOption = document.createElement('option');
                oldOption.value = task.subject;
                oldOption.textContent = `${task.subject} (vecchia)`;
                subjectSelectEl.appendChild(oldOption);
                taskFormEl.subject.value = task.subject;
            }
            modalEl.style.display = 'flex';
        }

        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
                showError("Impossibile aggiornare il compito.");
            }
        }

        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
                showError("Impossibile eliminare il compito.");
            }
        }


        // --- Funzioni di Rendering UI ---

        function renderWeekDisplay(startDate) {
            if (!weekScrollContainerEl) return;
            weekScrollContainerEl.innerHTML = '';
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);
            const days = getWeekDays(startDate);

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase().substring(0, 3);
                const timetableHtml = generateTimetableHTML(dayKey);
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-column bg-white rounded-xl shadow-sm p-3 flex flex-col';
                dayCard.id = `day-${dateStr}`;
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    
                    <!-- Sezione Orario -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">${timetableHtml}</div>
                    
                    <!-- Sezione Impegni (NUOVA) -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Impegni</h3>
                    <div id="commitments-display-${dayKey}" class="commitments-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[30px]">
                        <!-- Popolato da renderWeekCommitments -->
                    </div>

                    <!-- Sezione Compiti -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto"></div>`;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    openModal(date);
                });
            });

            populateTasksForWeek(days);
            renderWeekCommitments(); // Popola gli impegni con i dati in cache
            lucide.createIcons();
        }

        function populateTasksForWeek(days) {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const dateStrings = days.map(day => formatDate(day.date));
            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }

        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return;

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer';
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-col sm:flex-row gap-1 ml-auto';

            const aiButton = document.createElement('button');
            aiButton.className = 'p-1 rounded-full hover:bg-blue-100';
            aiButton.title = 'Assistente AI';
            aiButton.innerHTML = `<span data-lucide="Sparkles" class="text-blue-500 hover:text-blue-700" width="16" height="16"></span>`;
            aiButton.addEventListener('click', () => openAiModal(data.subject, data.description));
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.title = 'Elimina';
            deleteButton.innerHTML = `<span data-lucide="Trash2" class="text-red-500 hover:text-red-700" width="16" height="16"></span>`;
            deleteButton.addEventListener('click', () => handleDeleteTask(id));

            actionsDiv.appendChild(aiButton);
            actionsDiv.appendChild(deleteButton);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(actionsDiv);

            taskListContainer.appendChild(taskEl);
            lucide.createIcons({ nodes: [taskEl] });
        }

        // --- Funzione per popolare il dropdown materie (da orario fisso) ---
        function populateSubjectDropdown(dateStr) {
            const subjectSelectEl = document.getElementById('subject');
            subjectSelectEl.innerHTML = '<option value="">-- Seleziona Materia --</option>';
            if (!dateStr) return;

            try {
                const dateObj = new Date(dateStr + 'T12:00:00');
                const dayOfWeek = dateObj.getDay(); 
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                if (!dayKey || dayKey === 'sun' || dayKey === 'sat') return;

                const daySubjects = FIXED_TIMETABLE[dayKey] || [];
                const uniqueSubjects = [...new Set(daySubjects)];
                uniqueSubjects.sort();

                uniqueSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelectEl.appendChild(option);
                });
            } catch (e) {
                console.error("Errore nel popolare le materie:", e);
                subjectSelectEl.innerHTML = '<option value="">Errore nel caricare le materie</option>';
            }
        }


        // --- Funzioni Modal (Finestre Popup) ---

        function openModal(defaultDate = null) {
            taskFormEl.reset();
            modalTitleEl.innerText = "Nuovo Compito";
            taskIdEl.value = '';
            taskFormEl.dueDate.value = defaultDate ? defaultDate : formatDate(new Date());
            populateSubjectDropdown(defaultDate);
            modalEl.style.display = 'flex';
        }

        function closeModal() {
            modalEl.style.display = 'none';
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            confirmModalEl.style.display = 'flex';
        }
        
        function closeConfirm() {
            confirmModalEl.style.display = 'none';
            confirmCallback = null;
        }

        // --- Funzioni Assistente AI (Compito singolo) ---

        function openAiModal(subject, description) {
            if (isAiCallPending) return;
            
            aiModalEl.style.display = 'flex';
            aiModalContentEl.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <span data-lucide="Loader" class="w-6 h-6 text-blue-500 animate-spin"></span>
                    <p class="ml-3 text-gray-600">L'assistente sta cercando informazioni...</p>
                </div>
            `;
            lucide.createIcons({ nodes: [aiModalContentEl] });

            callGeminiApi(subject, description);
        }

        function closeAiModal() {
            aiModalEl.style.display = 'none';
            aiModalContentEl.innerHTML = '';
        }

        async function callGeminiApi(subject, description) {
            isAiCallPending = true;

            const systemPrompt = `Sei un assistente tutor (per una studentessa di scuola media o superiore in Italia).
Rispondi sempre in italiano.
Il tuo compito è analizzare il compito assegnato e fornire supporto.
Formatta la risposta in HTML semplice (paragrafi <p>, liste <ul><li> e grassetto <strong>).

La tua risposta deve essere strutturata in 2 parti:
1.  **Breve Spiegazione:** Una spiegazione concisa (massimo 2-3 frasi) dell'argomento principale.
2.  **Consigli Pratici:** Una lista puntata (massimo 3-4 punti) con consigli pratici e specifici per *come* svolgere quel compito.`;
            
            const userQuery = `Il mio compito è:
- Materia: ${subject}
- Descrizione: ${description}

Forniscimi la spiegazione e i consigli pratici, basandoti su informazioni aggiornate (usa la ricerca se necessario).`;
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let text = result.candidates[0].content.parts[0].text;
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/ \*(.*?)/g, '<li>$1</li>');
                    aiModalContentEl.innerHTML = text;
                } else {
                    aiModalContentEl.innerHTML = '<p class="text-red-500">Non ho trovato una risposta valida. Riprova.</p>';
                }
            } catch (error) {
                console.error("Errore chiamata AI:", error);
                aiModalContentEl.innerHTML = `<p class="text-red-500">C'è stato un errore nel contattare l'assistente: ${error.message}</p>`;
            } finally {
                isAiCallPending = false;
            }
        }
        
        // --- Funzioni AI Planner (AGGIORNATE CON IMPEGNI) ---

        function openAiPlannerModal() {
            if (isAiCallPending) return;
            
            aiPlannerModalEl.style.display = 'flex';
            aiPlannerModalContentEl.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <span data-lucide="Loader" class="w-6 h-6 text-purple-500 animate-spin"></span>
                    <p class="ml-3 text-gray-600">L'AI sta creando il tuo piano di studio...</p>
                </div>
            `;
            lucide.createIcons({ nodes: [aiPlannerModalContentEl] });
            
            callGeminiPlannerApi();
        }
        
        function closeAiPlannerModal() {
            aiPlannerModalEl.style.display = 'none';
            aiPlannerModalContentEl.innerHTML = '';
        }
        
        async function callGeminiPlannerApi() {
            isAiCallPending = true;

            // 1. Raccogli i compiti *non completati* per la settimana corrente
            const days = getWeekDays(currentWeekStart);
            const dateStrings = days.map(day => formatDate(day.date));
            const tasksForWeek = [];
            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate) && !task.completed) {
                    tasksForWeek.push(`- ${task.subject}: ${task.description} (Scadenza: ${task.dueDate})`);
                }
            }
            
            // 1b. Raccogli gli impegni fissi (NUOVO)
            const commitmentsForWeek = [];
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                if (localCommitments[dayKey]) {
                    commitmentsForWeek.push(`- ${dayNames[dayKey]}: ${localCommitments[dayKey]}`);
                }
            }
            
            if (tasksForWeek.length === 0) {
                 aiPlannerModalContentEl.innerHTML = `
                    <div class="text-center">
                        <span data-lucide="CheckCheck" class="w-12 h-12 mx-auto text-green-500"></span>
                        <h3 class="font-semibold mt-2">Tutto Fatto!</h3>
                        <p class="text-sm text-gray-600 mt-1">Non ci sono compiti da pianificare per questa settimana. Ottimo lavoro!</p>
                    </div>
                `;
                lucide.createIcons({ nodes: [aiPlannerModalContentEl] });
                isAiCallPending = false;
                return;
            }

            // 2. Formatta l'orario scolastico
            const formattedTimetable = Object.entries(FIXED_TIMETABLE).map(([dayKey, subjects]) => {
                const dayName = dayNames[dayKey];
                const hours = TIMETABLE_HOURS_MAP[dayKey];
                const subjectList = subjects.map((subj, index) => `  ${hours[index]}:00-${hours[index]+1}:00: ${subj}`).join('\n');
                return `${dayName}:\n${subjectList}`;
            }).join('\n\n');
            
            // 3. Prepara i prompt (AGGIORNATI)
            const today = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const systemPrompt = `Sei un "Tutor di Pianificazione" esperto per studenti italiani.
Il tuo obiettivo è creare un piano di studio POMERIDIANO realistico, motivante e facile da seguire.
Rispondi sempre in italiano.
Formatta la risposta in HTML semplice (paragrafi <p>, liste <ul><li>, grassetto <strong> e titoli <h3>).

Regole Chiave:
1.  **Analizza i Dati:** Riceverai la data di oggi, l'orario scolastico (mattina), un elenco di *impegni fissi* (sport, musica, ecc.) e un elenco di compiti con scadenze.
2.  **Pianifica solo i Pomeriggi:** Il tuo piano deve iniziare dal pomeriggio di "oggi" fino a venerdì.
3.  **RISPETTA GLI IMPEGNI FISSI:** Gli impegni fissi hanno la priorità assoluta. Devi pianificare lo studio *attorno* a questi orari bloccati. Non sovrapporre lo studio agli impegni.
4.  **Dai Priorità (Compiti):** Assegna priorità ai compiti con scadenza più vicina.
5.  **Sii Realistico:** Non sovraccaricare. Alterna materie (es. non 2 ore di fila di Matematica). Includi brevi pause.
6.  **Struttura:** Dividi il piano per giorno (es. <h3>Piano per Oggi (Martedì)</h3>). Per ogni giorno, crea una lista puntata <ul><li> con i compiti da fare e un orario suggerito (es. "15:00-15:45: Matematica"). Assicurati di menzionare gli impegni fissi nel piano (es. "17:00-19:00: Pallavolo").
7.  **Tono:** Sii incoraggiante e positivo. Inizia con una breve frase di incoraggiamento.`;
            
            const userQuery = `Ciao! Oggi è ${today}.
Questo è il mio orario scolastico (so quando sono a scuola la mattina):
${formattedTimetable}

Questi sono i miei *impegni fissi* (sport, ecc.) da rispettare:
${commitmentsForWeek.length > 0 ? commitmentsForWeek.join('\n') : "Nessun impegno fisso questa settimana."}

Questi sono i miei *compiti* da fare per questa settimana:
${tasksForWeek.join('\n')}

Per favore, creami un piano di studio pomeridiano (da oggi a venerdì) che rispetti i miei impegni fissi e mi permetta di completare i compiti in tempo.`;

            // 4. Chiama l'API (SENZA Google Search)
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let text = result.candidates[0].content.parts[0].text;
                    // Sostituzioni per formattare l'HTML
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/### (.*?)\n/g, '<h3>$1</h3>');
                    text = text.replace(/\* (.*?)\n/g, '<li>$1</li>');
                    text = text.replace(/<ul>\s*<li>/g, '<ul><li>'); // Pulisce spazi
                    text = text.replace(/<\/li>\s*<\/ul>/g, '</li></ul>'); // Pulisce spazi
                    aiPlannerModalContentEl.innerHTML = text;
                } else {
                    aiPlannerModalContentEl.innerHTML = '<p class="text-red-500">Non ho trovato un piano valido. Riprova.</p>';
                }
            } catch (error) {
                console.error("Errore chiamata AI Planner:", error);
                aiPlannerModalContentEl.innerHTML = `<p class="text-red-500">C'è stato un errore nel creare il piano: ${error.message}</p>`;
            } finally {
                isAiCallPending = false;
            }
        }


        // --- Funzioni Utilità (Date, Errori) ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            for (let i = 0; i < 5; i++) {
                days.push({ name: dayNames[i], date: new Date(d), value: dayValues[i] });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            return `${startStr} - ${endStr}`;
        }
        
        function showError(message) {
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message);
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart);
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentWeekStart = getStartOfWeek(new Date());
                renderWeekDisplay(currentWeekStart);
                lucide.createIcons();
            });

            // Modal Compiti
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            taskFormEl.addEventListener('submit', handleSaveTask);

            // Modal Orario (Visualizzazione)
            document.getElementById('openTimetableButton').addEventListener('click', openTimetableModal);
            document.getElementById('closeViewTimetableModalButton').addEventListener('click', closeTimetableModal);
            
            // Modal Conferma
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirm();
            });
            
            // Modal AI (Compito singolo)
            closeAiModalButtonEl.addEventListener('click', closeAiModal);
            
            // Modal AI Planner
            openAiPlannerButtonEl.addEventListener('click', openAiPlannerModal);
            closeAiPlannerModalButtonEl.addEventListener('click', closeAiPlannerModal);
            
            // Modal Impegni (NUOVO)
            openCommitmentsButtonEl.addEventListener('click', openCommitmentsModal);
            closeCommitmentsModalButtonEl.addEventListener('click', closeCommitmentsModal);
            commitmentsFormEl.addEventListener('submit', handleSaveCommitments);

            // Avvia l'app
            initializeFirebase();
        });

    </script>
</body>
</html>
