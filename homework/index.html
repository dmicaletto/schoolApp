<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none;
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 100%; /* Su mobile, ogni colonna occupa il 90% */
            scroll-snap-align: start;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi più grandi, si dividono lo spazio */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Stili per il modal di conferma (più piccolo) */
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        /* Stili Chat Generali */
        .chat-container {
            height: 350px; /* Altezza fissa per le chat */
            overflow-y: auto;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-model {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937; /* gray-800 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-model.planner { /* Colore custom per planner */
            background-color: #F3E8FF; /* purple-100 */
            color: #3730A3; /* purple-800 */
        }
        .loading-bubble {
            display: flex;
            gap: 1.5px;
            align-items: center;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Stili Tabella Orario */
        #timetableModalTable {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
        }
        #timetableModalTable table {
            width: 100%;
            min-width: 600px; /* Forza lo scorrimento su mobile */
            border-collapse: collapse;
        }
        #timetableModalTable th, #timetableModalTable td {
            border: 1px solid #E5E7EB;
            padding: 10px;
            text-align: left;
            font-size: 0.875rem;
        }
        #timetableModalTable th {
            background-color: #F9FAFB;
        }
        #timetableModalTable tbody tr:nth-child(odd) {
            background-color: #F9FAFB; /* Grigio chiaro alternato */
        }

        /* Animazione per caricamento */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                
                <!-- Titolo e Navigazione Settimana (Sinistra) -->
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>

                <!-- Pulsanti Azione (Destra) -->
                <div class="flex items-center gap-2">
                    <button id="todayBtn" class="px-4 py-2 text-base font-medium text-blue-600 bg-blue-100 rounded-lg shadow-sm hover:bg-blue-200 transition">
                        Oggi
                    </button>
                    
                    <!-- Menu Dropdown -->
                    <div class="relative" id="menuContainer">
                        <button id="menuToggleBtn" class="p-2 rounded-lg hover:bg-gray-100">
                            <span data-lucide="Menu" class="w-5 h-5 text-gray-700"></span>
                        </button>
                        <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border z-50">
                            <a id="openAiPlannerButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="BrainCircuit" class="w-5 h-5 text-purple-600"></span>
                                AI Planner
                            </a>
                            <a id="openCommitmentsButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="CalendarClock" class="w-5 h-5 text-green-600"></span>
                                Impegni
                            </a>
                            <a id="openFutureDeadlinesButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="Target" class="w-5 h-5 text-red-600"></span>
                                Scadenze Future
                            </a>
                            <a id="openTimetableButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="BookOpen" class="w-5 h-5 text-blue-600"></span>
                                Orario
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Banner Notifiche Scadenze -->
        <div id="notificationBanner" class="hidden sticky top-[65px] z-20">
            <!-- Il contenuto verrà generato da JS -->
        </div>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="hidden flex-1 overflow-hidden p-3 sm:p-4">
            <!-- Contenitore con scorrimento orizzontale -->
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full gap-3">
                <!-- Le colonne dei giorni (Lunedì-Venerdì) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                        <!-- Opzioni generate da JS -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Orario Settimanale (Sola lettura) -->
    <div id="timetableModal" class="modal">
        <div class="modal-content max-w-3xl"> <!-- Reso più largo per l'orario -->
            <h2 class="text-lg font-semibold mb-4">Orario Settimanale</h2>
            <div id="timetableModalTable" class="rounded-lg border">
                <!-- Tabella orario generata da JS -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione -->
    <div id="confirmModal" class="modal" style="z-index: 60;">
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>

    <!-- 6. Modal Assistente AI (Chat) -->
    <div id="aiAssistantModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span data-lucide="Sparkles" class="w-5 h-5 text-blue-500"></span>
                Assistente AI
            </h2>
            <!-- Area Chat -->
            <div id="aiChatHistory" class="chat-container p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 flex flex-col gap-3">
                <!-- Messaggi della chat generati da JS -->
            </div>
            <!-- Input Chat -->
            <form id="aiChatForm" class="flex gap-2">
                <input type="text" id="aiChatInput" placeholder="Fai una domanda..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" id="aiChatSendButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center justify-center">
                    <span data-lucide="Send" class="w-5 h-5"></span>
                </button>
            </form>
            <div class="flex justify-end mt-4">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 7. Modal AI Planner (NUOVA Chat) -->
    <div id="aiPlannerModal" class="modal">
         <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span data-lucide="BrainCircuit" class="w-5 h-5 text-purple-600"></span>
                Piano di Studio AI (Chat)
            </h2>
            <!-- Area Chat Planner -->
            <div id="aiPlannerChatHistory" class="chat-container p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 flex flex-col gap-3">
                <!-- Messaggi della chat generati da JS -->
            </div>
            <!-- Input Chat Planner -->
            <form id="aiPlannerChatForm" class="flex gap-2">
                <input type="text" id="aiPlannerChatInput" placeholder="Modifica il piano..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" id="aiPlannerChatSendButton" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition flex items-center justify-center">
                    <span data-lucide="Send" class="w-5 h-5"></span>
                </button>
            </form>
             <div class="flex justify-end mt-4">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 8. Modal Impegni Settimanali -->
    <div id="commitmentsModal" class="modal">
        <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4">Impegni Settimanali</h2>
            <p class="text-sm text-gray-600 mb-4">Inserisci qui i tuoi impegni fissi (es. sport, musica, appuntamenti). L'AI Planner li userà per organizzare lo studio.</p>
            <form id="commitmentsForm">
                <div id="commitmentsModalContent" class="space-y-4">
                    <!-- Input per gli impegni generati da JS -->
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Impegni</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 9. Modal Scadenze Future -->
    <div id="futureDeadlinesModal" class="modal">
        <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4">Radar Scadenze Future</h2>
            <p class="text-sm text-gray-600 mb-4">Aggiungi qui verifiche, consegne e interrogazioni importanti. L'app te le ricorderà e l'AI le userà per pianificare il ripasso.</p>
            
            <!-- Form per Aggiungere Nuova Scadenza -->
            <form id="futureDeadlineForm" class="flex flex-col sm:flex-row gap-3 mb-6 pb-6 border-b">
                <input type="text" id="futureDeadlineDescription" placeholder="Descrizione (es. Verifica Latino)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <input type="date" id="futureDeadlineDate" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Aggiungi</button>
            </form>
            
            <!-- Lista Scadenze Esistenti -->
            <h3 class="text-md font-semibold mb-3">Scadenze Salve</h3>
            <div id="futureDeadlinesList" class="space-y-2 max-h-[30vh] overflow-y-auto">
                <!-- Lista generata da JS -->
            </div>
            
            <div class="flex justify-end mt-6 pt-4 border-t">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {}; // Cache locale dei compiti
        let allFutureDeadlines = []; // Cache scadenze future
        
        // Listener di Firestore
        let taskUnsubscribe = null;
        let commitmentUnsubscribe = null;
        let futureDeadlinesUnsubscribe = null;

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        const notificationBannerEl = document.getElementById('notificationBanner');
        
        // Modal Compiti
        const taskModalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        // Modal Orario
        const timetableModalEl = document.getElementById('timetableModal');
        
        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null; // Funzione da eseguire alla conferma
        
        // Modal AI Assistant
        const aiAssistantModalEl = document.getElementById('aiAssistantModal');
        const aiChatHistoryEl = document.getElementById('aiChatHistory');
        const aiChatFormEl = document.getElementById('aiChatForm');
        const aiChatInputEl = document.getElementById('aiChatInput');
        const aiChatSendButtonEl = document.getElementById('aiChatSendButton');
        let currentAiChatHistory = [];
        let currentAiTaskId = null;

        // Modal AI Planner (NUOVO)
        const aiPlannerModalEl = document.getElementById('aiPlannerModal');
        const aiPlannerChatHistoryEl = document.getElementById('aiPlannerChatHistory');
        const aiPlannerChatFormEl = document.getElementById('aiPlannerChatForm');
        const aiPlannerChatInputEl = document.getElementById('aiPlannerChatInput');
        const aiPlannerChatSendButtonEl = document.getElementById('aiPlannerChatSendButton');
        let currentAiPlannerChatHistory = []; // Cronologia per la sessione del planner
        
        // Modal Impegni
        const commitmentsModalEl = document.getElementById('commitmentsModal');
        const commitmentsFormEl = document.getElementById('commitmentsForm');
        
        // Modal Scadenze Future
        const futureDeadlinesModalEl = document.getElementById('futureDeadlinesModal');
        const futureDeadlineFormEl = document.getElementById('futureDeadlineForm');
        const futureDeadlinesListEl = document.getElementById('futureDeadlinesList');
        
        // Menu Dropdown
        const menuContainer = document.getElementById('menuContainer');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const menuDropdown = document.getElementById('menuDropdown');

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Orario Fisso ---
        const timetable = {
            mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"],
            tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"],
            wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"],
            thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"],
            fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"]
        };
        const dayNames = { mon: 'Lunedì', tue: 'Martedì', wed: 'Mercoledì', thu: 'Giovedì', fri: 'Venerdì' };
        const hourSlots = ["8:00-9:00", "9:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "13:00-14:00"];


        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        await loadAllUserData();
                    } else {
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova più tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        // Carica tutti i dati (Compiti, Impegni, Scadenze)
        async function loadAllUserData() {
            if (!userId) return;

            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';

            // Costruisce i modal statici
            setupTimetableModal();
            setupCommitmentsModal();

            // Attacca tutti i listener di Firestore
            attachTaskListener();
            attachCommitmentListener();
            attachFutureDeadlinesListener();
            
            // Renderizza la settimana (inizialmente vuota, verrà popolata dai listener)
            renderWeekDisplay(currentWeekStart);
        }

        // --- Listener di Firestore ---

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {};
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderWeekDisplay(currentWeekStart); // Ridisegna la settimana
            }, (error) => console.error("Errore listener compiti:", error));
        }

        function attachCommitmentListener() {
            if (commitmentUnsubscribe) commitmentUnsubscribe();
            const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            
            commitmentUnsubscribe = onSnapshot(commitmentDocRef, (docSnap) => {
                console.log("Dati impegni ricevuti.");
                const commitments = docSnap.exists() ? docSnap.data() : {};
                // Popola il modal con i dati caricati
                for (const dayKey of Object.keys(dayNames)) {
                    const inputEl = document.getElementById(`commitment-${dayKey}`);
                    if (inputEl) {
                        inputEl.value = commitments[dayKey] || '';
                    }
                }
                renderWeekDisplay(currentWeekStart); // Ridisegna la settimana
            }, (error) => console.error("Errore listener impegni:", error));
        }

        function attachFutureDeadlinesListener() {
            if (futureDeadlinesUnsubscribe) futureDeadlinesUnsubscribe();
            const deadlinesCollectionRef = collection(db, "artifacts", appId, "users", userId, "future_deadlines");
            
            futureDeadlinesUnsubscribe = onSnapshot(deadlinesCollectionRef, (querySnapshot) => {
                console.log("Dati scadenze future ricevuti.");
                allFutureDeadlines = [];
                querySnapshot.forEach((doc) => {
                    allFutureDeadlines.push({ id: doc.id, ...doc.data() });
                });
                // Ordina per data
                allFutureDeadlines.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                renderFutureDeadlinesList(); // Aggiorna la lista nel modal
                renderNotificationBanner(); // Aggiorna il banner
                renderWeekDisplay(currentWeekStart); // Ridisegna la settimana
            }, (error) => console.error("Errore listener scadenze:", error));
        }
        
        
        // --- Funzioni Orario (Fisso) ---
        
        function setupTimetableModal() {
            const tableContainer = document.getElementById('timetableModalTable');
            let tableHtml = '<table><thead><tr><th>Ora</th>';
            Object.values(dayNames).forEach(name => tableHtml += `<th>${name}</th>`);
            tableHtml += '</tr></thead><tbody>';

            hourSlots.forEach((hour, hourIndex) => {
                // Colori alternati
                tableHtml += `<tr class="${hourIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}"><td><strong>${hour}</strong></td>`;
                Object.keys(dayNames).forEach(dayKey => {
                    const subject = timetable[dayKey][hourIndex] || '---';
                    tableHtml += `<td>${subject}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
        }

        function getSubjectsForDay(dayKey) {
            if (!timetable[dayKey]) return [];
            // Rimuove duplicati
            return [...new Set(timetable[dayKey])]; 
        }

        
        // --- Funzioni Impegni Settimanali ---
        
        function setupCommitmentsModal() {
            const contentEl = document.getElementById('commitmentsModalContent');
            let html = '';
            Object.keys(dayNames).forEach(dayKey => {
                html += `<div>
                    <label for="commitment-${dayKey}" class="block text-sm font-medium text-gray-700">${dayNames[dayKey]}</label>
                    <input type="text" id="commitment-${dayKey}" 
                           placeholder="es. 17:00 - 19:00 Pallavolo"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>`;
            });
            contentEl.innerHTML = html;
        }
        
        async function handleSaveCommitments(e) {
            e.preventDefault();
            if (!userId) return;

            const commitmentsData = {};
            Object.keys(dayNames).forEach(dayKey => {
                commitmentsData[dayKey] = document.getElementById(`commitment-${dayKey}`).value.trim();
            });

            try {
                const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
                await setDoc(commitmentDocRef, commitmentsData);
                closeModal(commitmentsModalEl);
            } catch (error) {
                console.error("Errore salvataggio impegni:", error);
            }
        }
        
        async function getCommitments() {
            // Prende i dati attuali dal DB (per AI Planner)
            const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            const docSnap = await getDoc(commitmentDocRef);
            return docSnap.exists() ? docSnap.data() : {};
        }


        // --- Funzioni Scadenze Future (Nuove) ---
        
        async function handleSaveFutureDeadline(e) {
            e.preventDefault();
            if (!userId) return;
            
            const description = futureDeadlineFormEl.futureDeadlineDescription.value;
            const date = futureDeadlineFormEl.futureDeadlineDate.value;
            
            if (!description || !date) return;
            
            try {
                const deadlinesCollectionRef = collection(db, "artifacts", appId, "users", userId, "future_deadlines");
                await addDoc(deadlinesCollectionRef, { description, date });
                futureDeadlineFormEl.reset();
            } catch (error) {
                console.error("Errore salvataggio scadenza futura:", error);
            }
        }
        
        async function handleDeleteFutureDeadline(id) {
            showConfirm("Sei sicuro di voler eliminare questa scadenza?", async () => {
                if (!userId) return;
                try {
                    const deadlineDocRef = doc(db, "artifacts", appId, "users", userId, "future_deadlines", id);
                    await deleteDoc(deadlineDocRef);
                } catch (error) {
                    console.error("Errore eliminazione scadenza:", error);
                }
            });
        }
        
        function renderFutureDeadlinesList() {
            futureDeadlinesListEl.innerHTML = ''; // Pulisci
            if (allFutureDeadlines.length === 0) {
                futureDeadlinesListEl.innerHTML = '<p class="text-sm text-gray-500 italic">Nessuna scadenza futura salvata.</p>';
                return;
            }
            
            allFutureDeadlines.forEach(deadline => {
                const li = document.createElement('div');
                li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                li.innerHTML = `
                    <div>
                        <p class="font-medium text-sm">${deadline.description}</p>
                        <p class="text-xs text-gray-600">${new Date(deadline.date + 'T00:00:00').toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    <button data-id="${deadline.id}" class="delete-deadline-btn p-1 rounded-full hover:bg-red-100">
                        <span data-lucide="Trash2" class="w-4 h-4 text-red-500"></span>
                    </button>
                `;
                futureDeadlinesListEl.appendChild(li);
            });
            
            // Aggiungi listener ai pulsanti elimina
            futureDeadlinesListEl.querySelectorAll('.delete-deadline-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteFutureDeadline(e.currentTarget.dataset.id));
            });
            
            lucide.createIcons();
        }

        // --- Funzioni di Rendering UI ---
        
        function renderNotificationBanner() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filtra scadenze da oggi ai prossimi 21 giorni
            const upcomingDeadlines = allFutureDeadlines.filter(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 21;
            });
            
            if (upcomingDeadlines.length === 0) {
                notificationBannerEl.style.display = 'none';
                return;
            }
            
            let message = `<strong>Attenzione:</strong> Hai ${upcomingDeadlines.length} scadenz${upcomingDeadlines.length > 1 ? 'e' : 'a'} in arrivo! `;
            message += upcomingDeadlines.map(d => 
                `"${d.description}" (${new Date(d.date + 'T00:00:00').toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })})`
            ).join(', ');

            notificationBannerEl.innerHTML = `
                <div class="max-w-7xl mx-auto p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800">
                    <div class="flex items-center gap-3">
                        <span data-lucide="AlertTriangle" class="w-5 h-5"></span>
                        <p class="text-sm">${message}</p>
                    </div>
                </div>`;
            notificationBannerEl.style.display = 'block';
            lucide.createIcons();
        }

        // Disegna l'intera griglia settimanale
        async function renderWeekDisplay(startDate) {
            if (!weekScrollContainerEl || !userId) return;
            
            weekScrollContainerEl.innerHTML = ''; // Pulisci la griglia
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);

            const days = getWeekDays(startDate); // Ottiene i 5 giorni (Lun-Ven)
            const commitments = await getCommitments(); // Carica gli impegni
            const todayStr = formatDate(new Date());

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase(); // 'mon', 'tue', ecc.
                
                // Genera HTML Orario
                const timetableHtml = generateTimetableHTML(dayKey);
                
                // Genera HTML Impegni
                const commitmentHtml = commitments[dayKey] 
                    ? `<p class="text-xs text-gray-800 font-medium">${commitments[dayKey]}</p>` 
                    : '<p class="text-xs text-gray-400 italic">Nessun impegno</p>';
                    
                // Genera HTML Radar Scadenze
                const radarHtml = generateRadarHTML(day.date);

                const dayCard = document.createElement('div');
                dayCard.className = `day-column bg-white rounded-xl shadow-sm p-3 flex flex-col ${dateStr === todayStr ? 'border-2 border-blue-500' : ''}`;
                dayCard.id = `day-${dateStr}`;
                
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    
                    <!-- Radar Scadenze -->
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Radar Scadenze</h3>
                    <div class="radar-display mb-2 p-2 bg-red-50 rounded-lg min-h-[30px]">
                        ${radarHtml}
                    </div>
                    
                    <!-- Sezione Orario -->
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">
                        ${timetableHtml}
                    </div>
                    
                    <!-- Sezione Impegni -->
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Impegni</h3>
                    <div class="commitment-display mb-2 p-2 bg-green-50 rounded-lg min-h-[30px]">
                        ${commitmentHtml}
                    </div>

                    <!-- Sezione Compiti -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}" data-daykey="${dayKey}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto">
                        <!-- I compiti per questo giorno verranno inseriti qui -->
                    </div>
                `;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            // Collega gli eventi ai nuovi pulsanti "+"
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    const dayKey = e.currentTarget.dataset.daykey;
                    openModal(taskModalEl, date, dayKey);
                });
            });

            // Popola i compiti
            populateTasksForWeek(days);
            
            // Inizializza le icone Lucide
            lucide.createIcons();
        }

        // Popola le liste dei compiti per la settimana visibile
        function populateTasksForWeek(days) {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const dateStrings = days.map(day => formatDate(day.date));

            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }
        
        // Genera l'HTML dell'orario raggruppando le ore
        function generateTimetableHTML(dayKey) {
            const subjects = timetable[dayKey];
            if (!subjects) return '<p class="text-xs text-gray-400 italic">Errore orario</p>';
            
            let htmlEntries = [];
            let i = 0;
            while (i < subjects.length) {
                let currentSubject = subjects[i];
                let startHour = 8 + i;
                
                let j = i + 1;
                while (j < subjects.length && subjects[j] === currentSubject) {
                    j++;
                }
                
                let endHour = 8 + j;
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${currentSubject}</span></p>`);
                i = j;
            }

            if (htmlEntries.length === 0) {
                return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            }
            return htmlEntries.join('\n');
        }
        
        // Genera HTML per il radar scadenze
        function generateRadarHTML(dayDate) {
            const today = new Date(dayDate);
            today.setHours(0, 0, 0, 0);
            
            const relevantDeadlines = allFutureDeadlines.filter(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 14; // Mostra scadenze entro 14 giorni
            });
            
            if (relevantDeadlines.length === 0) {
                return '<p class="text-xs text-gray-400 italic">Nessuna scadenza imminente</p>';
            }
            
            return relevantDeadlines.map(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let daysText = `(Oggi!)`;
                if (diffDays === 1) daysText = `(Domani!)`;
                if (diffDays > 1) daysText = `(-${diffDays}gg)`;
                
                return `<p class="text-xs text-red-800 font-semibold">${daysText} <span class="font-medium">${d.description}</span></p>`;
            }).join('\n');
        }


        // Disegna un singolo compito nella colonna corretta
        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return;

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500 flex-shrink-0';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            // Contenuto (Materia + Descrizione)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer min-w-0'; // min-w-0 per troncare testo
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm truncate ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs truncate ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            // Pulsanti Azione (AI + Elimina)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-shrink-0 ml-auto';
            
            // Pulsante Assistente AI
            const aiButton = document.createElement('button');
            aiButton.className = 'p-1 rounded-full hover:bg-blue-100';
            aiButton.innerHTML = `<span data-lucide="Sparkles" class="w-4 h-4 text-blue-500"></span>`;
            aiButton.addEventListener('click', () => handleOpenAiAssistant(id));
            
            // Pulsante Elimina
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.innerHTML = `<span data-lucide="Trash2" class="w-4 h-4 text-red-500"></span>`;
            deleteButton.addEventListener('click', () => handleDeleteTask(id));

            actionsDiv.appendChild(aiButton);
            actionsDiv.appendChild(deleteButton);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(actionsDiv);

            taskListContainer.appendChild(taskEl);
            lucide.createIcons({ nodes: [taskEl] });
        }
        
        
        // --- Funzioni Gestione Compiti (Tasks) ---

        // Salva (o aggiorna) un compito
        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;

            const id = taskIdEl.value;
            const taskData = {
                subject: taskFormEl.subject.value,
                description: taskFormEl.description.value,
                dueDate: taskFormEl.dueDate.value,
                completed: allTasks[id]?.completed || false,
                aiChatHistory: allTasks[id]?.aiChatHistory || [] // Preserva la chat
            };
            
            try {
                if (id) {
                    // Aggiorna
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    // Crea
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal(taskModalEl);
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
            }
        }

        // Apre il modal per modificare un compito
        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;
            
            const dayKey = getDayKeyFromDate(task.dueDate);
            populateSubjectDropdown(dayKey, task.subject); // Popola con le materie del giorno

            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;
            openModal(taskModalEl);
        }
        
        // Popola il dropdown delle materie
        function populateSubjectDropdown(dayKey, currentSubject = null) {
            const subjectSelect = taskFormEl.subject;
            subjectSelect.innerHTML = ''; // Pulisci
            
            const subjects = getSubjectsForDay(dayKey);
            
            // Aggiungi un'opzione vuota
            subjectSelect.add(new Option("Scegli una materia...", ""));
            
            subjects.forEach(subject => {
                subjectSelect.add(new Option(subject, subject));
            });
            
            // Se la materia attuale non è più nell'orario, aggiungila
            if (currentSubject && !subjects.includes(currentSubject)) {
                subjectSelect.add(new Option(`${currentSubject} (vecchia)`, currentSubject));
            }
        }

        // Aggiorna lo stato "completato" di un compito
        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
            }
        }

        // Mostra il popup di conferma prima di eliminare
        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        // Esegue l'eliminazione effettiva
        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
            }
        }

        
        // --- Funzioni Assistente AI (Chat) ---
        
        async function handleOpenAiAssistant(id) {
            const task = allTasks[id];
            if (!task) return;
            
            currentAiTaskId = id;
            currentAiChatHistory = task.aiChatHistory || [];
            
            aiChatHistoryEl.innerHTML = ''; // Pulisci la finestra
            openModal(aiAssistantModalEl);
            
            if (currentAiChatHistory.length > 0) {
                // Carica la cronologia esistente
                currentAiChatHistory.forEach(msg => renderAiChatMessage(msg.role, msg.parts[0].text));
            } else {
                // È una nuova chat, avvia con i suggerimenti
                renderAiChatMessage("model", "...", true); // Messaggio di caricamento
                const prompt = `Agisci come un tutor scolastico amichevole e incoraggiante. Ho questo compito:
                - Materia: ${task.subject}
                - Descrizione: ${task.description}
                Basandoti su informazioni aggiornate (usa la ricerca Google), dammi una brevissima spiegazione (massimo 2 frasi) dell'argomento principale e 3 consigli pratici e concisi per svolgerlo al meglio. Formatta la risposta in HTML semplice (paragrafi e liste).`;
                
                const initialMessage = { role: "user", parts: [{ text: prompt }] };
                currentAiChatHistory.push(initialMessage);
                
                // Chiama l'API
                callGeminiChatApi(true); // true = è una chiamata con ricerca
            }
        }
        
        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const userPrompt = aiChatInputEl.value.trim();
            if (!userPrompt || !currentAiTaskId) return;
            
            aiChatInputEl.value = '';
            renderAiChatMessage("user", userPrompt);
            
            const userMessage = { role: "user", parts: [{ text: userPrompt }] };
            currentAiChatHistory.push(userMessage);
            
            renderAiChatMessage("model", "...", true); // Messaggio di caricamento
            
            // Chiama l'API
            callGeminiChatApi(true); // true = usa ricerca
        }
        
        async function callGeminiChatApi(useSearch) {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: currentAiChatHistory, // Invia l'intera cronologia
                tools: useSearch ? [{ "google_search": {} }] : [],
                systemInstruction: {
                    parts: [{ text: "Agisci come un tutor scolastico amichevole, conciso e incoraggiante per uno studente di scuola media. Usa un linguaggio semplice e chiaro. Basa le tue risposte su informazioni verificate (usando la ricerca). Formatta sempre le risposte in HTML semplice (paragrafi <p>, liste <ul><li>, grassetto <strong>)." }]
                }
            };

            try {
                aiChatSendButtonEl.disabled = true;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Errore API: ${response.statusText}`);
                }

                const result = await response.json();
                const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (modelResponse) {
                    const modelMessage = { role: "model", parts: [{ text: modelResponse }] };
                    currentAiChatHistory.push(modelMessage);
                    
                    // Rimuovi "..." e renderizza la risposta
                    removeAiChatLoading();
                    renderAiChatMessage("model", modelResponse);
                    
                    // Salva la cronologia su Firebase
                    await saveAiChatHistory();
                } else {
                    throw new Error("Risposta AI non valida.");
                }

            } catch (error) {
                console.error("Errore chiamata Gemini:", error);
                removeAiChatLoading();
                renderAiChatMessage("model", "Ops, c'è stato un errore. Riprova.");
            } finally {
                aiChatSendButtonEl.disabled = false;
            }
        }
        
        async function saveAiChatHistory() {
            if (!userId || !currentAiTaskId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", currentAiTaskId);
                await updateDoc(taskDocRef, { aiChatHistory: currentAiChatHistory });
                console.log("Cronologia chat salvata per", currentAiTaskId);
            } catch (error) {
                console.error("Errore salvataggio cronologia chat:", error);
            }
        }

        function renderAiChatMessage(role, text, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`;
            
            if (isLoading) {
                bubble.id = 'ai-loading-bubble';
                bubble.innerHTML = `<div class="loading-bubble"><div class="loading-dot bg-gray-500" style="animation-delay: 0s;"></div><div class="loading-dot bg-gray-500" style="animation-delay: 0.2s;"></div><div class="loading-dot bg-gray-500" style="animation-delay: 0.4s;"></div></div>`;
            } else {
                const safeHtml = text.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "");
                bubble.innerHTML = safeHtml;
            }
            
            aiChatHistoryEl.appendChild(bubble);
            aiChatHistoryEl.scrollTop = aiChatHistoryEl.scrollHeight; // Scrolla in fondo
        }

        function removeAiChatLoading() {
            const loadingBubble = document.getElementById('ai-loading-bubble');
            if (loadingBubble) {
                loadingBubble.remove();
            }
        }
        

        // --- Funzioni AI Planner (NUOVA CHAT) ---
        
        async function handleOpenAiPlanner() {
            openModal(aiPlannerModalEl);
            aiPlannerChatHistoryEl.innerHTML = ''; // Pulisci chat
            currentAiPlannerChatHistory = []; // Resetta cronologia
            
            renderAiPlannerChatMessage("model", "...", true); // Messaggio di caricamento
            
            // 1. Definisci la finestra temporale
            const today = new Date();
            const startOfWeek = getStartOfWeek(currentWeekStart);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 4);
            const endOfDeadlineWindow = new Date(endOfWeek);
            endOfDeadlineWindow.setDate(endOfWeek.getDate() + 3);

            // 2. Raccogli i Compiti
            const relevantTasks = Object.values(allTasks).filter(task => {
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                return !task.completed && dueDate >= today && dueDate <= endOfDeadlineWindow;
            });
            
            // 3. Raccogli Impegni e Scadenze
            const commitments = await getCommitments();
            const futureDeadlines = allFutureDeadlines;

            // 4. Costruisci il Prompt Iniziale
            const todayStr = today.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });

            let initialPrompt = `Agisci come un "Tutor di Pianificazione" esperto per uno studente di scuola media.
            Oggi è ${todayStr}.
            
            REGOLA FONDAMENTALE: Un compito con "Scadenza: Martedì" significa che va consegnato Martedì mattina. Il lavoro deve essere completato entro Lunedì sera. Non pianificare MAI un compito nel giorno stesso della sua scadenza.
            
            Ecco i dati:
            1. ORARIO SCOLASTICO (L-V, 8:00-14:00): ${JSON.stringify(timetable)}
            2. IMPEGNI FISSI (Sport, ecc. - Questi orari sono BLOCCATI): ${JSON.stringify(commitments)}
            3. SCADENZE FUTURE (Verifiche, Interrogazioni - Inizia a pianificare il ripasso se sono tra 7-14 giorni): ${futureDeadlines.map(d => `- ${d.description} (Scadenza: ${d.date})`).join('\n')}
            4. COMPITI DA FARE (Non completati): ${relevantTasks.map(t => `- Materia: ${t.subject}, Descrizione: ${t.description} (Scadenza: ${t.dueDate})`).join('\n')}
            
            OBIETTIVO:
            Crea un piano di studio realistico, pomeriggio per pomeriggio, da oggi fino a Venerdì (${endOfWeek.toLocaleDateString('it-IT')}).
            - Dai priorità ai compiti con scadenza più vicina (rispettando la REGOLA FONDAMENTALE).
            - Tieni conto degli orari bloccati dagli impegni.
            - Inserisci piccole sessioni di ripasso per le scadenze future, se opportuno.
            - Suggerisci un ordine sensato e pause.
            - Sii conciso e incoraggiante.
            - Formatta la risposta in HTML semplice (intestazioni <h3> per i giorni, liste <ul><li> per i compiti).
            - Concludi chiedendomi se voglio apportare modifiche.
            `;
            
            const initialMessage = { role: "user", parts: [{ text: initialPrompt }] };
            currentAiPlannerChatHistory.push(initialMessage);
            
            // Chiama l'API del planner
            callGeminiPlannerChatApi();
        }
        
        async function handleAiPlannerChatSubmit(e) {
            e.preventDefault();
            const userPrompt = aiPlannerChatInputEl.value.trim();
            if (!userPrompt) return;
            
            aiPlannerChatInputEl.value = '';
            renderAiPlannerChatMessage("user", userPrompt);
            
            const userMessage = { role: "user", parts: [{ text: userPrompt }] };
            currentAiPlannerChatHistory.push(userMessage);
            
            renderAiPlannerChatMessage("model", "...", true); // Messaggio di caricamento
            
            // Chiama l'API
            callGeminiPlannerChatApi();
        }

        async function callGeminiPlannerChatApi() {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: currentAiPlannerChatHistory, // Invia l'intera cronologia
                // Nota: NESSUNO strumento di ricerca, è solo logica
                systemInstruction: {
                    parts: [{ text: `Sei un "Tutor di Pianificazione" esperto per uno studente di scuola media.
                    Il tuo obiettivo è creare e modificare un piano di studio settimanale.
                    REGOLA FONDAMENTALE: Un compito con "Scadenza: Martedì" va finito entro Lunedì sera. Non pianificare MAI un compito nel giorno stesso della sua scadenza.
                    Sii amichevole, conciso e usa sempre HTML semplice (<h3>, <ul>, <li>, <strong>) per formattare i piani di studio.` }]
                }
            };

            try {
                aiPlannerChatSendButtonEl.disabled = true;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Errore API: ${response.statusText}`);
                }

                const result = await response.json();
                const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (modelResponse) {
                    const modelMessage = { role: "model", parts: [{ text: modelResponse }] };
                    currentAiPlannerChatHistory.push(modelMessage);
                    
                    removeAiPlannerChatLoading();
                    renderAiPlannerChatMessage("model", modelResponse);
                } else {
                    throw new Error("Risposta AI non valida.");
                }

            } catch (error) {
                console.error("Errore chiamata Gemini Planner:", error);
                removeAiPlannerChatLoading();
                renderAiPlannerChatMessage("model", "Ops, c'è stato un errore. Riprova.");
            } finally {
                aiPlannerChatSendButtonEl.disabled = false;
            }
        }

        function renderAiPlannerChatMessage(role, text, isLoading = false) {
            const bubble = document.createElement('div');
            // Aggiungiamo la classe 'planner' per il colore custom
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model planner'}`;
            
            if (isLoading) {
                bubble.id = 'ai-planner-loading-bubble';
                bubble.innerHTML = `<div class="loading-bubble"><div class="loading-dot bg-purple-400" style="animation-delay: 0s;"></div><div class="loading-dot bg-purple-400" style="animation-delay: 0.2s;"></div><div class="loading-dot bg-purple-400" style="animation-delay: 0.4s;"></div></div>`;
            } else {
                const safeHtml = text.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "");
                bubble.innerHTML = safeHtml;
            }
            
            aiPlannerChatHistoryEl.appendChild(bubble);
            aiPlannerChatHistoryEl.scrollTop = aiPlannerChatHistoryEl.scrollHeight;
        }

        function removeAiPlannerChatLoading() {
            const loadingBubble = document.getElementById('ai-planner-loading-bubble');
            if (loadingBubble) {
                loadingBubble.remove();
            }
        }


        // --- Funzioni Modal (Finestre Popup) ---
        
        function openModal(modalEl, defaultDate = null, dayKey = null) {
            // Caso specifico per il modal compiti
            if (modalEl === taskModalEl) {
                taskFormEl.reset();
                modalTitleEl.innerText = "Nuovo Compito";
                taskIdEl.value = '';
                
                if (defaultDate) {
                    taskFormEl.dueDate.value = defaultDate;
                }
                if (dayKey) {
                    populateSubjectDropdown(dayKey); // Popola le materie per il giorno
                }
            }
            
            modalEl.style.display = 'flex';
            // Inizializza le icone nel modal appena aperto
            lucide.createIcons({ nodes: [modalEl] });
        }

        function closeModal(modalEl) {
            modalEl.style.display = 'none';
            // Pulisci lo stato della chat AI quando si chiude
            if (modalEl === aiAssistantModalEl) {
                currentAiTaskId = null;
                currentAiChatHistory = [];
            }
            // Pulisci lo stato della chat Planner quando si chiude
            if (modalEl === aiPlannerModalEl) {
                currentAiPlannerChatHistory = [];
            }
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            openModal(confirmModalEl);
        }
        
        function closeConfirm() {
            closeModal(confirmModalEl);
            confirmCallback = null;
        }


        // --- Funzioni Utilità (Date, Errori) ---

        // Trova il Lunedì della settimana corrente
        function getStartOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); // Azzera l'ora
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Ritorna un array di 5 oggetti {name, date, value} da Lunedì a Venerdì
        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNamesList = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            for (let i = 0; i < 5; i++) {
                days.push({
                    name: dayNamesList[i],
                    date: new Date(d),
                    value: dayValues[i]
                });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        // Formatta una data come "YYYY-MM-DD" (METODO SICURO)
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDayKeyFromDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00'); // Usa T00:00:00 per evitare problemi di fuso
            const dayIndex = date.getDay(); // 0=Dom, 1=Lun, ...
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            return dayKeys[dayIndex];
        }

        // Formatta l'intestazione della settimana (es. "10 Nov - 14 Nov")
        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4); // Venerdì
            
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            
            return `${startStr} - ${endStr}`;
        }
        
        function showError(message) {
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message);
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart);
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentWeekStart = getStartOfWeek(new Date());
                renderWeekDisplay(currentWeekStart);
            });

            // Gestione Menu Dropdown
            menuToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                menuDropdown.classList.toggle('hidden');
            });
            // Chiudi menu cliccando fuori
            document.addEventListener('click', (e) => {
                if (!menuContainer.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });
            // Chiudi menu cliccando un'opzione
            menuDropdown.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', () => menuDropdown.classList.add('hidden'));
            });

            // Listener pulsanti del menu
            document.getElementById('openAiPlannerButton').addEventListener('click', handleOpenAiPlanner);
            document.getElementById('openCommitmentsButton').addEventListener('click', () => openModal(commitmentsModalEl));
            document.getElementById('openFutureDeadlinesButton').addEventListener('click', () => openModal(futureDeadlinesModalEl));
            document.getElementById('openTimetableButton').addEventListener('click', () => openModal(timetableModalEl));

            // Modal Compiti
            taskFormEl.addEventListener('submit', handleSaveTask);

            // Modal Impegni
            commitmentsFormEl.addEventListener('submit', handleSaveCommitments);
            
            // Modal Scadenze Future
            futureDeadlineFormEl.addEventListener('submit', handleSaveFutureDeadline);
            
            // Modal Chat AI
            aiChatFormEl.addEventListener('submit', handleAiChatSubmit);
            
            // Modal Chat Planner (NUOVO)
            aiPlannerChatFormEl.addEventListener('submit', handleAiPlannerChatSubmit);
            
            // Modal Conferma
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeConfirm();
            });
            
            // Chiusura generica Modal
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalToClose = e.target.closest('.modal');
                    if (modalToClose) closeModal(modalToClose);
                });
            });

            // Avvia l'app
            initializeFirebase();
        });

    </script>
</body>
</html>
