<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Stili per l'aspetto mobile-first */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none; /* Previene il "pull-to-refresh" laterale */
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory; /* Aggancia le colonne durante lo scorrimento */
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 90%; /* Su mobile, ogni colonna occupa il 90% */
            scroll-snap-align: start; /* Aggancia l'inizio della colonna */
            margin-right: 10px;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi più grandi, si dividono lo spazio */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Stili per il modal di conferma (più piccolo) */
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        /* Stile per il contenuto del modal AI (per formattare la risposta) */
        #aiModalContent p {
            margin-bottom: 0.75rem; /* 12px */
            line-height: 1.6;
        }
        #aiModalContent ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-bottom: 0.75rem;
        }
        #aiModalContent li {
            margin-bottom: 0.25rem; /* 4px */
        }
        #aiModalContent strong {
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                <!-- Titolo e Navigazione Settimana -->
                <div class="flex items-center justify-between w-full sm:w-auto">
                    <h1 class="text-xl font-bold text-gray-800">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>
                <!-- Pulsanti Azione -->
                <div class="flex gap-2 mt-4 sm:mt-0">
                    <button id="todayBtn" class="px-4 py-2 text-base font-medium text-blue-600 bg-blue-100 rounded-lg shadow-sm hover:bg-blue-200 transition">
                        Oggi
                    </button>
                    <button id="openTimetableButton" class="px-4 py-2 text-base font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition">
                        Orario
                    </button>
                </div>
            </div>
        </header>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="flex-1 overflow-hidden p-3 sm:p-4">
            <!-- Contenitore con scorrimento orizzontale -->
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full gap-3">
                <!-- Le colonne dei giorni (Lunedì-Venerdì) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <!-- MODIFICA: Da input a select -->
                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">-- Seleziona Giorno --</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Visualizzare l'Orario -->
    <div id="viewTimetableModal" class="modal">
        <div class="modal-content max-w-3xl"> <!-- Reso più largo per l'orario -->
            <h2 class="text-lg font-semibold mb-4">Orario Settimanale</h2>
            
            <!-- Aggiunto overflow-x-auto per lo swipe/scorrimento orizzontale -->
            <div id="viewTimetableModalContent" class="max-h-[70vh] overflow-x-auto overflow-y-auto">
                <!-- Il contenuto dell'orario (la tabella) verrà generato qui da JS -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" id="closeViewTimetableModalButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione (Personalizzato) -->
    <div id="confirmModal" class="modal" style="z-index: 60;"> <!-- z-index più alto -->
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>
    
    <!-- 6. Modal Assistente AI (NUOVO) -->
    <div id="aiModal" class="modal" style="z-index: 60;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-blue-600">Assistente AI</h2>
                <button id="closeAiModalButton" class="p-2 rounded-full hover:bg-gray-100">
                    <span data-lucide="X" class="w-5 h-5 text-gray-600"></span>
                </button>
            </div>
            
            <!-- Contenuto generato dall'AI -->
            <div id="aiModalContent" class="max-h-[60vh] overflow-y-auto text-gray-700 text-sm">
                <!-- Il caricamento o il contenuto AI appariranno qui -->
            </div>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        // Variabili globali per lo stato dell'app
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {}; // Cache locale dei compiti
        let taskUnsubscribe = null; // Funzione per staccare il listener di Firestore
        let isAiCallPending = false; // Evita chiamate multiple all'AI

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        
        // Modal Compiti
        const modalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        // Modal Orario (Visualizzazione)
        const viewTimetableModalEl = document.getElementById('viewTimetableModal');
        const viewTimetableModalContentEl = document.getElementById('viewTimetableModalContent');
        
        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null; // Funzione da eseguire alla conferma
        
        // Modal AI (NUOVO)
        const aiModalEl = document.getElementById('aiModal');
        const aiModalContentEl = document.getElementById('aiModalContent');
        const closeAiModalButtonEl = document.getElementById('closeAiModalButton');

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- LOGICA ORARIO FISSO ---
        const dayNames = { mon: 'Lunedì', tue: 'Martedì', wed: 'Mercoledì', thu: 'Giovedì', fri: 'Venerdì' };
        
        const TIMETABLE_HOURS_MAP = {
            mon: [8, 9, 10, 11, 12], // 5 ore
            tue: [8, 9, 10, 11, 12, 13], // 6 ore
            wed: [8, 9, 10, 11, 12], // 5 ore
            thu: [8, 9, 10, 11, 12, 13], // 6 ore
            fri: [8, 9, 10, 11, 12]  // 5 ore
        };

        const FIXED_TIMETABLE = {
            mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"],
            tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"],
            wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"],
            thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"],
            fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"]
        };
        // --- Fine Logica Orario Fisso ---

        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                // Inizializza Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Attiva i log di Firestore

                // Gestisce l'autenticazione
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova più tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        async function loadUserData() {
            if (!userId) return;
            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';
            renderWeekDisplay(currentWeekStart);
            await attachTaskListener();
        }

        // --- Funzioni Orario (Logica di Visualizzazione) ---
        
        function openTimetableModal() {
            const hours = [8, 9, 10, 11, 12, 13]; // Ore massime (fino alle 14:00)
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ora</th>
            `;
            days.forEach(dayKey => {
                tableHtml += `<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${dayNames[dayKey]}</th>`;
            });
            tableHtml += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            hours.forEach((hour, hourIndex) => {
                tableHtml += `<tr class="even:bg-gray-50">`;
                tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${hour}:00 - ${hour+1}:00</td>`;
                
                days.forEach(dayKey => {
                    const subject = FIXED_TIMETABLE[dayKey][hourIndex];
                    if (subject) {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${subject}</td>`;
                    } else {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">-</td>`;
                    }
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table>`;
            
            viewTimetableModalContentEl.innerHTML = tableHtml;
            viewTimetableModalEl.style.display = 'flex';
        }
        
        function closeTimetableModal() {
            viewTimetableModalEl.style.display = 'none';
        }

        function generateTimetableHTML(dayKey) {
            const hours = TIMETABLE_HOURS_MAP[dayKey];
            const subjects = FIXED_TIMETABLE[dayKey];
            if (!hours || !subjects) return '<p class="text-xs text-gray-400 italic">Orario non definito</p>';
            
            let htmlEntries = [];
            let i = 0;
            while (i < subjects.length) {
                let subject = subjects[i];
                let startHour = hours[i];
                let j = i + 1;
                while (j < subjects.length && subjects[j] === subject) {
                    j++;
                }
                let endHour = hours[j - 1] + 1; 
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${subject}</span></p>`);
                i = j;
            }
            if (htmlEntries.length === 0) return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            return htmlEntries.join('\n');
        }


        // --- Funzioni Gestione Compiti (Tasks) ---

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {};
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = doc.data();
                });
                renderWeekDisplay(currentWeekStart); 
            }, (error) => {
                console.error("Errore nel listener dei compiti:", error);
                showError("Impossibile caricare i compiti.");
            });
        }

        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;
            const id = taskIdEl.value;
            const taskData = {
                subject: taskFormEl.subject.value,
                description: taskFormEl.description.value,
                dueDate: taskFormEl.dueDate.value,
                completed: taskFormEl.querySelector(`#task-${id}`)?.dataset.completed === 'true' || false
            };
            
            try {
                if (id) {
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal();
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
                showError("Impossibile salvare il compito.");
            }
        }

        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;

            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            
            populateSubjectDropdown(task.dueDate);
            
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;

            const subjectSelectEl = document.getElementById('subject');
            if (task.subject && !subjectSelectEl.querySelector(`option[value="${task.subject}"]`)) {
                const oldOption = document.createElement('option');
                oldOption.value = task.subject;
                oldOption.textContent = `${task.subject} (vecchia)`;
                subjectSelectEl.appendChild(oldOption);
                taskFormEl.subject.value = task.subject;
            }
            modalEl.style.display = 'flex';
        }

        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
                showError("Impossibile aggiornare il compito.");
            }
        }

        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
                showError("Impossibile eliminare il compito.");
            }
        }


        // --- Funzioni di Rendering UI ---

        function renderWeekDisplay(startDate) {
            if (!weekScrollContainerEl) return;
            weekScrollContainerEl.innerHTML = '';
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);
            const days = getWeekDays(startDate);

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase().substring(0, 3);
                const timetableHtml = generateTimetableHTML(dayKey);
                const dayCard = document.createElement('div');
                dayCard.className = 'day-column bg-white rounded-xl shadow-sm p-3 flex flex-col';
                dayCard.id = `day-${dateStr}`;
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">${timetableHtml}</div>
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto"></div>`;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    openModal(date);
                });
            });

            populateTasksForWeek(days);
            lucide.createIcons();
        }

        function populateTasksForWeek(days) {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const dateStrings = days.map(day => formatDate(day.date));
            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }

        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return;

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            // Contenuto (Materia + Descrizione)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer';
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            // --- Pulsanti Azione (AI e Elimina) ---
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-col sm:flex-row gap-1 ml-auto';

            // Pulsante Assistente AI (NUOVO)
            const aiButton = document.createElement('button');
            aiButton.className = 'p-1 rounded-full hover:bg-blue-100';
            aiButton.title = 'Assistente AI'; // Tooltip
            aiButton.innerHTML = `<span data-lucide="Sparkles" class="text-blue-500 hover:text-blue-700" width="16" height="16"></span>`;
            aiButton.addEventListener('click', () => openAiModal(data.subject, data.description));
            
            // Pulsante Elimina
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.title = 'Elimina'; // Tooltip
            deleteButton.innerHTML = `<span data-lucide="Trash2" class="text-red-500 hover:text-red-700" width="16" height="16"></span>`;
            deleteButton.addEventListener('click', () => handleDeleteTask(id));

            actionsDiv.appendChild(aiButton);
            actionsDiv.appendChild(deleteButton);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(actionsDiv);

            taskListContainer.appendChild(taskEl);
            lucide.createIcons({ nodes: [taskEl] });
        }


        // --- Funzione per popolare il dropdown materie (da orario fisso) ---
        function populateSubjectDropdown(dateStr) {
            const subjectSelectEl = document.getElementById('subject');
            subjectSelectEl.innerHTML = '<option value="">-- Seleziona Materia --</option>';
            if (!dateStr) return;

            try {
                const dateObj = new Date(dateStr + 'T12:00:00');
                const dayOfWeek = dateObj.getDay(); 
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                if (!dayKey || dayKey === 'sun' || dayKey === 'sat') return;

                const daySubjects = FIXED_TIMETABLE[dayKey] || [];
                const uniqueSubjects = [...new Set(daySubjects)];
                uniqueSubjects.sort();

                uniqueSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelectEl.appendChild(option);
                });
            } catch (e) {
                console.error("Errore nel popolare le materie:", e);
                subjectSelectEl.innerHTML = '<option value="">Errore nel caricare le materie</option>';
            }
        }


        // --- Funzioni Modal (Finestre Popup) ---

        function openModal(defaultDate = null) {
            taskFormEl.reset();
            modalTitleEl.innerText = "Nuovo Compito";
            taskIdEl.value = '';
            taskFormEl.dueDate.value = defaultDate ? defaultDate : formatDate(new Date());
            populateSubjectDropdown(defaultDate);
            modalEl.style.display = 'flex';
        }

        function closeModal() {
            modalEl.style.display = 'none';
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            confirmModalEl.style.display = 'flex';
        }
        
        function closeConfirm() {
            confirmModalEl.style.display = 'none';
            confirmCallback = null;
        }

        // --- Funzioni Assistente AI (NUOVE) ---

        function openAiModal(subject, description) {
            if (isAiCallPending) return; // Evita clic multipli
            
            aiModalEl.style.display = 'flex';
            aiModalContentEl.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <span data-lucide="Loader" class="w-6 h-6 text-blue-500 animate-spin"></span>
                    <p class="ml-3 text-gray-600">L'assistente sta cercando informazioni...</p>
                </div>
            `;
            lucide.createIcons({ nodes: [aiModalContentEl] });

            callGeminiApi(subject, description);
        }

        function closeAiModal() {
            aiModalEl.style.display = 'none';
            aiModalContentEl.innerHTML = ''; // Pulisci contenuto
        }

        async function callGeminiApi(subject, description) {
            isAiCallPending = true;

            const systemPrompt = `Sei un assistente tutor (per una studentessa di scuola media o superiore in Italia).
Rispondi sempre in italiano.
Il tuo compito è analizzare il compito assegnato e fornire supporto.
Formatta la risposta in HTML semplice (paragrafi <p>, liste <ul><li> e grassetto <strong>).

La tua risposta deve essere strutturata in 2 parti:
1.  **Breve Spiegazione:** Una spiegazione concisa (massimo 2-3 frasi) dell'argomento principale.
2.  **Consigli Pratici:** Una lista puntata (massimo 3-4 punti) con consigli pratici e specifici per *come* svolgere quel compito.`;
            
            const userQuery = `Il mio compito è:
- Materia: ${subject}
- Descrizione: ${description}

Forniscimi la spiegazione e i consigli pratici, basandoti su informazioni aggiornate (usa la ricerca se necessario).`;
            
            const apiKey = ""; // Lasciato vuoto come da istruzioni
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Attiva Google Search
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Errore API: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let text = result.candidates[0].content.parts[0].text;
                    
                    // Sostituzioni di base per rendere l'HTML più pulito (Gemini a volte usa Markdown)
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Grassetto
                    text = text.replace(/ \*(.*?)/g, '<li>$1</li>'); // Voci elenco
                    
                    aiModalContentEl.innerHTML = text;
                } else {
                    aiModalContentEl.innerHTML = '<p class="text-red-500">Non ho trovato una risposta valida. Riprova.</p>';
                }

            } catch (error) {
                console.error("Errore chiamata AI:", error);
                aiModalContentEl.innerHTML = `<p class="text-red-500">C'è stato un errore nel contattare l'assistente: ${error.message}</p>`;
            } finally {
                isAiCallPending = false;
            }
        }


        // --- Funzioni Utilità (Date, Errori) ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            for (let i = 0; i < 5; i++) {
                days.push({ name: dayNames[i], date: new Date(d), value: dayValues[i] });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            return `${startStr} - ${endStr}`;
        }
        
        function showError(message) {
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message);
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart);
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentWeekStart = getStartOfWeek(new Date());
                renderWeekDisplay(currentWeekStart);
                lucide.createIcons();
            });

            // Modal Compiti
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            taskFormEl.addEventListener('submit', handleSaveTask);

            // Modal Orario (Visualizzazione)
            document.getElementById('openTimetableButton').addEventListener('click', openTimetableModal);
            document.getElementById('closeViewTimetableModalButton').addEventListener('click', closeTimetableModal);
            
            // Modal Conferma
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirm();
            });
            
            // Modal AI (NUOVO)
            closeAiModalButtonEl.addEventListener('click', closeAiModal);

            // Avvia l'app
            initializeFirebase();
        });

    </script>
</body>
</html>
