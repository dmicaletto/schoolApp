<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Stili per l'aspetto mobile-first */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none; /* Previene il "pull-to-refresh" laterale */
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory; /* Aggancia le colonne during lo scorrimento */
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 90%; /* Su mobile, ogni colonna occupa il 90% */
            scroll-snap-align: start; /* Aggancia l'inizio della colonna */
            margin-right: 10px;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi più grandi, si dividono lo spazio */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Stili per il modal di conferma (più piccolo) */
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        /* Stile per il contenuto dei modal AI (per formattare la risposta) */
        .ai-modal-content p {
            margin-bottom: 0.75rem; /* 12px */
            line-height: 1.6;
        }
        .ai-modal-content ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-bottom: 0.75rem;
        }
        .ai-modal-content li {
            margin-bottom: 0.25rem; /* 4px */
        }
        .ai-modal-content strong, .ai-modal-content h3 {
            font-weight: 600;
            color: #1F2937; /* gray-800 */
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* --- Stili Chat AI --- */
        .ai-chat-messages {
            height: 300px; /* Altezza fissa per la chat */
            overflow-y: auto;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            padding: 12px;
            background-color: #f9fafb; /* gray-50 */
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            margin-bottom: 8px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.model {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble.model.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
        }
        .ai-chat-input-form {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .ai-chat-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .ai-chat-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .ai-chat-input:disabled {
            background-color: #f3f4f6; /* gray-100 */
        }
        .ai-chat-submit {
            padding: 8px 12px;
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .ai-chat-submit:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .ai-chat-submit:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        /* --- Fine Stili Chat AI --- */
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                <!-- Titolo e Navigazione Settimana -->
                <div class="flex items-center justify-between w-full sm:w-auto">
                    <h1 class="text-xl font-bold text-gray-800">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>
                
                <!-- Pulsanti Azione (Con Menu Dropdown) -->
                <div class="flex items-center gap-2 mt-4 sm:mt-0">
                    <button id="todayBtn" class="px-4 py-2 text-base font-medium text-blue-600 bg-blue-100 rounded-lg shadow-sm hover:bg-blue-200 transition">
                        Oggi
                    </button>
                    
                    <!-- Nuovo Menu Dropdown -->
                    <div class="relative">
                        <button id="menuButton" class="p-2 rounded-lg hover:bg-gray-100 shadow-sm border border-gray-200">
                            <span data-lucide="Menu" class="w-5 h-5 text-gray-700"></span>
                        </button>
                        <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50 border border-gray-100">
                            <a href="#" id="menuAiPlanner" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="Wand2" class="w-4 h-4 text-purple-500"></span>
                                AI Planner
                            </a>
                            <a href="#" id="menuCommitments" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="CalendarCheck" class="w-4 h-4 text-green-500"></span>
                                Impegni
                            </a>
                            <a href="#" id="menuTimetable" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="Clock" class="w-4 h-4 text-gray-500"></span>
                                Orario
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="flex-1 overflow-hidden p-3 sm:p-4">
            <!-- Contenitore con scorrimento orizzontale -->
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full gap-3">
                <!-- Le colonne dei giorni (Lunedì-Venerdì) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">-- Seleziona Giorno --</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Visualizzare l'Orario -->
    <div id="viewTimetableModal" class="modal">
        <div class="modal-content max-w-3xl">
            <h2 class="text-lg font-semibold mb-4">Orario Settimanale</h2>
            
            <div id="viewTimetableModalContent" class="max-h-[70vh] overflow-x-auto overflow-y-auto">
                <!-- Tabella orario generata da JS -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" id="closeViewTimetableModalButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione (Personalizzato) -->
    <div id="confirmModal" class="modal" style="z-index: 60;">
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>
    
    <!-- 6. Modal Assistente AI (ORA CHAT) -->
    <div id="aiModal" class="modal" style="z-index: 60;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-blue-600">Assistente AI</h2>
                <button id="closeAiModalButton" class="p-2 rounded-full hover:bg-gray-100">
                    <span data-lucide="X" class="w-5 h-5 text-gray-600"></span>
                </button>
            </div>
            
            <!-- Contenitore dei messaggi della chat -->
            <div id="aiChatMessages" class="ai-chat-messages">
                <!-- I messaggi della chat verranno inseriti qui -->
            </div>
            
            <!-- Form per l'input della chat -->
            <form id="aiChatForm" class="ai-chat-input-form">
                <input type="text" id="aiChatInput" class="ai-chat-input" placeholder="Fai una domanda..." autocomplete="off">
                <button type="submit" id="aiChatSubmit" class="ai-chat-submit">
                    <span data-lucide="Send" class="w-5 h-5"></span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- 7. Modal AI Planner -->
    <div id="aiPlannerModal" class="modal" style="z-index: 60;">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-purple-600">Piano di Studio AI</h2>
                <button id="closeAiPlannerModalButton" class="p-2 rounded-full hover:bg-gray-100">
                    <span data-lucide="X" class="w-5 h-5 text-gray-600"></span>
                </button>
            </div>
            
            <div id="aiPlannerModalContent" class="ai-modal-content max-h-[60vh] overflow-y-auto text-gray-700 text-sm">
                <!-- Contenuto generato dall'AI Planner -->
            </div>
        </div>
    </div>
    
    <!-- 8. Modal per Impegni Settimanali -->
    <div id="commitmentsModal" class="modal">
        <div class="modal-content max-w-lg">
            <h2 class="text-lg font-semibold mb-4">Impegni Settimanali Fissi</h2>
            <form id="commitmentsForm">
                <p class="text-sm text-gray-600 mb-4">Inserisci qui gli impegni pomeridiani fissi (es. sport, musica) per aiutare l'AI a pianificare meglio.</p>
                <div class="space-y-3">
                    <div>
                        <label for="commit-mon" class="block text-sm font-medium text-gray-700">Lunedì</label>
                        <input type="text" id="commit-mon" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Es. 17:00 - 18:00: Pianoforte">
                    </div>
                    <div>
                        <label for="commit-tue" class="block text-sm font-medium text-gray-700">Martedì</label>
                        <input type="text" id="commit-tue" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Es. 17:00 - 19:00: Pallavolo">
                    </div>
                    <div>
                        <label for="commit-wed" class="block text-sm font-medium text-gray-700">Mercoledì</label>
                        <input type="text" id="commit-wed" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="commit-thu" class="block text-sm font-medium text-gray-700">Giovedì</label>
                        <input type="text" id="commit-thu" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="commit-fri" class="block text-sm font-medium text-gray-700">Venerdì</label>
                        <input type="text" id="commit-fri" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" id="closeCommitmentsModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Impegni</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {};
        let taskUnsubscribe = null;
        let commitmentsUnsubscribe = null; // Listener per Impegni
        let localCommitments = {}; // Cache locale per Impegni
        let isAiCallPending = false;
        let currentAiChatHistory = []; // Cronologia della chat AI
        let currentAiTaskId = null; // ID del compito di cui è aperta la chat

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        
        // Modal Compiti
        const modalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        // Modal Orario (Visualizzazione)
        const viewTimetableModalEl = document.getElementById('viewTimetableModal');
        const viewTimetableModalContentEl = document.getElementById('viewTimetableModalContent');
        
        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null;
        
        // Modal AI (Chat)
        const aiModalEl = document.getElementById('aiModal');
        const aiChatMessagesEl = document.getElementById('aiChatMessages');
        const aiChatFormEl = document.getElementById('aiChatForm');
        const aiChatInputEl = document.getElementById('aiChatInput');
        const aiChatSubmitEl = document.getElementById('aiChatSubmit');
        const closeAiModalButtonEl = document.getElementById('closeAiModalButton');
        
        // Modal AI Planner
        const aiPlannerModalEl = document.getElementById('aiPlannerModal');
        const aiPlannerModalContentEl = document.getElementById('aiPlannerModalContent');
        const closeAiPlannerModalButtonEl = document.getElementById('closeAiPlannerModalButton');
        
        // Modal Impegni
        const commitmentsModalEl = document.getElementById('commitmentsModal');
        const commitmentsFormEl = document.getElementById('commitmentsForm');
        const closeCommitmentsModalButtonEl = document.getElementById('closeCommitmentsModalButton');
        
        // Nuovo Menu
        const menuButton = document.getElementById('menuButton');
        const dropdownMenu = document.getElementById('dropdownMenu');

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- LOGICA ORARIO FISSO ---
        const dayNames = { mon: 'Lunedì', tue: 'Martedì', wed: 'Mercoledì', thu: 'Giovedì', fri: 'Venerdì' };
        
        const TIMETABLE_HOURS_MAP = {
            mon: [8, 9, 10, 11, 12], // 5 ore
            tue: [8, 9, 10, 11, 12, 13], // 6 ore
            wed: [8, 9, 10, 11, 12], // 5 ore
            thu: [8, 9, 10, 11, 12, 13], // 6 ore
            fri: [8, 9, 10, 11, 12]  // 5 ore
        };

        const FIXED_TIMETABLE = {
            mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"],
            tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"],
            wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"],
            thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"],
            fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"]
        };
        // --- Fine Logica Orario Fisso ---

        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova più tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        async function loadUserData() {
            if (!userId) return;
            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';
            
            await attachCommitmentsListener(); 
            // renderWeekDisplay è ora chiamato da attachCommitmentsListener
            await attachTaskListener();
        }

        // --- Funzioni Orario (Visualizzazione) ---
        
        function openTimetableModal() {
            const hours = [8, 9, 10, 11, 12, 13];
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ora</th>
            `;
            days.forEach(dayKey => {
                tableHtml += `<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${dayNames[dayKey]}</th>`;
            });
            tableHtml += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            hours.forEach((hour, hourIndex) => {
                tableHtml += `<tr class="even:bg-gray-50">`; // Righe alternate
                tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${hour}:00 - ${hour+1}:00</td>`;
                
                days.forEach(dayKey => {
                    const subject = FIXED_TIMETABLE[dayKey][hourIndex];
                    if (subject) {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${subject}</td>`;
                    } else {
                        tableHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">-</td>`; // Ora vuota
                    }
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table>`;
            
            viewTimetableModalContentEl.innerHTML = tableHtml;
            viewTimetableModalEl.style.display = 'flex';
        }
        
        function closeTimetableModal() {
            viewTimetableModalEl.style.display = 'none';
        }

        function generateTimetableHTML(dayKey) {
            const hours = TIMETABLE_HOURS_MAP[dayKey];
            const subjects = FIXED_TIMETABLE[dayKey];
            if (!hours || !subjects) return '<p class="text-xs text-gray-400 italic">Orario non definito</p>';
            
            let htmlEntries = [];
            let i = 0;
            while (i < subjects.length) {
                let subject = subjects[i];
                let startHour = hours[i];
                let j = i + 1;
                while (j < subjects.length && subjects[j] === subject) {
                    j++;
                }
                let endHour = hours[j - 1] + 1; 
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${subject}</span></p>`);
                i = j;
            }
            if (htmlEntries.length === 0) return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            return htmlEntries.join('\n');
        }
        
        // --- Funzioni Gestione Impegni ---

        async function attachCommitmentsListener() {
            if (commitmentsUnsubscribe) commitmentsUnsubscribe();
            
            const commitmentsDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            
            return new Promise((resolve) => {
                commitmentsUnsubscribe = onSnapshot(commitmentsDocRef, (docSnap) => {
                    console.log("Dati impegni ricevuti:", docSnap.exists() ? docSnap.data() : "Nessun dato");
                    localCommitments = docSnap.exists() ? docSnap.data() : {};
                    
                    for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        const inputEl = document.getElementById(`commit-${dayKey}`);
                        if (inputEl) {
                            inputEl.value = localCommitments[dayKey] || '';
                        }
                    }
                    
                    // Ridisegna la settimana ora che abbiamo gli impegni
                    renderWeekDisplay(currentWeekStart);
                    resolve();
                }, (error) => {
                    console.error("Errore nel listener degli impegni:", error);
                    showError("Impossibile caricare gli impegni.");
                    resolve(); // Risolvi comunque per non bloccare l'app
                });
            });
        }

        async function handleSaveCommitments(e) {
            e.preventDefault();
            if (!userId) return;

            const commitmentsData = {};
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                const inputEl = document.getElementById(`commit-${dayKey}`);
                commitmentsData[dayKey] = inputEl.value.trim() || '';
            }

            try {
                const commitmentsDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
                await setDoc(commitmentsDocRef, commitmentsData);
                console.log("Impegni salvati:", commitmentsData);
                closeCommitmentsModal();
                // Il listener onSnapshot aggiornerà automaticamente la UI
            } catch (error) {
                console.error("Errore salvataggio impegni:", error);
                showError("Errore nel salvataggio degli impegni.");
            }
        }
        
        function openCommitmentsModal() {
            // Assicura che il modal sia popolato con i dati più recenti
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                const inputEl = document.getElementById(`commit-${dayKey}`);
                if (inputEl) {
                    inputEl.value = localCommitments[dayKey] || '';
                }
            }
            commitmentsModalEl.style.display = 'flex';
        }

        function closeCommitmentsModal() {
            commitmentsModalEl.style.display = 'none';
        }

        function renderWeekCommitments() {
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                const displayEl = document.getElementById(`commitments-display-${dayKey}`);
                if (displayEl) {
                    const commitmentText = localCommitments[dayKey];
                    if (commitmentText) {
                        displayEl.innerHTML = `<p class="text-xs text-gray-800 font-semibold">${commitmentText}</p>`;
                    } else {
                        displayEl.innerHTML = `<p class="text-xs text-gray-400 italic">Nessun impegno</p>`;
                    }
                }
            }
        }


        // --- Funzioni Gestione Compiti (Tasks) ---

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {};
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = doc.data();
                });
                // Ridisegna la settimana con i compiti aggiornati
                renderWeekDisplay(currentWeekStart); 
            }, (error) => {
                console.error("Errore nel listener dei compiti:", error);
                showError("Impossibile caricare i compiti.");
            });
        }

        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;
            const id = taskIdEl.value;
            let taskData;
            
            if (id && allTasks[id]) {
                // Aggiornamento
                taskData = {
                    ...allTasks[id], // Mantiene i dati esistenti (come aiChatHistory)
                    subject: taskFormEl.subject.value,
                    description: taskFormEl.description.value,
                    dueDate: taskFormEl.dueDate.value,
                };
            } else {
                // Creazione
                taskData = {
                    subject: taskFormEl.subject.value,
                    description: taskFormEl.description.value,
                    dueDate: taskFormEl.dueDate.value,
                    completed: false,
                    aiChatHistory: [] // NUOVO: Inizializza la cronologia chat
                };
            }
            
            try {
                if (id) {
                    // Aggiorna compito esistente
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    // Crea nuovo compito
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal();
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
                showError("Impossibile salvare il compito.");
            }
        }


        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;

            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            
            populateSubjectDropdown(task.dueDate);
            
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;

            const subjectSelectEl = document.getElementById('subject');
            if (task.subject && !subjectSelectEl.querySelector(`option[value="${task.subject}"]`)) {
                const oldOption = document.createElement('option');
                oldOption.value = task.subject;
                oldOption.textContent = `${task.subject} (vecchia)`;
                subjectSelectEl.appendChild(oldOption);
                taskFormEl.subject.value = task.subject;
            }
            modalEl.style.display = 'flex';
        }

        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
                showError("Impossibile aggiornare il compito.");
            }
        }

        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
                showError("Impossibile eliminare il compito.");
            }
        }


        // --- Funzioni di Rendering UI ---

        function renderWeekDisplay(startDate) {
            if (!weekScrollContainerEl) return;
            weekScrollContainerEl.innerHTML = '';
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);
            const days = getWeekDays(startDate);

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase().substring(0, 3);
                const timetableHtml = generateTimetableHTML(dayKey);
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-column bg-white rounded-xl shadow-sm p-3 flex flex-col';
                dayCard.id = `day-${dateStr}`;
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    
                    <!-- Sezione Orario -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">${timetableHtml}</div>
                    
                    <!-- Sezione Impegni -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Impegni</h3>
                    <div id="commitments-display-${dayKey}" class="commitments-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[30px]">
                        <!-- Popolato da renderWeekCommitments -->
                    </div>

                    <!-- Sezione Compiti -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto"></div>`;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    openModal(date);
                });
            });

            populateTasksForWeek(days);
            renderWeekCommitments(); // Assicura che gli impegni siano visibili
            lucide.createIcons();
        }

        function populateTasksForWeek(days) {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const dateStrings = days.map(day => formatDate(day.date));
            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }

        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return;

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer';
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-col sm:flex-row gap-1 ml-auto';

            const aiButton = document.createElement('button');
            aiButton.className = 'p-1 rounded-full hover:bg-blue-100';
            aiButton.title = 'Assistente AI';
            aiButton.innerHTML = `<span data-lucide="Sparkles" class="text-blue-500 hover:text-blue-700" width="16" height="16"></span>`;
            // MODIFICATO: Passa l'ID del compito alla funzione
            aiButton.addEventListener('click', () => openAiModal(id, data.subject, data.description));
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.title = 'Elimina';
            deleteButton.innerHTML = `<span data-lucide="Trash2" class="text-red-500 hover:text-red-700" width="16" height="16"></span>`;
            deleteButton.addEventListener('click', () => handleDeleteTask(id));

            actionsDiv.appendChild(aiButton);
            actionsDiv.appendChild(deleteButton);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(actionsDiv);

            taskListContainer.appendChild(taskEl);
            lucide.createIcons({ nodes: [taskEl] });
        }

        // --- Funzione per popolare il dropdown materie (da orario fisso) ---
        function populateSubjectDropdown(dateStr) {
            const subjectSelectEl = document.getElementById('subject');
            subjectSelectEl.innerHTML = '<option value="">-- Seleziona Materia --</option>';
            if (!dateStr) return;

            try {
                // Usa il costruttore Date per interpretare la data nel fuso orario locale
                const parts = dateStr.split('-').map(Number);
                const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                
                const dayOfWeek = dateObj.getDay(); // 0 = Dom, 1 = Lun, ... 6 = Sab
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                
                if (!dayKey || dayKey === 'sun' || dayKey === 'sat') {
                    console.log(`Giorno non valido (${dayKey}) per la data ${dateStr}`);
                    return;
                }

                const daySubjects = FIXED_TIMETABLE[dayKey] || [];
                const uniqueSubjects = [...new Set(daySubjects)];
                uniqueSubjects.sort();

                uniqueSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelectEl.appendChild(option);
                });
            } catch (e) {
                console.error("Errore nel popolare le materie:", e);
                subjectSelectEl.innerHTML = '<option value="">Errore nel caricare le materie</option>';
            }
        }


        // --- Funzioni Modal (Finestre Popup) ---

        function openModal(defaultDate = null) {
            taskFormEl.reset();
            modalTitleEl.innerText = "Nuovo Compito";
            taskIdEl.value = '';
            const dateToUse = defaultDate ? defaultDate : formatDate(new Date());
            taskFormEl.dueDate.value = dateToUse;
            populateSubjectDropdown(dateToUse);
            modalEl.style.display = 'flex';
        }

        function closeModal() {
            modalEl.style.display = 'none';
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            confirmModalEl.style.display = 'flex';
        }
        
        function closeConfirm() {
            confirmModalEl.style.display = 'none';
            confirmCallback = null;
        }

        // --- Funzioni Assistente AI (ORA CON MEMORIA PERSISTENTE) ---

        // Aggiunge un messaggio alla finestra della chat
        function addAiChatMessage(role, content) {
            // Rimuove il loading bubble se presente
            const loadingBubble = aiChatMessagesEl.querySelector('.loading');
            if (loadingBubble) {
                loadingBubble.remove();
            }

            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', role);
            
            if (content === 'loading') {
                bubble.classList.add('loading');
                bubble.innerHTML = `
                    <span data-lucide="Loader" class="w-4 h-4 animate-spin"></span>
                    <span class="ml-2 text-sm">L'assistente sta pensando...</span>
                `;
                lucide.createIcons({ nodes: [bubble] });
            } else if (content.startsWith('error:')) {
                bubble.classList.add('bg-red-100', 'text-red-700'); // Stile errore
                bubble.textContent = content.substring(6).trim();
            } else {
                // Formattazione HTML base per la risposta del modello
                // Converte markdown base in HTML
                let formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Grassetto
                    .replace(/\* (.*?)(?=\n|$)/g, '<li>$1</li>') // Liste puntate
                    .replace(/(<\/li>)+/g, '</li>') // Pulisci liste
                    .replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>') // Metti <ul>
                    .replace(/<\/ul>\n<ul>/g, '') // Unisci liste adiacenti
                    .replace(/(\r\n|\n|\r)/g, '<br>') // A capo
                    .replace(/<br><ul>/g, '<ul>') // Pulisci
                    .replace(/<\/ul><br>/g, '</ul>');
                    
                bubble.innerHTML = formattedContent;
            }
            
            aiChatMessagesEl.appendChild(bubble);
            aiChatMessagesEl.scrollTop = aiChatMessagesEl.scrollHeight;
        }


        // Avvia una nuova sessione di chat o CARICA quella esistente
        async function openAiModal(taskId, subject, description) {
            if (isAiCallPending) return;
            
            currentAiTaskId = taskId; // Imposta l'ID del compito corrente
            const task = allTasks[taskId];
            
            aiModalEl.style.display = 'flex';
            aiChatMessagesEl.innerHTML = '';
            aiChatInputEl.value = '';
            
            const savedHistory = (task && task.aiChatHistory) ? task.aiChatHistory : [];

            if (savedHistory.length > 0) {
                // Carica la cronologia salvata
                console.log("Caricamento cronologia chat:", savedHistory);
                currentAiChatHistory = [...savedHistory];
                currentAiChatHistory.forEach(message => {
                    addAiChatMessage(message.role, message.parts[0].text);
                });
                aiChatMessagesEl.scrollTop = aiChatMessagesEl.scrollHeight;
            } else {
                // Avvia una nuova chat (è la prima volta)
                console.log("Avvio nuova chat per il compito:", taskId);
                currentAiChatHistory = []; // Resetta la cronologia
                addAiChatMessage('model', 'loading');
                
                const initialPrompt = `Il mio compito è:
- Materia: ${subject}
- Descrizione: ${description}

Forniscimi la spiegazione e i consigli pratici (rispondi in HTML).`;
                
                // Avvia la chat
                await callGeminiChatApi(initialPrompt, true);
            }
        }

        function closeAiModal() {
            aiModalEl.style.display = 'none';
            aiChatMessagesEl.innerHTML = '';
            currentAiChatHistory = [];
            currentAiTaskId = null; // Resetta l'ID del compito
            isAiCallPending = false;
        }
        
        // Gestisce l'invio di un nuovo messaggio
        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const userText = aiChatInputEl.value.trim();
            if (!userText || isAiCallPending || !currentAiTaskId) return;
            
            aiChatInputEl.value = '';
            aiChatInputEl.disabled = true;
            aiChatSubmitEl.disabled = true;
            
            addAiChatMessage('user', userText);
            addAiChatMessage('model', 'loading');
            
            await callGeminiChatApi(userText, false);
        }

        // Salva la cronologia chat su Firebase
        async function saveAiChatHistory() {
            if (!currentAiTaskId || !userId) return;
            
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", currentAiTaskId);
                await updateDoc(taskDocRef, { aiChatHistory: currentAiChatHistory });
                console.log("Cronologia chat salvata per il compito:", currentAiTaskId);
            } catch (error) {
                console.error("Errore salvataggio cronologia chat:", error);
            }
        }

        // Funzione principale che chiama l'API
        async function callGeminiChatApi(userPromptText, isFirstMessage = false) {
            isAiCallPending = true;

            const systemPrompt = `Sei un assistente tutor (per una studentessa di scuola media o superiore in Italia).
Rispondi sempre in italiano.
La tua risposta deve essere una continuazione di una chat.
Formatta la risposta in HTML semplice (paragrafi <p>, liste <ul><li> e grassetto <strong>).

Se è il primo messaggio, rispondi con:
1.  **Breve Spiegazione:** Una spiegazione concisa (massimo 2-3 frasi) dell'argomento principale.
2.  **Consigli Pratici:** Una lista puntata (massimo 3-4 punti) con consigli pratici e specifici.

Per i messaggi successivi, rispondi in modo conciso alla domanda dell'utente, mantenendo il contesto della chat.
Usa la ricerca se necessario per rispondere alle domande.`;
            
            // Aggiungi il prompt dell'utente alla cronologia (solo se non è il messaggio di sistema iniziale)
            if (!isFirstMessage || currentAiChatHistory.length === 0) {
                 currentAiChatHistory.push({ role: 'user', parts: [{ text: userPromptText }] });
            }

            const payload = {
                contents: currentAiChatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            // Gestione speciale per il primo messaggio
            if (isFirstMessage) {
                payload.contents = [{ role: 'user', parts: [{ text: userPromptText }] }];
            }

            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    const modelText = result.candidates[0].content.parts[0].text;
                    
                    // Se era il primo messaggio, ora salviamo sia il prompt che la risposta
                    if (isFirstMessage) {
                        currentAiChatHistory.push({ role: 'user', parts: [{ text: userPromptText }] });
                    }
                    currentAiChatHistory.push({ role: 'model', parts: [{ text: modelText }] });
                    
                    addAiChatMessage('model', modelText);
                    await saveAiChatHistory(); // Salva la cronologia aggiornata
                } else {
                    addAiChatMessage('model', 'error: Non ho trovato una risposta valida. Riprova.');
                    // Rimuovi l'ultimo prompt dell'utente dalla cronologia se l'AI fallisce
                    currentAiChatHistory.pop();
                }
            } catch (error) {
                console.error("Errore chiamata AI:", error);
                addAiChatMessage('model', `error: C'è stato un errore: ${error.message}`);
                currentAiChatHistory.pop();
            } finally {
                isAiCallPending = false;
                aiChatInputEl.disabled = false;
                aiChatSubmitEl.disabled = false;
                aiChatInputEl.focus();
            }
        }
        
        // --- Funzioni AI Planner (AGGIORNATE CON IMPEGNI) ---

        function openAiPlannerModal() {
            if (isAiCallPending) return;
            
            aiPlannerModalEl.style.display = 'flex';
            aiPlannerModalContentEl.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <span data-lucide="Loader" class="w-6 h-6 text-purple-500 animate-spin"></span>
                    <p class="ml-3 text-gray-600">L'AI sta creando il tuo piano di studio...</p>
                </div>
            `;
            lucide.createIcons({ nodes: [aiPlannerModalContentEl] });
            
            callGeminiPlannerApi();
        }
        
        function closeAiPlannerModal() {
            aiPlannerModalEl.style.display = 'none';
            aiPlannerModalContentEl.innerHTML = '';
        }
        
        async function callGeminiPlannerApi() {
            isAiCallPending = true;
            // Disabilita il pulsante nel menu
            const menuAiPlannerEl = document.getElementById('menuAiPlanner');
            if(menuAiPlannerEl) menuAiPlannerEl.style.pointerEvents = 'none';

            const days = getWeekDays(currentWeekStart);
            const dateStrings = days.map(day => formatDate(day.date));
            const tasksForWeek = [];
            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate) && !task.completed) {
                    tasksForWeek.push(`- ${task.subject}: ${task.description} (Scadenza: ${task.dueDate})`);
                }
            }
            
            const commitmentsForWeek = [];
            for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                if (localCommitments[dayKey]) {
                    commitmentsForWeek.push(`- ${dayNames[dayKey]}: ${localCommitments[dayKey]}`);
                }
            }
            
            if (tasksForWeek.length === 0) {
                 aiPlannerModalContentEl.innerHTML = `
                    <div class="text-center">
                        <span data-lucide="CheckCheck" class="w-12 h-12 mx-auto text-green-500"></span>
                        <h3 class="font-semibold mt-2">Tutto Fatto!</h3>
                        <p class="text-sm text-gray-600 mt-1">Non ci sono compiti da pianificare per questa settimana. Ottimo lavoro!</p>
                    </div>
                `;
                lucide.createIcons({ nodes: [aiPlannerModalContentEl] });
                isAiCallPending = false;
                if(menuAiPlannerEl) menuAiPlannerEl.style.pointerEvents = 'auto';
                return;
            }

            const formattedTimetable = Object.entries(FIXED_TIMETABLE).map(([dayKey, subjects]) => {
                const dayName = dayNames[dayKey];
                const hours = TIMETABLE_HOURS_MAP[dayKey];
                const subjectList = subjects.map((subj, index) => `  ${hours[index]}:00-${hours[index]+1}:00: ${subj}`).join('\n');
                return `${dayName}:\n${subjectList}`;
            }).join('\n\n');
            
            const today = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const systemPrompt = `Sei un "Tutor di Pianificazione" esperto per studenti italiani.
Il tuo obiettivo è creare un piano di studio POMERIDIANO realistico, motivante e facile da seguire.
Rispondi sempre in italiano.
Formatta la risposta in HTML semplice (paragrafi <p>, liste <ul><li>, grassetto <strong> e titoli <h3>).

Regole Chiave:
1.  **Analizza i Dati:** Riceverai la data di oggi, l'orario scolastico (mattina), un elenco di *impegni fissi* (sport, musica, ecc.) e un elenco di compiti con scadenze.
2.  **Pianifica solo i Pomeriggi:** Il tuo piano deve iniziare dal pomeriggio di "oggi" fino a venerdì.
3.  **RISPETTA GLI IMPEGNI FISSI:** Gli impegni fissi hanno la priorità assoluta. Devi pianificare lo studio *attorno* a questi orari bloccati. Non sovrapporre lo studio agli impegni.
4.  **Dai Priorità (Compiti):** Assegna priorità ai compiti con scadenza più vicina.
5.  **Sii Realistico:** Non sovraccaricare. Alterna materie (es. non 2 ore di fila di Matematica). Includi brevi pause.
6.  **Struttura:** Dividi il piano per giorno (es. <h3>Piano per Oggi (Martedì)</h3>). Per ogni giorno, crea una lista puntata <ul><li> con i compiti da fare e un orario suggerito (es. "15:00-15:45: Matematica"). Assicurati di menzionare gli impegni fissi nel piano (es. "17:00-19:00: Pallavolo").
7.  **Tono:** Sii incoraggiante e positivo. Inizia con una breve frase di incoraggiamento.`;
            
            const userQuery = `Ciao! Oggi è ${today}.
Questo è il mio orario scolastico (so quando sono a scuola la mattina):
${formattedTimetable}

Questi sono i miei *impegni fissi* (sport, ecc.) da rispettare:
${commitmentsForWeek.length > 0 ? commitmentsForWeek.join('\n') : "Nessun impegno fisso questa settimana."}

Questi sono i miei *compiti* da fare per questa settimana:
${tasksForWeek.join('\n')}

Per favore, creami un piano di studio pomeridiano (da oggi a venerdì) che rispetti i miei impegni fissi e mi permetta di completare i compiti in tempo.`;

            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let text = result.candidates[0].content.parts[0].text;
                    // Formattazione HTML base
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/### (.*?)(?:\n|$)/g, '<h3>$1</h3>');
                    text = text.replace(/\* (.*?)(?:\n|$)/g, '<li>$1</li>');
                    text = text.replace(/(\r\n|\n|\r)/g, '<br>');
                    text = text.replace(/<br><li>/g, '<li>');
                    text = text.replace(/<li>/g, '<ul><li>');
                    text = text.replace(/<\/li><br>/g, '</li></ul>');
                    text = text.replace(/<\/li><\/ul><ul><li>/g, '</li><li>'); // Unisci liste
                    aiPlannerModalContentEl.innerHTML = text;
                } else {
                    aiPlannerModalContentEl.innerHTML = '<p class="text-red-500">Non ho trovato un piano valido. Riprova.</p>';
                }
            } catch (error) {
                console.error("Errore chiamata AI Planner:", error);
                aiPlannerModalContentEl.innerHTML = `<p class="text-red-500">C'è stato un errore nel creare il piano: ${error.message}</p>`;
            } finally {
                isAiCallPending = false;
                if(menuAiPlannerEl) menuAiPlannerEl.style.pointerEvents = 'auto';
            }
        }


        // --- Funzioni Utilità (Date, Errori) ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const newDate = new Date(d.setDate(diff));
            newDate.setHours(0, 0, 0, 0); // Azzera l'ora per evitare problemi di fuso orario
            return newDate;
        }

        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            for (let i = 0; i < 5; i++) {
                days.push({ name: dayNames[i], date: new Date(d), value: dayValues[i] });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        // CORREZIONE per il bug del Lunedì (non usa UTC)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            return `${startStr} - ${endStr}`;
        }
        
        function showError(message) {
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message);
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart);
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentWeekStart = getStartOfWeek(new Date());
                renderWeekDisplay(currentWeekStart);
            });

            // Modal Compiti
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            taskFormEl.addEventListener('submit', handleSaveTask);

            // Modal Orario (Visualizzazione)
            document.getElementById('closeViewTimetableModalButton').addEventListener('click', closeTimetableModal);
            
            // Modal Conferma
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirm();
            });
            
            // Modal AI (Chat)
            closeAiModalButtonEl.addEventListener('click', closeAiModal);
            aiChatFormEl.addEventListener('submit', handleAiChatSubmit);
            
            // Modal AI Planner
            closeAiPlannerModalButtonEl.addEventListener('click', closeAiPlannerModal);
            
            // Modal Impegni
            closeCommitmentsModalButtonEl.addEventListener('click', closeCommitmentsModal);
            commitmentsFormEl.addEventListener('submit', handleSaveCommitments);

            // Nuovo Menu Dropdown
            document.getElementById('menuAiPlanner').addEventListener('click', (e) => {
                e.preventDefault();
                openAiPlannerModal();
                dropdownMenu.classList.add('hidden');
            });
            document.getElementById('menuCommitments').addEventListener('click', (e) => {
                e.preventDefault();
                openCommitmentsModal();
                dropdownMenu.classList.add('hidden');
            });
            document.getElementById('menuTimetable').addEventListener('click', (e) => {
                e.preventDefault();
                openTimetableModal();
                dropdownMenu.classList.add('hidden');
            });

            menuButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Impedisce al click di chiudere subito il menu
                dropdownMenu.classList.toggle('hidden');
            });

            // Chiudi il menu se si clicca altrove
            window.addEventListener('click', (e) => {
                if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });

            // Avvia l'app
            initializeFirebase();
        });

    </script>
</body>
</html>
