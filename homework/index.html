<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimana</title>
	<link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
	<meta name="apple-mobile-web-app-title" content="Compiti">
	<!-- ICONA PER iOS (Apple) -->
	<link rel="apple-touch-icon" href="./images/ingranaggio-matita.png">
	<meta name="theme-color" content="#3B82F6">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js per il grafico (Aggiunto per Punto 2) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none;
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 100%; /* Occupano il 100% della larghezza su mobile */
            scroll-snap-align: start;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi pi√π grandi, si dividono lo spazio */
            }
            .week-scroll-container {
                gap: 0.75rem; /* 12px */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        /* Stili Chat Generali */
        .chat-container {
            height: 350px;
            overflow-y: auto;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-model {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937; /* gray-800 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-model.planner {
            background-color: #F3E8FF; /* purple-100 */
            color: #3730A3; /* purple-800 */
        }
        .loading-bubble {
            display: flex;
            gap: 1.5px;
            align-items: center;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Stili Tabella Orario */
        #timetableModalTable {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
        }
        #timetableModalTable table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
        }
        #timetableModalTable th, #timetableModalTable td {
            border: 1px solid #E5E7EB;
            padding: 10px;
            text-align: left;
            font-size: 0.875rem;
        }
        #timetableModalTable th {
            background-color: #F9FAFB;
        }
        #timetableModalTable tbody tr:nth-child(odd) {
            background-color: #F9FAFB; /* Grigio chiaro alternato */
        }
        
        /* Stili Premio */
        #prizeSection {
            display: none; /* Nascosto di default */
            text-align: center;
            padding: 20px;
            background: linear-gradient(145deg, #fef9c3, #fafad2);
            border: 2px dashed #facc15;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        #prizeSection::before {
            content: 'üéâ';
            position: absolute;
            top: -10px; left: 10px;
            font-size: 24px;
            animation: confetti 1.5s infinite;
        }
        #prizeSection::after {
            content: '‚ú®';
            position: absolute;
            bottom: -5px; right: 15px;
            font-size: 20px;
            animation: confetti 1.7s infinite 0.3s;
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }


        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                
                <!-- Titolo e Navigazione Settimana (Sinistra) -->
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-yellow-300 bg-blue-600 px-3 py-1 rounded-lg">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>

                <!-- Pulsanti Azione (Destra) -->
                <div class="flex items-center gap-2">
                    <!-- Tasto "Oggi" rimosso -->
                    
                    <!-- Menu Dropdown -->
                    <div class="relative" id="menuContainer">
                        <button id="menuToggleBtn" class="p-2 rounded-lg hover:bg-gray-100">
                            <span data-lucide="Menu" class="w-5 h-5 text-gray-700"></span>
                        </button>
                        <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border z-50">
                            <a id="openAiPlannerButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="BrainCircuit" class="w-5 h-5 text-purple-600"></span>
                                AI Planner
                            </a>
                            <a id="openCommitmentsButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="CalendarClock" class="w-5 h-5 text-green-600"></span>
                                Impegni
                            </a>
                            <a id="openFutureDeadlinesButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="Target" class="w-5 h-5 text-red-600"></span>
                                Scadenze Future
                            </a>
                            <a id="openTimetableButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="BookOpen" class="w-5 h-5 text-blue-600"></span>
                                Orario
                            </a>
                            <a id="openProgressButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 border-t">
                                <span data-lucide="PieChart" class="w-5 h-5 text-yellow-600"></span>
                                Progressi
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Banner Notifiche Scadenze -->
        <div id="notificationBanner" class="hidden sticky top-[65px] z-20">
            <!-- Il contenuto verr√† generato da JS -->
        </div>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="hidden flex-1 overflow-hidden p-3 sm:p-4">
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full">
                <!-- Le colonne dei giorni (Luned√¨-Venerd√¨) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Orario Settimanale (Sola lettura) -->
    <div id="timetableModal" class="modal">
        <div class="modal-content max-w-3xl">
            <h2 class="text-lg font-semibold mb-4">Orario Settimanale</h2>
            <div id="timetableModalTable" class="rounded-lg border">
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione -->
    <div id="confirmModal" class="modal" style="z-index: 60;">
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>

    <!-- 6. Modal Assistente AI (Chat) -->
    <div id="aiAssistantModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span data-lucide="Sparkles" class="w-5 h-5 text-blue-500"></span>
                Assistente AI
            </h2>
            <div id="aiChatHistory" class="chat-container p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 flex flex-col gap-3">
            </div>
            <form id="aiChatForm" class="flex gap-2">
                <input type="text" id="aiChatInput" placeholder="Fai una domanda..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" id="aiChatSendButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center justify-center">
                    <span data-lucide="Send" class="w-5 h-5"></span>
                </button>
            </form>
            <div class="flex justify-end mt-4">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 7. Modal AI Planner (Chat) -->
    <div id="aiPlannerModal" class="modal">
         <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span data-lucide="BrainCircuit" class="w-5 h-5 text-purple-600"></span>
                Piano di Studio AI (Chat)
            </h2>
            <div id="aiPlannerChatHistory" class="chat-container p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 flex flex-col gap-3">
            </div>
            <form id="aiPlannerChatForm" class="flex gap-2">
                <input type="text" id="aiPlannerChatInput" placeholder="Modifica il piano..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" id="aiPlannerChatSendButton" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition flex items-center justify-center">
                    <span data-lucide="Send" class="w-5 h-5"></span>
                </button>
            </form>
             <div class="flex justify-end mt-4">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- 8. Modal Impegni Settimanali -->
    <div id="commitmentsModal" class="modal">
        <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4">Impegni Settimanali</h2>
            <p class="text-sm text-gray-600 mb-4">Inserisci qui i tuoi impegni fissi (es. sport, musica, appuntamenti). L'AI Planner li user√† per organizzare lo studio.</p>
            <form id="commitmentsForm">
                <div id="commitmentsModalContent" class="space-y-4">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Impegni</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 9. Modal Scadenze Future -->
    <div id="futureDeadlinesModal" class="modal">
        <div class="modal-content max-w-2xl">
            <h2 class="text-lg font-semibold mb-4">Radar Scadenze Future</h2>
            <p class="text-sm text-gray-600 mb-4">Aggiungi qui verifiche, consegne e interrogazioni importanti. L'app te le ricorder√† e l'AI le user√† per pianificare il ripasso.</p>
            
            <form id="futureDeadlineForm" class="flex flex-col sm:flex-row gap-3 mb-6 pb-6 border-b">
                <input type="text" id="futureDeadlineDescription" placeholder="Descrizione (es. Verifica Latino)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <input type="date" id="futureDeadlineDate" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Aggiungi</button>
            </form>
            
            <h3 class="text-md font-semibold mb-3">Scadenze Salve</h3>
            <div id="futureDeadlinesList" class="space-y-2 max-h-[30vh] overflow-y-auto">
            </div>
            
            <div class="flex justify-end mt-6 pt-4 border-t">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- 10. Modal Progressi e Statistiche (Aggiunto per Punto 2) -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span data-lucide="PieChart" class="w-5 h-5 text-yellow-600"></span>
                Progressi e Statistiche
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Colonna Statistiche -->
                <div class="space-y-4">
                    <div>
                        <h3 class="font-semibold text-md mb-2">Progressi di Oggi</h3>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">Compiti completati oggi:</p>
                            <p id="dailyStats" class="text-2xl font-bold text-gray-800">0 / 0</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-md mb-2">Progressi Settimana</h3>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">Compiti completati (settimana corrente):</p>
                            <p id="weeklyStats" class="text-2xl font-bold text-gray-800">0 / 0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Colonna Grafico -->
                <div class="flex flex-col items-center justify-center">
                    <h3 class="font-semibold text-md mb-2">Panoramica Settimana</h3>
                    <div class="w-full max-w-[200px] h-[200px]">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Sezione Premio -->
            <div id="prizeSection" class="mt-6">
                <span data-lucide="Trophy" class="w-12 h-12 text-yellow-500 mx-auto"></span>
                <h3 class="text-xl font-bold text-yellow-800 mt-2">Settimana Completata!</h3>
                <p class="text-yellow-700">Ottimo lavoro, hai finito tutti i compiti!</p>
            </div>
            
            <div class="flex justify-end mt-6 pt-4 border-t">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Chiudi</button>
            </div>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {};
        let allFutureDeadlines = [];
        
        let taskUnsubscribe = null;
        let commitmentUnsubscribe = null;
        let futureDeadlinesUnsubscribe = null;

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        const notificationBannerEl = document.getElementById('notificationBanner');
        
        const taskModalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        const timetableModalEl = document.getElementById('timetableModal');
        
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null;
        
        const aiAssistantModalEl = document.getElementById('aiAssistantModal');
        const aiChatHistoryEl = document.getElementById('aiChatHistory');
        const aiChatFormEl = document.getElementById('aiChatForm');
        const aiChatInputEl = document.getElementById('aiChatInput');
        const aiChatSendButtonEl = document.getElementById('aiChatSendButton');
        let currentAiChatHistory = [];
        let currentAiTaskId = null;

        const aiPlannerModalEl = document.getElementById('aiPlannerModal');
        const aiPlannerChatHistoryEl = document.getElementById('aiPlannerChatHistory');
        const aiPlannerChatFormEl = document.getElementById('aiPlannerChatForm');
        const aiPlannerChatInputEl = document.getElementById('aiPlannerChatInput');
        const aiPlannerChatSendButtonEl = document.getElementById('aiPlannerChatSendButton');
        let currentAiPlannerChatHistory = [];
        
        const commitmentsModalEl = document.getElementById('commitmentsModal');
        const commitmentsFormEl = document.getElementById('commitmentsForm');
        
        const futureDeadlinesModalEl = document.getElementById('futureDeadlinesModal');
        const futureDeadlineFormEl = document.getElementById('futureDeadlineForm');
        const futureDeadlinesListEl = document.getElementById('futureDeadlinesList');
        
        // Elementi Progressi (Aggiunto per Punto 2)
        const progressModalEl = document.getElementById('progressModal');
        const dailyStatsEl = document.getElementById('dailyStats');
        const weeklyStatsEl = document.getElementById('weeklyStats');
        const progressChartCanvas = document.getElementById('progressChart');
        const prizeSectionEl = document.getElementById('prizeSection');
        let progressChartInstance = null;
        
        const menuContainer = document.getElementById('menuContainer');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const menuDropdown = document.getElementById('menuDropdown');

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Orario Fisso ---
        const timetable = {
            mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"],
            tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"],
            wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"],
            thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"],
            fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"]
        };
        const dayNames = { mon: 'Luned√¨', tue: 'Marted√¨', wed: 'Mercoled√¨', thu: 'Gioved√¨', fri: 'Venerd√¨' };
        const hourSlots = ["8:00-9:00", "9:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "13:00-14:00"];


        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        await loadAllUserData();
                    } else {
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova pi√π tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        async function loadAllUserData() {
            if (!userId) return;

            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';

            setupTimetableModal();
            setupCommitmentsModal();

            attachTaskListener();
            attachCommitmentListener();
            attachFutureDeadlinesListener();
            
            renderWeekDisplay(currentWeekStart);
        }

        // --- Listener di Firestore ---

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {};
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderWeekDisplay(currentWeekStart);
            }, (error) => console.error("Errore listener compiti:", error));
        }

        function attachCommitmentListener() {
            if (commitmentUnsubscribe) commitmentUnsubscribe();
            const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            
            commitmentUnsubscribe = onSnapshot(commitmentDocRef, (docSnap) => {
                console.log("Dati impegni ricevuti.");
                const commitments = docSnap.exists() ? docSnap.data() : {};
                for (const dayKey of Object.keys(dayNames)) {
                    const inputEl = document.getElementById(`commitment-${dayKey}`);
                    if (inputEl) {
                        inputEl.value = commitments[dayKey] || '';
                    }
                }
                renderWeekDisplay(currentWeekStart);
            }, (error) => console.error("Errore listener impegni:", error));
        }

        function attachFutureDeadlinesListener() {
            if (futureDeadlinesUnsubscribe) futureDeadlinesUnsubscribe();
            const deadlinesCollectionRef = collection(db, "artifacts", appId, "users", userId, "future_deadlines");
            
            futureDeadlinesUnsubscribe = onSnapshot(deadlinesCollectionRef, (querySnapshot) => {
                console.log("Dati scadenze future ricevuti.");
                allFutureDeadlines = [];
                querySnapshot.forEach((doc) => {
                    allFutureDeadlines.push({ id: doc.id, ...doc.data() });
                });
                allFutureDeadlines.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                renderFutureDeadlinesList();
                renderNotificationBanner();
                renderWeekDisplay(currentWeekStart);
            }, (error) => console.error("Errore listener scadenze:", error));
        }
        
        
        // --- Funzioni Orario (Fisso) ---
        
        function setupTimetableModal() {
            const tableContainer = document.getElementById('timetableModalTable');
            let tableHtml = '<table><thead><tr><th>Ora</th>';
            Object.values(dayNames).forEach(name => tableHtml += `<th>${name}</th>`);
            tableHtml += '</tr></thead><tbody>';

            hourSlots.forEach((hour, hourIndex) => {
                tableHtml += `<tr class="${hourIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}"><td><strong>${hour}</strong></td>`;
                Object.keys(dayNames).forEach(dayKey => {
                    const subject = timetable[dayKey][hourIndex] || '---';
                    tableHtml += `<td>${subject}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
        }

        function getSubjectsForDay(dayKey) {
            if (!timetable[dayKey]) return [];
            return [...new Set(timetable[dayKey])]; 
        }

        
        // --- Funzioni Impegni Settimanali ---
        
        function setupCommitmentsModal() {
            const contentEl = document.getElementById('commitmentsModalContent');
            let html = '';
            Object.keys(dayNames).forEach(dayKey => {
                html += `<div>
                    <label for="commitment-${dayKey}" class="block text-sm font-medium text-gray-700">${dayNames[dayKey]}</label>
                    <input type="text" id="commitment-${dayKey}" 
                           placeholder="es. 17:00 - 19:00 Pallavolo"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>`;
            });
            contentEl.innerHTML = html;
        }
        
        async function handleSaveCommitments(e) {
            e.preventDefault();
            if (!userId) return;

            const commitmentsData = {};
            Object.keys(dayNames).forEach(dayKey => {
                commitmentsData[dayKey] = document.getElementById(`commitment-${dayKey}`).value.trim();
            });

            try {
                const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
                await setDoc(commitmentDocRef, commitmentsData);
                closeModal(commitmentsModalEl);
            } catch (error) {
                console.error("Errore salvataggio impegni:", error);
            }
        }
        
        async function getCommitments() {
            if (!userId) return {}; // Aggiunto controllo per userId
            const commitmentDocRef = doc(db, "artifacts", appId, "users", userId, "data", "commitments");
            const docSnap = await getDoc(commitmentDocRef);
            return docSnap.exists() ? docSnap.data() : {};
        }


        // --- Funzioni Scadenze Future ---
        
        async function handleSaveFutureDeadline(e) {
            e.preventDefault();
            if (!userId) return;
            
            const description = futureDeadlineFormEl.futureDeadlineDescription.value;
            const date = futureDeadlineFormEl.futureDeadlineDate.value;
            
            if (!description || !date) return;
            
            try {
                const deadlinesCollectionRef = collection(db, "artifacts", appId, "users", userId, "future_deadlines");
                await addDoc(deadlinesCollectionRef, { description, date });
                futureDeadlineFormEl.reset();
            } catch (error) {
                console.error("Errore salvataggio scadenza futura:", error);
            }
        }
        
        async function handleDeleteFutureDeadline(id) {
            showConfirm("Sei sicuro di voler eliminare questa scadenza?", async () => {
                if (!userId) return;
                try {
                    const deadlineDocRef = doc(db, "artifacts", appId, "users", userId, "future_deadlines", id);
                    await deleteDoc(deadlineDocRef);
                } catch (error) {
                    console.error("Errore eliminazione scadenza:", error);
                }
            });
        }
        
        function renderFutureDeadlinesList() {
            futureDeadlinesListEl.innerHTML = '';
            if (allFutureDeadlines.length === 0) {
                futureDeadlinesListEl.innerHTML = '<p class="text-sm text-gray-500 italic">Nessuna scadenza futura salvata.</p>';
                return;
            }
            
            allFutureDeadlines.forEach(deadline => {
                const li = document.createElement('div');
                li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                li.innerHTML = `
                    <div>
                        <p class="font-medium text-sm">${deadline.description}</p>
                        <p class="text-xs text-gray-600">${new Date(deadline.date + 'T00:00:00').toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    <button data-id="${deadline.id}" class="delete-deadline-btn p-1 rounded-full hover:bg-red-100">
                        <span data-lucide="Trash2" class="w-4 h-4 text-red-500"></span>
                    </button>
                `;
                futureDeadlinesListEl.appendChild(li);
            });
            
            futureDeadlinesListEl.querySelectorAll('.delete-deadline-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteFutureDeadline(e.currentTarget.dataset.id));
            });
            
            lucide.createIcons();
        }

        // --- Funzioni di Rendering UI ---
        
        function renderNotificationBanner() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingDeadlines = allFutureDeadlines.filter(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 21;
            });
            
            if (upcomingDeadlines.length === 0) {
                notificationBannerEl.style.display = 'none';
                return;
            }
            
            let message = `<strong>Attenzione:</strong> Hai ${upcomingDeadlines.length} scadenz${upcomingDeadlines.length > 1 ? 'e' : 'a'} in arrivo! `;
            message += upcomingDeadlines.map(d => 
                `"${d.description}" (${new Date(d.date + 'T00:00:00').toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })})`
            ).join(', ');

            notificationBannerEl.innerHTML = `
                <div class="max-w-7xl mx-auto p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800">
                    <div class="flex items-center gap-3">
                        <span data-lucide="AlertTriangle" class="w-5 h-5"></span>
                        <p class="text-sm">${message}</p>
                    </div>
                </div>`;
            notificationBannerEl.style.display = 'block';
            lucide.createIcons();
        }

        async function renderWeekDisplay(startDate) {
            if (!weekScrollContainerEl || !userId) return;
            
            weekScrollContainerEl.innerHTML = '';
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);

            const days = getWeekDays(startDate);
            const commitments = await getCommitments();
            const todayStr = formatDate(new Date());

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase();
                
                const timetableHtml = generateTimetableHTML(dayKey);
                
                const commitmentHtml = commitments[dayKey] 
                    ? `<p class="text-xs text-gray-800 font-medium break-words">${commitments[dayKey]}</p>` 
                    : '<p class="text-xs text-gray-400 italic">Nessun impegno</p>';
                    
                const radarHtml = generateRadarHTML(day.date);

                const dayCard = document.createElement('div');
                dayCard.className = `day-column bg-white rounded-xl shadow-sm p-3 flex flex-col ${dateStr === todayStr ? 'border-2 border-blue-500' : 'border border-transparent'}`;
                dayCard.id = `day-${dateStr}`;
                
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Radar Scadenze</h3>
                    <div class="radar-display mb-2 p-2 bg-red-50 rounded-lg min-h-[30px]">
                        ${radarHtml}
                    </div>
                    
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">
                        ${timetableHtml}
                    </div>
                    
                    <h3 class="font-semibold text-sm text-gray-500 mb-1 mt-2">Impegni</h3>
                    <div class="commitment-display mb-2 p-2 bg-green-50 rounded-lg min-h-[30px]">
                        ${commitmentHtml}
                    </div>

                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}" data-daykey="${dayKey}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto">
                    </div>
                `;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    const dayKey = e.currentTarget.dataset.daykey;
                    openModalNewTask(date, dayKey);
                });
            });

            populateTasksForWeek(days);
            lucide.createIcons();
        }

        function populateTasksForWeek(days) {
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
            const dateStrings = days.map(day => formatDate(day.date));

            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }
        
        function generateTimetableHTML(dayKey) {
            const subjects = timetable[dayKey];
            if (!subjects) return '<p class="text-xs text-gray-400 italic">Errore orario</p>';
            
            let htmlEntries = [];
            let i = 0;
            while (i < subjects.length) {
                let currentSubject = subjects[i];
                let startHour = 8 + i;
                
                let j = i + 1;
                while (j < subjects.length && subjects[j] === currentSubject) {
                    j++;
                }
                
                let endHour = 8 + j;
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${currentSubject}</span></p>`);
                i = j;
            }

            if (htmlEntries.length === 0) {
                return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            }
            return htmlEntries.join('\n');
        }
        
        function generateRadarHTML(dayDate) {
            const today = new Date(dayDate);
            today.setHours(0, 0, 0, 0);
            
            const relevantDeadlines = allFutureDeadlines.filter(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 14;
            });
            
            if (relevantDeadlines.length === 0) {
                return '<p class="text-xs text-gray-400 italic">Nessuna scadenza imminente</p>';
            }
            
            return relevantDeadlines.map(d => {
                const deadlineDate = new Date(d.date + 'T00:00:00');
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let daysText = `(Oggi!)`;
                if (diffDays === 1) daysText = `(Domani!)`;
                if (diffDays > 1) daysText = `(-${diffDays}gg)`;
                
                return `<p class="text-xs text-red-800 font-semibold">${daysText} <span class="font-medium">${d.description}</span></p>`;
            }).join('\n');
        }

        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return;

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500 flex-shrink-0';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer min-w-0';
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs break-words ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-shrink-0 ml-auto';
            
            const aiButton = document.createElement('button');
            aiButton.className = 'p-1 rounded-full hover:bg-blue-100';
            aiButton.innerHTML = `<span data-lucide="Sparkles" class="w-4 h-4 text-blue-500"></span>`;
            aiButton.addEventListener('click', () => handleOpenAiAssistant(id));
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.innerHTML = `<span data-lucide="Trash2" class="w-4 h-4 text-red-500"></span>`;
            deleteButton.addEventListener('click', () => handleDeleteTask(id));

            actionsDiv.appendChild(aiButton);
            actionsDiv.appendChild(deleteButton);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(actionsDiv);

            taskListContainer.appendChild(taskEl);
            lucide.createIcons({ nodes: [taskEl] });
        }
        
        
        // --- Funzioni Gestione Compiti (Tasks) ---

        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;

            const id = taskIdEl.value;
            const taskData = {
                subject: taskFormEl.subject.value,
                description: taskFormEl.description.value,
                dueDate: taskFormEl.dueDate.value,
                completed: allTasks[id]?.completed || false,
                aiChatHistory: allTasks[id]?.aiChatHistory || []
            };
            
            try {
                if (id) {
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal(taskModalEl);
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
            }
        }

        // CORREZIONE BUG: Funzione per gestire la modifica
        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;
            
            // Trova il 'dayKey' (mon, tue, ...) dalla data del compito
            const dayKey = getDayKeyFromDate(task.dueDate);
            
            // Popola il dropdown con le materie di quel giorno
            // e assicurati che la materia attuale sia selezionata
            populateSubjectDropdown(dayKey, task.subject);

            // Imposta i valori nel form
            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;
            
            // Apri il modal
            openModal(taskModalEl);
        }
        
        function populateSubjectDropdown(dayKey, currentSubject = null) {
            const subjectSelect = taskFormEl.subject;
            subjectSelect.innerHTML = '';
            
            const subjects = getSubjectsForDay(dayKey);
            
            subjectSelect.add(new Option("Scegli una materia...", ""));
            
            subjects.forEach(subject => {
                subjectSelect.add(new Option(subject, subject));
            });
            
            if (currentSubject && !subjects.includes(currentSubject)) {
                subjectSelect.add(new Option(`${currentSubject} (vecchia)`, currentSubject));
            }
        }

        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
            }
        }

        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
            }
        }

        
        // --- Funzioni Assistente AI (Chat) ---
        
        async function handleOpenAiAssistant(id) {
            const task = allTasks[id];
            if (!task) return;
            
            currentAiTaskId = id;
            currentAiChatHistory = task.aiChatHistory || [];
            
            aiChatHistoryEl.innerHTML = '';
            openModal(aiAssistantModalEl);
            
            if (currentAiChatHistory.length > 0) {
                currentAiChatHistory.forEach(msg => renderAiChatMessage(msg.role, msg.parts[0].text));
            } else {
                renderAiChatMessage("model", "...", true);
                const prompt = `Agisci come un tutor scolastico amichevole e incoraggiante. Ho questo compito:
                - Materia: ${task.subject}
                - Descrizione: ${task.description}
                Basandoti su informazioni aggiornate (usa la ricerca Google), dammi una brevissima spiegazione (massimo 2 frasi) dell'argomento principale e 3 consigli pratici e concisi per svolgerlo al meglio. Formatta la risposta in HTML semplice (paragrafi e liste).`;
                
                const initialMessage = { role: "user", parts: [{ text: prompt }] };
                currentAiChatHistory.push(initialMessage);
                
                callGeminiChatApi(true);
            }
        }
        
        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const userPrompt = aiChatInputEl.value.trim();
            if (!userPrompt || !currentAiTaskId) return;
            
            aiChatInputEl.value = '';
            renderAiChatMessage("user", userPrompt);
            
            const userMessage = { role: "user", parts: [{ text: userPrompt }] };
            currentAiChatHistory.push(userMessage);
            
            renderAiChatMessage("model", "...", true);
            
            callGeminiChatApi(true);
        }
        
        async function callGeminiChatApi(useSearch) {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: currentAiChatHistory,
                tools: useSearch ? [{ "google_search": {} }] : [],
                systemInstruction: {
                    parts: [{ text: "Agisci come un tutor scolastico amichevole, conciso e incoraggiante per uno studente di scuola media. Usa un linguaggio semplice e chiaro. Basa le tue risposte su informazioni verificate (usando la ricerca). Formatta sempre le risposte in HTML semplice (paragrafi <p>, liste <ul><li>, grassetto <strong>)." }]
                }
            };

            try {
                aiChatSendButtonEl.disabled = true;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);

                const result = await response.json();
                const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (modelResponse) {
                    const modelMessage = { role: "model", parts: [{ text: modelResponse }] };
                    currentAiChatHistory.push(modelMessage);
                    
                    removeAiChatLoading();
                    renderAiChatMessage("model", modelResponse);
                    
                    await saveAiChatHistory();
                } else {
                    throw new Error("Risposta AI non valida.");
                }

            } catch (error) {
                console.error("Errore chiamata Gemini:", error);
                removeAiChatLoading();
                renderAiChatMessage("model", "Ops, c'√® stato un errore. Riprova.");
            } finally {
                aiChatSendButtonEl.disabled = false;
            }
        }
        
        async function saveAiChatHistory() {
            if (!userId || !currentAiTaskId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", currentAiTaskId);
                await updateDoc(taskDocRef, { aiChatHistory: currentAiChatHistory });
                console.log("Cronologia chat salvata per", currentAiTaskId);
            } catch (error) {
                console.error("Errore salvataggio cronologia chat:", error);
            }
        }

        function renderAiChatMessage(role, text, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`;
            
            if (isLoading) {
                bubble.id = 'ai-loading-bubble';
                bubble.innerHTML = `<div class="loading-bubble"><div class="loading-dot bg-gray-500" style="animation-delay: 0s;"></div><div class="loading-dot bg-gray-500" style="animation-delay: 0.2s;"></div><div class="loading-dot bg-gray-500" style="animation-delay: 0.4s;"></div></div>`;
            } else {
                const safeHtml = text.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "");
                bubble.innerHTML = safeHtml;
            }
            
            aiChatHistoryEl.appendChild(bubble);
            aiChatHistoryEl.scrollTop = aiChatHistoryEl.scrollHeight;
        }

        function removeAiChatLoading() {
            const loadingBubble = document.getElementById('ai-loading-bubble');
            if (loadingBubble) loadingBubble.remove();
        }
        

        // --- Funzioni AI Planner (Chat) ---
        
        async function handleOpenAiPlanner() {
            openModal(aiPlannerModalEl);
            aiPlannerChatHistoryEl.innerHTML = '';
            currentAiPlannerChatHistory = [];
            
            renderAiPlannerChatMessage("model", "...", true);
            
            const today = new Date();
            const startOfCurrentWeek = getStartOfWeek(currentWeekStart);
            
            // Finestra estesa per i compiti
            const endOfTaskWindow = new Date(startOfCurrentWeek);
            endOfTaskWindow.setDate(startOfCurrentWeek.getDate() + 10); // Guarda 10 giorni avanti

            const relevantTasks = Object.values(allTasks).filter(task => {
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                return !task.completed && dueDate >= today && dueDate <= endOfTaskWindow;
            });
            
            const commitments = await getCommitments();
            const futureDeadlines = allFutureDeadlines;

            const todayStr = today.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            const endOfWeek = new Date(startOfCurrentWeek);
            endOfWeek.setDate(startOfCurrentWeek.getDate() + 4);

            let initialPrompt = `Agisci come un "Tutor di Pianificazione" esperto per uno studente di scuola media.
            Oggi √® ${todayStr}.
            
            REGOLA FONDAMENTALE: Un compito con "Scadenza: Marted√¨" significa che va consegnato Marted√¨ mattina. Il lavoro deve essere completato entro Luned√¨ sera. Non pianificare MAI un compito nel giorno stesso della sua scadenza.
            
            Ecco i dati:
            1. ORARIO SCOLASTICO (L-V, 8:00-14:00): ${JSON.stringify(timetable)}
            2. IMPEGNI FISSI (Sport, ecc. - Questi orari sono BLOCCATI): ${JSON.stringify(commitments)}
            3. SCADENZE FUTURE (Verifiche, Interrogazioni - Inizia a pianificare il ripasso se sono tra 7-14 giorni): ${futureDeadlines.map(d => `- ${d.description} (Scadenza: ${d.date})`).join('\n') || 'Nessuna'}
            4. COMPITI DA FARE (Non completati): ${relevantTasks.map(t => `- Materia: ${t.subject}, Descrizione: ${t.description} (Scadenza: ${t.dueDate})`).join('\n') || 'Nessuno'}
            
            OBIETTIVO:
            Crea un piano di studio realistico, pomeriggio per pomeriggio, da oggi fino a Venerd√¨ (${endOfWeek.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })}).
            - Dai priorit√† ai compiti con scadenza pi√π vicina (rispettando la REGOLA FONDAMENTALE).
            - Tieni conto degli orari bloccati dagli impegni.
            - Inserisci piccole sessioni di ripasso per le scadenze future, se opportuno.
            - Suggerisci un ordine sensato e pause.
            - Sii conciso e incoraggiante.
            - Formatta la risposta in HTML semplice (intestazioni <h3> per i giorni, liste <ul><li> per i compiti).
            - Concludi chiedendomi se voglio apportare modifiche.
            `;
            
            const initialMessage = { role: "user", parts: [{ text: initialPrompt }] };
            currentAiPlannerChatHistory.push(initialMessage);
            
            callGeminiPlannerChatApi();
        }
        
        async function handleAiPlannerChatSubmit(e) {
            e.preventDefault();
            const userPrompt = aiPlannerChatInputEl.value.trim();
            if (!userPrompt) return;
            
            aiPlannerChatInputEl.value = '';
            renderAiPlannerChatMessage("user", userPrompt);
            
            const userMessage = { role: "user", parts: [{ text: userPrompt }] };
            currentAiPlannerChatHistory.push(userMessage);
            
            renderAiPlannerChatMessage("model", "...", true);
            
            callGeminiPlannerChatApi();
        }

        async function callGeminiPlannerChatApi() {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: currentAiPlannerChatHistory,
                systemInstruction: {
                    parts: [{ text: `Sei un "Tutor di Pianificazione" esperto per uno studente di scuola media.
                    Il tuo obiettivo √® creare e modificare un piano di studio settimanale.
                    REGOLA FONDAMENTALE: Un compito con "Scadenza: Marted√¨" va finito entro Luned√¨ sera. Non pianificare MAI un compito nel giorno stesso della sua scadenza.
                    Sii amichevole, conciso e usa sempre HTML semplice (<h3>, <ul>, <li>, <strong>) per formattare i piani di studio.` }]
                }
            };

            try {
                aiPlannerChatSendButtonEl.disabled = true;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);

                const result = await response.json();
                const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (modelResponse) {
                    const modelMessage = { role: "model", parts: [{ text: modelResponse }] };
                    currentAiPlannerChatHistory.push(modelMessage);
                    
                    removeAiPlannerChatLoading();
                    renderAiPlannerChatMessage("model", modelResponse);
                } else {
                    throw new Error("Risposta AI non valida.");
                }

            } catch (error) {
                console.error("Errore chiamata Gemini Planner:", error);
                removeAiPlannerChatLoading();
                renderAiPlannerChatMessage("model", "Ops, c'√® stato un errore. Riprova.");
            } finally {
                aiPlannerChatSendButtonEl.disabled = false;
            }
        }

        function renderAiPlannerChatMessage(role, text, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model planner'}`;
            
            if (isLoading) {
                bubble.id = 'ai-planner-loading-bubble';
                bubble.innerHTML = `<div class="loading-bubble"><div class="loading-dot bg-purple-400" style="animation-delay: 0s;"></div><div class="loading-dot bg-purple-400" style="animation-delay: 0.2s;"></div><div class="loading-dot bg-purple-400" style="animation-delay: 0.4s;"></div></div>`;
            } else {
                const safeHtml = text.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "");
                bubble.innerHTML = safeHtml;
            }
            
            aiPlannerChatHistoryEl.appendChild(bubble);
            aiPlannerChatHistoryEl.scrollTop = aiPlannerChatHistoryEl.scrollHeight;
        }

        function removeAiPlannerChatLoading() {
            const loadingBubble = document.getElementById('ai-planner-loading-bubble');
            if (loadingBubble) loadingBubble.remove();
        }
        
        
        // --- Funzioni Progressi (Punto 2) ---
        
        function handleOpenProgressModal() {
            // 1. Calcola Statistiche
            const todayStr = formatDate(new Date());
            const weekDays = getWeekDays(currentWeekStart).map(d => formatDate(d.date));
            
            const allTasksArray = Object.values(allTasks);
            
            // Statistiche Giornaliere
            const todayTasks = allTasksArray.filter(t => t.dueDate === todayStr);
            const todayCompleted = todayTasks.filter(t => t.completed).length;
            dailyStatsEl.textContent = `${todayCompleted} / ${todayTasks.length}`;
            
            // Statistiche Settimanali
            const weekTasks = allTasksArray.filter(t => weekDays.includes(t.dueDate));
            const weekCompleted = weekTasks.filter(t => t.completed).length;
            weeklyStatsEl.textContent = `${weekCompleted} / ${weekTasks.length}`;
            
            // 2. Mostra Premio
            if (weekTasks.length > 0 && weekCompleted === weekTasks.length) {
                prizeSectionEl.style.display = 'block';
            } else {
                prizeSectionEl.style.display = 'none';
            }
            
            // 3. Renderizza Grafico
            renderProgressChart(weekCompleted, weekTasks.length - weekCompleted);
            
            // 4. Apri Modal
            openModal(progressModalEl);
        }
        
        function renderProgressChart(completed, pending) {
            const ctx = progressChartCanvas.getContext('2d');
            
            if (progressChartInstance) {
                progressChartInstance.destroy();
            }
            
            progressChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completati', 'Da Fare'],
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: [
                            '#22C55E', // green-500
                            '#E5E7EB'  // gray-200
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        }


        // --- Funzioni Modal (Finestre Popup) ---
        
        function openModalNewTask(defaultDate, dayKey) {
            taskFormEl.reset();
            modalTitleEl.innerText = "Nuovo Compito";
            taskIdEl.value = '';
            
            if (defaultDate) {
                taskFormEl.dueDate.value = defaultDate;
            }
            if (dayKey) {
                populateSubjectDropdown(dayKey);
            }
            openModal(taskModalEl);
        }
        
        function openModal(modalEl) {
            modalEl.style.display = 'flex';
            lucide.createIcons({ nodes: [modalEl] });
        }

        function closeModal(modalEl) {
            modalEl.style.display = 'none';
            if (modalEl === aiAssistantModalEl) {
                currentAiTaskId = null;
                currentAiChatHistory = [];
            }
            if (modalEl === aiPlannerModalEl) {
                currentAiPlannerChatHistory = [];
            }
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            openModal(confirmModalEl);
        }
        
        function closeConfirm() {
            closeModal(confirmModalEl);
            confirmCallback = null;
        }


        // --- Funzioni Utilit√† (Date, Errori) ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNamesList = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            for (let i = 0; i < 5; i++) {
                days.push({
                    name: dayNamesList[i],
                    date: new Date(d),
                    value: dayValues[i]
                });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDayKeyFromDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00'); // Usa T00:00:00 per fuso orario locale
            const dayIndex = date.getDay(); // 0=Dom, 1=Lun,...
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            return dayKeys[dayIndex];
        }

        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            
            return `${startStr} - ${endStr}`;
        }
        
        function showError(message) {
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message);
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart);
            });
            
            // Gestione Menu Dropdown
            menuToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                menuDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!menuContainer.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });
            menuDropdown.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', () => menuDropdown.classList.add('hidden'));
            });

            // Listener pulsanti del menu
            document.getElementById('openAiPlannerButton').addEventListener('click', handleOpenAiPlanner);
            document.getElementById('openCommitmentsButton').addEventListener('click', () => openModal(commitmentsModalEl));
            document.getElementById('openFutureDeadlinesButton').addEventListener('click', () => openModal(futureDeadlinesModalEl));
            document.getElementById('openTimetableButton').addEventListener('click', () => openModal(timetableModalEl));
            document.getElementById('openProgressButton').addEventListener('click', handleOpenProgressModal); // Aggiunto

            taskFormEl.addEventListener('submit', handleSaveTask);
            commitmentsFormEl.addEventListener('submit', handleSaveCommitments);
            futureDeadlineFormEl.addEventListener('submit', handleSaveFutureDeadline);
            aiChatFormEl.addEventListener('submit', handleAiChatSubmit);
            aiPlannerChatFormEl.addEventListener('submit', handleAiPlannerChatSubmit);
            
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeConfirm();
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalToClose = e.target.closest('.modal');
                    if (modalToClose) closeModal(modalToClose);
                });
            });

            initializeFirebase();
        });

    </script>
</body>
</html>
