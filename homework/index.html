<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile per la scrollbar orizzontale (sottile e grigia) */
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Stili per l'aspetto mobile-first */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none; /* Previene il "pull-to-refresh" laterale */
        }
        
        /* Contenitore per lo scorrimento orizzontale */
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory; /* Aggancia le colonne durante lo scorrimento */
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
        }

        /* Colonne dei giorni */
        .day-column {
            flex: 0 0 90%; /* Su mobile, ogni colonna occupa il 90% */
            scroll-snap-align: start; /* Aggancia l'inizio della colonna */
            margin-right: 10px;
        }

        @media (min-width: 640px) { /* sm: */
            .day-column {
                flex: 1 1 0%; /* Su schermi più grandi, si dividono lo spazio */
            }
        }
        
        /* Stili per i modal (finestre popup) */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Stili per il modal di conferma (più piccolo) */
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }

        /* Stili per i campi di input dell'orario */
        .timetable-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 6px;
            font-size: 0.875rem; /* text-sm */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .timetable-input:focus {
            outline: none;
            border-color: #3B82F6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenitore Principale -->
    <div class="flex flex-col h-screen">

        <!-- 1. Intestazione (Header) -->
        <header class="p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                <!-- Titolo e Navigazione Settimana -->
                <div class="flex items-center justify-between w-full sm:w-auto">
                    <h1 class="text-xl font-bold text-gray-800">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4">
                        <button id="prevWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <!-- Correzione: Aggiunto text-gray-600 per rendere la freccia visibile -->
                            <span data-lucide="ChevronLeft" class="w-5 h-5 text-gray-600"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-medium text-gray-600 w-28 text-center">Caricamento...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-full hover:bg-gray-100">
                            <!-- Correzione: Aggiunto text-gray-600 per rendere la freccia visibile -->
                            <span data-lucide="ChevronRight" class="w-5 h-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>
                <!-- Pulsanti Azione -->
                <div class="flex gap-2 mt-4 sm:mt-0">
                    <button id="todayBtn" class="px-4 py-2 text-base font-medium text-blue-600 bg-blue-100 rounded-lg shadow-sm hover:bg-blue-200 transition">
                        Oggi
                    </button>
                    <button id="openTimetableButton" class="px-4 py-2 text-base font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition">
                        Orario
                    </button>
                </div>
            </div>
        </header>

        <!-- Spinner di caricamento principale -->
        <div id="loadingSpinner" class="flex items-center justify-center h-full">
            <span data-lucide="Loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
        </div>

        <!-- 2. Bacheca Settimanale (Contenuto) -->
        <main id="weekGrid" class="flex-1 overflow-hidden p-3 sm:p-4">
            <!-- Contenitore con scorrimento orizzontale -->
            <div id="weekScrollContainer" class="week-scroll-container no-scrollbar h-full gap-3">
                <!-- Le colonne dei giorni (Lunedì-Venerdì) verranno generate qui da JS -->
            </div>
        </main>
    </div>

    <!-- 3. Modal (finestra popup) per Aggiungere/Modificare Compito -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4">Nuovo Compito</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <input type="text" id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Compito</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Orario Settimanale -->
    <div id="timetableModal" class="modal">
        <div class="modal-content max-w-3xl"> <!-- Reso più largo per l'orario -->
            <h2 class="text-lg font-semibold mb-4">Imposta Orario Settimanale</h2>
            <form id="timetableForm">
                <div id="timetableModalContent" class="space-y-6">
                    <!-- Gli input per l'orario verranno generati qui da JS -->
                </div>
                
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" id="closeTimetableModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Salva Orario</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 5. Modal di Conferma Eliminazione (Personalizzato) -->
    <div id="confirmModal" class="modal" style="z-index: 60;"> <!-- z-index più alto -->
        <div class="confirm-modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3">Sei sicuro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button id="confirmOk" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Elimina</button>
            </div>
        </div>
    </div>


    <!-- Firebase e Script App -->
    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali e Configurazione ---
        
        // Variabili globali per lo stato dell'app
        let db, auth;
        let userId = null;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {}; // Cache locale dei compiti
        let taskUnsubscribe = null; // Funzione per staccare il listener di Firestore
        let timetableUnsubscribe = null; // Listener per l'orario

        // Elementi UI
        const loadingSpinner = document.getElementById('loadingSpinner');
        const weekGridEl = document.getElementById('weekGrid');
        const weekScrollContainerEl = document.getElementById('weekScrollContainer');
        const currentWeekDisplayEl = document.getElementById('currentWeekDisplay');
        
        // Modal Compiti
        const modalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        const modalTitleEl = document.getElementById('modalTitle');
        const taskIdEl = document.getElementById('taskId');

        // Modal Orario
        const timetableModalEl = document.getElementById('timetableModal');
        const timetableFormEl = document.getElementById('timetableForm');
        const timetableModalContentEl = document.getElementById('timetableModalContent');
        
        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        let confirmCallback = null; // Funzione da eseguire alla conferma
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Inizializzazione Firebase ---
        
        async function initializeFirebase() {
            try {
                // Inizializza Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Attiva i log di Firestore

                // Gestisce l'autenticazione
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        // L'utente è loggato, ora possiamo caricare i suoi dati
                        await loadUserData();
                    } else {
                        // L'utente non è loggato, esegui l'autenticazione
                        console.log("Nessun utente, tentativo di autenticazione...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore di autenticazione:", authError);
                            showError("Impossibile autenticarsi. Riprova più tardi.");
                        }
                    }
                });
            } catch (e) {
                console.error("Errore Inizializzazione Firebase:", e);
                showError("Errore critico nell'avvio dell'app.");
            }
        }

        // Carica tutti i dati dell'utente (orario e compiti)
        async function loadUserData() {
            if (!userId) return;

            // Nascondi lo spinner principale
            loadingSpinner.style.display = 'none';
            weekGridEl.style.display = 'block';

            // 1. Inizializza e carica l'orario
            setupTimetableModal(); // Costruisce il modal dell'orario
            await attachTimetableListener();

            // 2. Carica i compiti (il listener viene attivato da attachTimetableListener)
            //    dopo il primo caricamento dell'orario.
        }

        // --- Funzioni Orario (NUOVA LOGICA) ---

        const timetableDays = ['mon', 'tue', 'wed', 'thu', 'fri'];
        const timetableHours = [8, 9, 10, 11, 12];
        const dayNames = { mon: 'Lunedì', tue: 'Martedì', wed: 'Mercoledì', thu: 'Giovedì', fri: 'Venerdì' };
        
        // Costruisce l'HTML per il modal dell'orario
        function setupTimetableModal() {
            let html = '';
            timetableDays.forEach(dayKey => {
                html += `<div class_="mb-4">
                    <h4 class="font-semibold mb-2 text-gray-800">${dayNames[dayKey]}</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">`;
                
                timetableHours.forEach(hour => {
                    html += `<label class="block">
                        <span class="text-xs font-medium text-gray-600">${hour}:00-${hour+1}:00</span>
                        <input type="text" id="timetable-${dayKey}-${hour}" 
                               placeholder="Materia..."
                               class="timetable-input mt-1">
                    </label>`;
                });
                
                html += `</div></div>`;
                if (dayKey !== 'fri') {
                    html += `<hr class="my-4">`;
                }
            });
            timetableModalContentEl.innerHTML = html;
        }

        // Si collega a Firestore e ascolta le modifiche all'orario
        async function attachTimetableListener() {
            if (timetableUnsubscribe) timetableUnsubscribe(); // Stacca listener precedente

            const timetableDocRef = doc(db, "artifacts", appId, "users", userId, "data", "timetable");
            
            timetableUnsubscribe = onSnapshot(timetableDocRef, (docSnap) => {
                console.log("Dati orario ricevuti:", docSnap.exists() ? docSnap.data() : "Nessun dato");
                const timetableData = docSnap.exists() ? docSnap.data() : {};
                
                // Popola il modal con i dati caricati
                timetableDays.forEach(dayKey => {
                    timetableHours.forEach(hour => {
                        const inputId = `timetable-${dayKey}-${hour}`;
                        const subject = timetableData[`${dayKey}-${hour}`] || '';
                        const inputEl = document.getElementById(inputId);
                        if (inputEl) {
                            inputEl.value = subject;
                        }
                    });
                });

                // Aggiorna la vista principale (passando i dati dell'orario)
                renderWeekDisplay(currentWeekStart, timetableData);
                
                // Ora che l'orario è caricato e renderizzato, attacca il listener dei compiti
                // Lo facciamo qui per assicurarci che la griglia sia pronta
                if (!taskUnsubscribe) {
                    attachTaskListener();
                }

            }, (error) => {
                console.error("Errore nel listener dell'orario:", error);
                showError("Impossibile caricare l'orario.");
            });
        }

        // Salva l'orario su Firestore
        async function handleSaveTimetable(e) {
            e.preventDefault();
            if (!userId) return;

            const timetableData = {};
            timetableDays.forEach(dayKey => {
                timetableHours.forEach(hour => {
                    const inputId = `timetable-${dayKey}-${hour}`;
                    timetableData[`${dayKey}-${hour}`] = document.getElementById(inputId).value.trim();
                });
            });

            try {
                const timetableDocRef = doc(db, "artifacts", appId, "users", userId, "data", "timetable");
                await setDoc(timetableDocRef, timetableData);
                console.log("Orario salvato:", timetableData);
                closeTimetableModal();
                // Il listener onSnapshot aggiornerà automaticamente la UI
            } catch (error) {
                console.error("Errore salvataggio orario:", error);
                showError("Errore nel salvataggio dell'orario.");
            }
        }
        
        // Genera l'HTML dell'orario raggruppando le ore
        function generateTimetableHTML(dayKey, timetableData = {}) {
            const hoursMap = timetableHours.map(hour => ({
                hour: hour,
                subject: timetableData[`${dayKey}-${hour}`] || null
            }));

            let htmlEntries = [];
            let i = 0;
            while (i < hoursMap.length) {
                let current = hoursMap[i];
                let subject = current.subject;
                let startHour = current.hour;

                if (subject === null) {
                    // Se l'ora è libera, salta
                    i++;
                    continue; 
                }

                let j = i + 1;
                // Guarda avanti per trovare ore consecutive con la stessa materia
                while (j < hoursMap.length && hoursMap[j].subject === subject) {
                    j++;
                }
                
                // j è ora all'indice della prima ora diversa (o alla fine)
                // L'ora finale è l'ora dell'ultimo blocco + 1
                let endHour = hoursMap[j - 1].hour + 1; 
                
                htmlEntries.push(`<p class="text-xs text-gray-800 font-semibold">${startHour}:00 - ${endHour}:00: <span class="font-medium">${subject}</span></p>`);
                
                i = j; // Salta al prossimo blocco di materie
            }

            if (htmlEntries.length === 0) {
                return '<p class="text-xs text-gray-400 italic">Nessun orario impostato</p>';
            }
            return htmlEntries.join('\n');
        }


        // --- Funzioni Gestione Compiti (Tasks) ---

        // Si collega a Firestore e ascolta le modifiche ai compiti
        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe(); // Stacca listener precedente
            
            const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
            
            taskUnsubscribe = onSnapshot(tasksCollectionRef, (querySnapshot) => {
                console.log("Dati compiti ricevuti.");
                allTasks = {}; // Svuota la cache locale
                querySnapshot.forEach((doc) => {
                    allTasks[doc.id] = doc.data();
                });
                // Ridisegna la settimana corrente con i nuovi dati
                renderWeekDisplay(currentWeekStart); 
            }, (error) => {
                console.error("Errore nel listener dei compiti:", error);
                showError("Impossibile caricare i compiti.");
            });
        }

        // Salva (o aggiorna) un compito
        async function handleSaveTask(e) {
            e.preventDefault();
            if (!userId) return;

            const id = taskIdEl.value;
            const taskData = {
                subject: taskFormEl.subject.value,
                description: taskFormEl.description.value,
                dueDate: taskFormEl.dueDate.value,
                completed: taskFormEl.querySelector(`#task-${id}`)?.dataset.completed === 'true' || false
            };
            
            try {
                if (id) {
                    // Aggiorna compito esistente
                    const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                    await updateDoc(taskDocRef, taskData);
                } else {
                    // Crea nuovo compito
                    const tasksCollectionRef = collection(db, "artifacts", appId, "users", userId, "tasks");
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal();
                // Il listener onSnapshot aggiornerà automaticamente la UI
            } catch (error) {
                console.error("Errore salvataggio compito:", error);
                showError("Impossibile salvare il compito.");
            }
        }

        // Apre il modal per modificare un compito
        function handleEditTask(id) {
            const task = allTasks[id];
            if (!task) return;

            modalTitleEl.innerText = "Modifica Compito";
            taskIdEl.value = id;
            taskFormEl.subject.value = task.subject;
            taskFormEl.description.value = task.description;
            taskFormEl.dueDate.value = task.dueDate;
            modalEl.style.display = 'flex';
        }

        // Aggiorna lo stato "completato" di un compito
        async function handleToggleTask(id, completed) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await updateDoc(taskDocRef, { completed: completed });
                // Il listener aggiornerà la UI
            } catch (error) {
                console.error("Errore aggiornamento compito:", error);
                showError("Impossibile aggiornare il compito.");
            }
        }

        // Mostra il popup di conferma prima di eliminare
        function handleDeleteTask(id) {
            showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                performDeleteTask(id);
            });
        }

        // Esegue l'eliminazione effettiva
        async function performDeleteTask(id) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, "artifacts", appId, "users", userId, "tasks", id);
                await deleteDoc(taskDocRef);
                // Il listener aggiornerà la UI
            } catch (error) {
                console.error("Errore eliminazione compito:", error);
                showError("Impossibile eliminare il compito.");
            }
        }


        // --- Funzioni di Rendering UI ---

        // Disegna l'intera griglia settimanale
        function renderWeekDisplay(startDate, timetableData = {}) {
            if (!weekScrollContainerEl) return; // Assicurati che l'elemento esista
            
            weekScrollContainerEl.innerHTML = ''; // Pulisci la griglia
            currentWeekDisplayEl.textContent = formatWeekRange(startDate);

            const days = getWeekDays(startDate); // Ottiene i 5 giorni (Lun-Ven)

            // Trova l'orario (se è già stato caricato)
            // Se timetableData è vuoto, prova a leggerlo dal modal (come fallback)
            if (Object.keys(timetableData).length === 0) {
                // Tenta di recuperare i dati correnti se il listener li ha già caricati
                const ttDocRef = doc(db, "artifacts", appId, "users", userId, "data", "timetable");
                getDoc(ttDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        timetableData = docSnap.data();
                        // Richiama il rendering, ma solo se è la prima volta
                        // Questo è un fallback, idealmente timetableData viene passato da attachTimetableListener
                    }
                });
            }

            for (const day of days) {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase().substring(0, 3); // 'mon', 'tue', ecc.
                
                // Genera l'HTML per l'orario di questo giorno
                const timetableHtml = generateTimetableHTML(dayKey, timetableData);

                const dayCard = document.createElement('div');
                dayCard.className = 'day-column bg-white rounded-xl shadow-sm p-3 flex flex-col';
                dayCard.id = `day-${dateStr}`;
                
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-base font-semibold text-gray-800">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500">${day.date.getDate()}</span>
                    </div>
                    
                    <!-- Sezione Orario -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <h3 class="font-semibold text-sm text-gray-500 mb-1">Orario</h3>
                    <div class="timetable-display mb-2 p-2 bg-gray-50 rounded-lg min-h-[40px]">
                        ${timetableHtml}
                    </div>

                    <!-- Sezione Compiti -->
                    <div class="border-t border-gray-100 my-2"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1 overflow-y-auto">
                        <!-- I compiti per questo giorno verranno inseriti qui -->
                    </div>
                `;
                weekScrollContainerEl.appendChild(dayCard);
            }
            
            // Collega gli eventi ai nuovi pulsanti "+"
            weekScrollContainerEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    openModal(date); // Passa la data alla funzione openModal
                });
            });

            // Popola i compiti
            populateTasksForWeek(days);
            
            // Inizializza le icone Lucide
            lucide.createIcons();
        }

        // Popola le liste dei compiti per la settimana visibile
        function populateTasksForWeek(days) {
            // Pulisci tutte le liste prima di ripopolare
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');

            const dateStrings = days.map(day => formatDate(day.date));

            for (const id in allTasks) {
                const task = allTasks[id];
                if (dateStrings.includes(task.dueDate)) {
                    renderTask(id, task);
                }
            }
        }

        // Disegna un singolo compito nella colonna corretta
        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) return; // Giorno non visibile

            const taskEl = document.createElement('div');
            taskEl.id = `task-${id}`;
            taskEl.dataset.completed = data.completed;
            taskEl.className = `p-2.5 rounded-lg border flex items-center gap-3 transition ${data.completed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500';
            checkbox.addEventListener('change', (e) => {
                handleToggleTask(id, e.target.checked);
            });

            // Contenuto (Materia + Descrizione)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1 cursor-pointer';
            contentDiv.innerHTML = `
                <p class="font-semibold text-sm ${data.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${data.subject}</p>
                <p class="text-xs ${data.completed ? 'text-green-600 line-through' : 'text-gray-600'}">${data.description}</p>
            `;
            contentDiv.addEventListener('click', () => handleEditTask(id));
            
            // Pulsante Elimina
            const deleteButton = document.createElement('button');
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100 ml-auto';
            deleteButton.addEventListener('click', () => handleDeleteTask(id));
            
            // Icona SVG (metodo robusto)
            const trashIconSpan = document.createElement('span');
            trashIconSpan.setAttribute('data-lucide', 'Trash2');
            trashIconSpan.setAttribute('class', 'text-red-500 hover:text-red-700');
            trashIconSpan.setAttribute('width', 16);
            trashIconSpan.setAttribute('height', 16);
            deleteButton.appendChild(trashIconSpan);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(deleteButton);

            taskListContainer.appendChild(taskEl);
            
            // Chiede a Lucide di renderizzare l'icona appena aggiunta
            lucide.createIcons({ nodes: [taskEl] });
        }


        // --- Funzioni Modal (Finestre Popup) ---

        // Apre il modal dei compiti (con data pre-impostata)
        function openModal(defaultDate = null) {
            taskFormEl.reset();
            modalTitleEl.innerText = "Nuovo Compito";
            taskIdEl.value = '';
            
            if (defaultDate) {
                taskFormEl.dueDate.value = defaultDate;
            } else {
                // Fallback (non dovrebbe servire con i nuovi pulsanti +)
                taskFormEl.dueDate.value = formatDate(new Date());
            }
            
            modalEl.style.display = 'flex';
        }

        function closeModal() {
            modalEl.style.display = 'none';
        }
        
        function openTimetableModal() {
            timetableModalEl.style.display = 'flex';
        }
        
        function closeTimetableModal() {
            timetableModalEl.style.display = 'none';
        }
        
        // Apre il modal di conferma
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = callback;
            confirmModalEl.style.display = 'flex';
        }
        
        function closeConfirm() {
            confirmModalEl.style.display = 'none';
            confirmCallback = null;
        }


        // --- Funzioni Utilità (Date, Errori) ---

        // Trova il Lunedì della settimana corrente
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Domenica, 1 = Lunedì, ...
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Se è Dom (0), vai indietro di 6, altrimenti vai a Lun (1)
            return new Date(d.setDate(diff));
        }

        // Ritorna un array di 5 oggetti {name, date, value} da Lunedì a Venerdì
        function getWeekDays(startDate) {
            const days = [];
            const d = new Date(startDate);
            const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'];
            const dayValues = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            for (let i = 0; i < 5; i++) {
                days.push({
                    name: dayNames[i],
                    date: new Date(d),
                    value: dayValues[i]
                });
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        // Formatta una data come "YYYY-MM-DD"
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Formatta l'intestazione della settimana (es. "10 Nov - 14 Nov")
        function formatWeekRange(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4); // 4 giorni dopo Lunedì è Venerdì
            
            const startStr = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            
            return `${startStr} - ${endStr}`;
        }
        
        // Mostra un semplice messaggio di errore (da migliorare)
        function showError(message) {
            // Sostituisce lo spinner con un errore se il caricamento fallisce
            if(loadingSpinner.style.display !== 'none') {
                loadingSpinner.innerHTML = `<div class="text-center text-red-600">
                    <span data-lucide="AlertTriangle" class="w-12 h-12 mx-auto"></span>
                    <p class="mt-2">${message}</p>
                </div>`;
                lucide.createIcons();
            }
            console.error(message); // Logga anche in console
        }

        // --- Collegamento Eventi UI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione Settimana
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekDisplay(currentWeekStart); // Ridisegna con la cache locale (veloce)
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekDisplay(currentWeekStart); // Ridisegna con la cache locale (veloce)
            });
            
            // Pulsante Oggi (Aggiunto)
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentWeekStart = getStartOfWeek(new Date());
                renderWeekDisplay(currentWeekStart);
                // Assicurati che l'icona venga renderizzata se ne avessi aggiunta una
                lucide.createIcons();
            });

            // Modal Compiti
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            taskFormEl.addEventListener('submit', handleSaveTask);

            // Modal Orario
            document.getElementById('openTimetableButton').addEventListener('click', openTimetableModal);
            document.getElementById('closeTimetableModalButton').addEventListener('click', closeTimetableModal);
            timetableFormEl.addEventListener('submit', handleSaveTimetable);
            
            // Modal Conferma
            document.getElementById('confirmCancel').addEventListener('click', closeConfirm);
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirm();
            });

            // Avvia l'app
            initializeFirebase();
        });

    </script>
</body>
</html>
