<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <!-- Viewport ottimizzato per iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bacheca Compiti Settimana</title>

    <!-- Meta tags per iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Compiti">
    <meta name="theme-color" content="#3B82F6">

    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3238/3238016.png">

    <!-- Librerie Esterne (Versioni Fisse) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.460.0/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-x: none;
            background-color: #f9fafb;
            -webkit-tap-highlight-color: transparent;
        }

        /* FIX TASTIERA IPHONE */
        input, textarea, select {
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        
        .week-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            gap: 0.75rem;
            padding-bottom: 20px;
        }

        .day-column {
            flex: 0 0 100%;
            scroll-snap-align: start;
        }

        @media (min-width: 640px) {
            .day-column { flex: 1 1 0%; }
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .confirm-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 16px;
            width: 85%;
            max-width: 320px;
            text-align: center;
        }
        
        /* Chat UI */
        .chat-container {
            height: 350px;
            overflow-y: auto;
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            -webkit-overflow-scrolling: touch;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .chat-bubble-user {
            background-color: #3B82F6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-model {
            background-color: #E5E7EB;
            color: #1F2937;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-model.planner {
            background-color: #F3E8FF;
            color: #3730A3;
        }
        .loading-bubble { display: flex; gap: 4px; align-items: center; padding: 4px 8px; }
        .loading-dot {
            width: 6px; height: 6px; border-radius: 50%; animation: pulse 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Table */
        #timetableModalTable {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        #timetableModalTable table { width: 100%; min-width: 600px; border-collapse: collapse; }
        #timetableModalTable th, #timetableModalTable td {
            border: 1px solid #E5E7EB; padding: 10px; text-align: left; font-size: 0.875rem;
        }
        #timetableModalTable th { background-color: #F9FAFB; }
        #timetableModalTable tbody tr:nth-child(odd) { background-color: #F9FAFB; }
        
        /* Prize */
        #prizeSection {
            display: none; text-align: center; padding: 20px;
            background: linear-gradient(145deg, #fef9c3, #fafad2);
            border: 2px dashed #facc15; border-radius: 12px; margin-top: 20px;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-full">

    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="p-4 bg-slate-100 border-b border-gray-200 sticky top-0 z-30 shadow-sm flex-shrink-0">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-yellow-300 bg-blue-600 px-3 py-1 rounded-lg shadow-md">Bacheca Compiti</h1>
                    <div class="flex items-center ml-4 gap-2">
                        <button id="prevWeekBtn" class="p-2 rounded-lg bg-white border border-gray-300 shadow-sm hover:bg-gray-50 active:bg-gray-100 transition-colors">
                            <span data-lucide="chevron-left" class="w-5 h-5 text-gray-700"></span>
                        </button>
                        <span id="currentWeekDisplay" class="text-sm font-bold text-gray-700 w-28 text-center bg-white py-2 rounded-lg border border-gray-200 shadow-sm">...</span>
                        <button id="nextWeekBtn" class="p-2 rounded-lg bg-white border border-gray-300 shadow-sm hover:bg-gray-50 active:bg-gray-100 transition-colors">
                            <span data-lucide="chevron-right" class="w-5 h-5 text-gray-700"></span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <div class="relative" id="menuContainer">
                        <button id="menuToggleBtn" class="p-2 rounded-lg bg-white border border-gray-300 shadow-sm hover:bg-gray-50 transition-colors">
                            <span data-lucide="menu" class="w-5 h-5 text-gray-700"></span>
                        </button>
                        <div id="menuDropdown" class="hidden absolute right-0 top-12 mt-2 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 overflow-hidden ring-1 ring-black ring-opacity-5">
                            <a id="openStudentInfoButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 border-b">
                                <span data-lucide="user-circle" class="w-5 h-5 text-blue-500"></span> Info Studente
                            </a>
                            <a id="openAiPlannerButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="brain-circuit" class="w-5 h-5 text-purple-600"></span> AI Planner
                            </a>
                            <a id="openCommitmentsButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="calendar-clock" class="w-5 h-5 text-green-600"></span> Impegni
                            </a>
                            <a id="openFutureDeadlinesButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="target" class="w-5 h-5 text-red-600"></span> Scadenze Future
                            </a>
                            <a id="openTimetableButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100">
                                <span data-lucide="book-open" class="w-5 h-5 text-blue-600"></span> Orario
                            </a>
                            <a id="openProgressButton" href="#" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 border-t">
                                <span data-lucide="pie-chart" class="w-5 h-5 text-yellow-600"></span> Progressi
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="notificationBanner" class="hidden sticky top-[73px] z-20 shadow-md bg-yellow-100 border-b border-yellow-200"></div>

        <div id="loadingSpinner" class="flex items-center justify-center h-full flex-1">
            <div class="text-center">
                <span data-lucide="loader" class="w-12 h-12 text-blue-500 animate-spin mx-auto"></span>
                <p class="mt-2 text-gray-500">Caricamento...</p>
            </div>
        </div>

        <main id="weekGrid" class="hidden flex-1 overflow-hidden p-3 sm:p-4 bg-gray-50">
            <div id="weekScrollContainer" class="week-scroll-container h-full"></div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Task Modal -->
    <div id="taskModal" class="modal"><div class="modal-content">
        <h2 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800">Nuovo Compito</h2>
        <form id="taskForm" class="flex flex-col gap-4 h-full">
            <input type="hidden" id="taskId">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Materia</label><select id="subject" class="w-full px-3 py-3 border border-gray-300 rounded-xl shadow-sm bg-white" required></select></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label><textarea id="description" rows="4" class="w-full px-3 py-3 border border-gray-300 rounded-xl shadow-sm" required></textarea></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label><input type="date" id="dueDate" class="w-full px-3 py-3 border border-gray-300 rounded-xl shadow-sm" required></div>
            <div class="flex justify-end gap-3 mt-auto pt-4">
                <button type="button" class="close-modal-btn px-5 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-xl">Annulla</button>
                <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-xl shadow-md">Salva</button>
            </div>
        </form>
    </div></div>

    <!-- Timetable Modal -->
    <div id="timetableModal" class="modal"><div class="modal-content max-w-3xl">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Orario Settimanale</h2>
        <div id="timetableModalTable" class="rounded-lg border border-gray-200 overflow-hidden"></div>
        <div class="flex justify-end mt-6"><button type="button" class="close-modal-btn px-5 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-xl">Chiudi</button></div>
    </div></div>
    
    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal" style="z-index: 60;"><div class="confirm-modal-content">
        <h3 id="confirmTitle" class="text-lg font-bold mb-2 text-gray-900">Sei sicuro?</h3>
        <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Vuoi davvero eliminare questo elemento?</p>
        <div class="flex justify-center gap-3">
            <button id="confirmCancel" class="px-4 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-xl flex-1">No</button>
            <button id="confirmOk" class="px-4 py-2.5 bg-red-600 text-white font-medium rounded-xl shadow flex-1">S√¨, elimina</button>
        </div>
    </div></div>

    <!-- AI Assistant Modal -->
    <div id="aiAssistantModal" class="modal"><div class="modal-content flex flex-col h-[80vh]">
        <h2 class="text-lg font-bold mb-2 flex items-center gap-2 text-blue-600 border-b pb-2"><span data-lucide="sparkles" class="w-5 h-5"></span> Assistente AI</h2>
        <div id="aiChatHistory" class="chat-container flex-1 mb-3"></div>
        <form id="aiChatForm" class="flex gap-2 mt-auto">
            <input type="text" id="aiChatInput" placeholder="Chiedi..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl shadow-sm" required>
            <button type="submit" id="aiChatSendButton" class="p-3 bg-blue-600 text-white rounded-xl shadow"><span data-lucide="send" class="w-5 h-5"></span></button>
        </form>
        <div class="flex justify-end mt-3"><button type="button" class="close-modal-btn text-sm text-gray-500 px-2">Chiudi</button></div>
    </div></div>
    
    <!-- AI Planner Modal -->
    <div id="aiPlannerModal" class="modal"><div class="modal-content flex flex-col h-[80vh] max-w-2xl">
        <h2 class="text-lg font-bold mb-2 flex items-center gap-2 text-purple-600 border-b pb-2"><span data-lucide="brain-circuit" class="w-5 h-5"></span> Piano di Studio AI</h2>
        <div id="aiPlannerChatHistory" class="chat-container flex-1 mb-3"></div>
        <form id="aiPlannerChatForm" class="flex gap-2 mt-auto">
            <input type="text" id="aiPlannerChatInput" placeholder="Modifica il piano..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl shadow-sm" required>
            <button type="submit" id="aiPlannerChatSendButton" class="p-3 bg-purple-600 text-white rounded-xl shadow"><span data-lucide="send" class="w-5 h-5"></span></button>
        </form>
        <div class="flex justify-end mt-3"><button type="button" class="close-modal-btn text-sm text-gray-500 px-2">Chiudi</button></div>
    </div></div>
    
    <!-- Commitments Modal -->
    <div id="commitmentsModal" class="modal"><div class="modal-content max-w-xl">
        <h2 class="text-xl font-bold mb-4 text-green-700">Impegni Settimanali</h2>
        <p class="text-sm text-gray-500 mb-4">Inserisci i tuoi impegni fissi.</p>
        <form id="commitmentsForm">
            <div id="commitmentsModalContent" class="space-y-3 max-h-[50vh] overflow-y-auto pr-1"></div>
            <div class="flex justify-end gap-2 mt-6 pt-4 border-t">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl">Annulla</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white font-medium rounded-xl shadow">Salva</button>
            </div>
        </form>
    </div></div>

    <!-- Future Deadlines Modal -->
    <div id="futureDeadlinesModal" class="modal"><div class="modal-content max-w-2xl">
        <h2 class="text-xl font-bold mb-4 text-red-600">Radar Scadenze Future</h2>
        <form id="futureDeadlineForm" class="flex flex-col sm:flex-row gap-3 mb-6 pb-6 border-b">
            <input type="text" id="futureDeadlineDescription" placeholder="Es. Verifica Latino" class="flex-1 px-3 py-2 border border-gray-300 rounded-xl" required>
            <input type="date" id="futureDeadlineDate" class="px-3 py-2 border border-gray-300 rounded-xl" required>
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-xl shadow font-bold">Aggiungi</button>
        </form>
        <div id="futureDeadlinesList" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div>
        <div class="flex justify-end mt-4 pt-4 border-t"><button type="button" class="close-modal-btn px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl">Chiudi</button></div>
    </div></div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal"><div class="modal-content">
        <h2 class="text-xl font-bold mb-6 text-yellow-600 flex items-center justify-center gap-2"><span data-lucide="pie-chart" class="w-6 h-6"></span> Progressi</h2>
        <div class="grid grid-cols-1 gap-4 mb-4">
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-1">Per Domani</h3>
                <p class="text-xs text-blue-600 mb-1">Compiti completati (scadenza domani)</p>
                <p id="dailyStats" class="text-3xl font-black text-blue-900">0 / 0</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100">
                <h3 class="text-xs font-bold text-purple-800 uppercase tracking-wider mb-1">Questa Settimana</h3>
                <p class="text-xs text-purple-600 mb-1">Totale completato</p>
                <p id="weeklyStats" class="text-3xl font-black text-purple-900">0 / 0</p>
            </div>
        </div>
        <div class="flex justify-center mb-4 pt-2"><div class="w-40 h-40 relative"><canvas id="progressChart"></canvas></div></div>
        <div id="prizeSection" class="mt-4"><div class="text-4xl mb-1">üèÜ</div><h3 class="text-lg font-bold text-yellow-800">Grandioso!</h3><p class="text-yellow-700 text-sm">Settimana completata!</p></div>
        <div class="flex justify-end mt-6"><button type="button" class="close-modal-btn px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl">Chiudi</button></div>
    </div></div>
    
    <!-- Student Info Modal -->
    <div id="studentInfoModal" class="modal"><div class="modal-content max-w-lg">
        <h2 class="text-xl font-bold mb-4 text-blue-800 flex items-center gap-2"><span data-lucide="user-circle" class="w-6 h-6"></span> Profilo Studente</h2>
        <form id="studentInfoForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label><input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-xl" required></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cognome</label><input type="text" id="studentSurname" class="w-full px-3 py-2 border border-gray-300 rounded-xl" required></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Et√†</label><input type="number" id="studentAge" class="w-full px-3 py-2 border border-gray-300 rounded-xl" required></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sesso</label><select id="studentGender" class="w-full px-3 py-2 border border-gray-300 rounded-xl bg-white"><option value="Femmina">Femmina</option><option value="Maschio">Maschio</option><option value="Altro">Altro</option></select></div>
            </div>
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Scuola</label><input type="text" id="studentSchool" class="w-full px-3 py-2 border border-gray-300 rounded-xl"></div>
            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Classe</label><input type="text" id="studentClass" class="w-full px-3 py-2 border border-gray-300 rounded-xl"></div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" class="close-modal-btn px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl">Annulla</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-xl shadow-lg">Salva Profilo</button>
            </div>
        </form>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId;
        let currentWeekStart = getStartOfWeek(new Date());
        let allTasks = {}, allFutureDeadlines = [], localCommitments = {}, localStudentInfo = {};
        let taskUnsubscribe, commitmentUnsubscribe, futureDeadlinesUnsubscribe, studentInfoUnsubscribe;
        let currentAiChatHistory = [], currentAiTaskId = null, currentAiPlannerChatHistory = [], confirmCallback = null, progressChartInstance = null;

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBV6ibBLVIaJn__AK8tokn8wtwRBC9eDwc",
          authDomain: "homework-98001.firebaseapp.com",
          projectId: "homework-98001",
          storageBucket: "homework-98001.firebasestorage.app",
          messagingSenderId: "262210380418",
          appId: "1:262210380418:web:807be6bcddb8a3cb720a9b",
          measurementId: "G-GXB43QLXN3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const timetable = { mon: ["Latino", "Matematica", "Matematica", "Inglese", "Italiano"], tue: ["Italiano", "Motoria", "Matematica", "Matematica", "Italiano", "Scienze"], wed: ["Inglese", "Latino", "Italiano", "Arte", "Matematica"], thu: ["Scienze", "Italiano", "Italiano", "Religione", "Matematica", "Arte"], fri: ["Latino", "Matematica", "Italiano", "Inglese", "Motoria"] };
        const dayNames = { mon: 'Luned√¨', tue: 'Marted√¨', wed: 'Mercoled√¨', thu: 'Gioved√¨', fri: 'Venerd√¨' };
        const hourSlots = ["8:00", "9:00", "10:00", "11:00", "12:00", "13:00"];

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); setLogLevel('error');
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; await loadAllUserData(); } 
                    else { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); }
                });
            } catch (e) { alert("Err: " + e.message); }
        }

        async function loadAllUserData() {
            if (!userId) return;
            document.getElementById('loadingSpinner').style.display = 'none'; 
            document.getElementById('weekGrid').classList.remove('hidden');
            setupTimetableModal(); setupCommitmentsModal();
            attachTaskListener(); attachCommitmentListener(); attachFutureDeadlinesListener(); attachStudentInfoListener();
            renderWeekDisplay(currentWeekStart);
        }

        function attachTaskListener() {
            if (taskUnsubscribe) taskUnsubscribe();
            taskUnsubscribe = onSnapshot(collection(db, "artifacts", appId, "users", userId, "tasks"), (snap) => {
                allTasks = {}; snap.forEach(d => allTasks[d.id] = { id: d.id, ...d.data() });
                renderWeekDisplay(currentWeekStart);
            });
        }
        function attachCommitmentListener() {
            if (commitmentUnsubscribe) commitmentUnsubscribe();
            commitmentUnsubscribe = onSnapshot(doc(db, "artifacts", appId, "users", userId, "data", "commitments"), (snap) => {
                localCommitments = snap.exists() ? snap.data() : {};
                Object.keys(dayNames).forEach(k => { const i = document.getElementById(`commitment-${k}`); if(i) i.value = localCommitments[k] || ''; });
                renderWeekDisplay(currentWeekStart);
            });
        }
        function attachStudentInfoListener() {
            if (studentInfoUnsubscribe) studentInfoUnsubscribe();
            studentInfoUnsubscribe = onSnapshot(doc(db, "artifacts", appId, "users", userId, "data", "student_info"), (snap) => {
                localStudentInfo = snap.exists() ? snap.data() : {};
                document.getElementById('studentName').value = localStudentInfo.name || '';
                document.getElementById('studentSurname').value = localStudentInfo.surname || '';
                document.getElementById('studentAge').value = localStudentInfo.age || '';
                document.getElementById('studentGender').value = localStudentInfo.gender || 'Femmina';
                document.getElementById('studentSchool').value = localStudentInfo.school || '';
                document.getElementById('studentClass').value = localStudentInfo.classRoom || '';
            });
        }
        function attachFutureDeadlinesListener() {
            if (futureDeadlinesUnsubscribe) futureDeadlinesUnsubscribe();
            futureDeadlinesUnsubscribe = onSnapshot(collection(db, "artifacts", appId, "users", userId, "future_deadlines"), (snap) => {
                allFutureDeadlines = []; snap.forEach(d => allFutureDeadlines.push({ id: d.id, ...d.data() }));
                allFutureDeadlines.sort((a, b) => new Date(a.date) - new Date(b.date));
                renderFutureDeadlinesList(); renderNotificationBanner(); renderWeekDisplay(currentWeekStart);
            });
        }

        function setupTimetableModal() {
            const t = document.getElementById('timetableModalTable');
            let h = '<table><thead><tr><th>Ora</th>';
            Object.values(dayNames).forEach(n => h += `<th>${n}</th>`); h += '</tr></thead><tbody>';
            hourSlots.forEach((hr, i) => {
                h += `<tr><td><strong>${hr}</strong></td>`;
                Object.keys(dayNames).forEach(k => h += `<td>${timetable[k][i] || '---'}</td>`);
                h += '</tr>';
            });
            t.innerHTML = h + '</tbody></table>';
        }
        function setupCommitmentsModal() {
            const c = document.getElementById('commitmentsModalContent');
            let h = '';
            Object.keys(dayNames).forEach(k => h += `<div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">${dayNames[k]}</label><input type="text" id="commitment-${k}" class="w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>`);
            c.innerHTML = h;
        }

        function renderWeekDisplay(startDate) {
            const cont = document.getElementById('weekScrollContainer');
            if (!cont || !userId) return;
            cont.innerHTML = '';
            document.getElementById('currentWeekDisplay').textContent = formatWeekRange(startDate);
            const days = getWeekDays(startDate);
            const todayStr = formatDate(new Date());

            days.forEach(day => {
                const dateStr = formatDate(day.date);
                const dayKey = day.value.toLowerCase();
                const isToday = dateStr === todayStr;
                const div = document.createElement('div');
                div.className = `day-column bg-white rounded-2xl shadow-sm p-4 flex flex-col border ${isToday ? 'border-2 border-blue-500' : 'border-gray-200'}`;
                div.id = `day-${dateStr}`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold ${isToday ? 'text-blue-700' : 'text-gray-800'}">${day.name}</h2>
                        <span class="text-sm font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-lg">${day.date.getDate()}</span>
                    </div>
                    <div class="radar-container mb-3 space-y-1">${generateRadarHTML(day.date)}</div>
                    <div class="mb-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Orario</div><div class="bg-gray-50 p-2 rounded-lg text-xs text-gray-700 leading-relaxed">${generateTimetableHTML(dayKey)}</div></div>
                    <div class="mb-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Impegni</div><div class="bg-green-50 p-2 rounded-lg text-xs text-green-800 font-medium">${localCommitments[dayKey] || 'Nessuno'}</div></div>
                    <hr class="border-gray-100 my-2">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-gray-700">Compiti</h3><button class="add-task-btn p-1.5 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition" data-date="${dateStr}" data-daykey="${dayKey}"><span data-lucide="plus" class="w-5 h-5"></span></button></div>
                    <div id="task-list-${dateStr}" class="flex-1 space-y-2 overflow-y-auto"></div>`;
                cont.appendChild(div);
            });

            cont.querySelectorAll('.add-task-btn').forEach(b => b.addEventListener('click', (e) => openModalNewTask(e.currentTarget.dataset.date, e.currentTarget.dataset.daykey)));
            populateTasksForWeek(days);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function populateTasksForWeek(days) {
            const dateMap = days.map(d => formatDate(d.date));
            Object.values(allTasks).forEach(task => { if (dateMap.includes(task.dueDate)) renderTask(task); });
        }
        function renderTask(task) {
            const c = document.getElementById(`task-list-${task.dueDate}`);
            if (!c) return;
            const d = document.createElement('div');
            d.className = `p-3 rounded-xl border flex items-start gap-3 transition ${task.completed ? 'bg-green-50 border-green-200 opacity-75' : 'bg-white border-gray-200 shadow-sm hover:border-blue-300'}`;
            d.innerHTML = `<input type="checkbox" class="mt-1 w-5 h-5 rounded text-blue-600 border-gray-300 focus:ring-blue-500 cursor-pointer" ${task.completed ? 'checked' : ''}>
                <div class="flex-1 min-w-0 cursor-pointer task-content"><p class="font-bold text-sm truncate ${task.completed ? 'text-green-800 line-through' : 'text-gray-800'}">${task.subject}</p><p class="text-xs text-gray-600 break-words ${task.completed ? 'line-through' : ''}">${task.description}</p></div>
                <div class="flex flex-col gap-1"><button class="ai-btn p-1.5 rounded-lg bg-blue-50 text-blue-500 hover:bg-blue-100"><span data-lucide="sparkles" class="w-4 h-4"></span></button><button class="del-btn p-1.5 rounded-lg bg-red-50 text-red-500 hover:bg-red-100"><span data-lucide="trash-2" class="w-4 h-4"></span></button></div>`;
            d.querySelector('input').addEventListener('change', (e) => handleToggleTask(task.id, e.target.checked));
            d.querySelector('.task-content').addEventListener('click', () => handleEditTask(task.id));
            d.querySelector('.ai-btn').addEventListener('click', () => handleOpenAiAssistant(task.id));
            d.querySelector('.del-btn').addEventListener('click', () => handleDeleteTask(task.id));
            c.appendChild(d);
        }
        
        function generateTimetableHTML(dayKey) {
            const subs = timetable[dayKey]; if(!subs) return '-';
            let h=[], i=0; while(i<subs.length){ let s=subs[i], j=i+1; while(j<subs.length && subs[j]===s)j++; h.push(`${8+i}:00-${8+j}:00 <b>${s}</b>`); i=j; }
            return h.join('<br>');
        }
        function generateRadarHTML(dayDate) {
            const t=new Date(dayDate); t.setHours(0,0,0,0);
            return allFutureDeadlines.filter(d=>{ const diff=Math.ceil((new Date(d.date+'T00:00:00')-t)/86400000); return diff>=0 && diff<=14; }).map(d=>{ const diff=Math.ceil((new Date(d.date+'T00:00:00')-t)/86400000); return `<div class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200 mb-1 font-bold">‚ö†Ô∏è ${diff===0?'OGGI':diff===1?'DOMANI':`-${diff}gg`}: ${d.description}</div>`; }).join('');
        }
        function renderFutureDeadlinesList() {
            const l = document.getElementById('futureDeadlinesList');
            l.innerHTML = allFutureDeadlines.map(d => `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border mb-2"><div><p class="font-bold text-sm">${d.description}</p><p class="text-xs text-gray-500">${new Date(d.date).toLocaleDateString()}</p></div><button class="del-future p-2 text-red-500" data-id="${d.id}"><span data-lucide="trash-2" class="w-4 h-4"></span></button></div>`).join('') || '<p class="text-center text-gray-400 py-4">Nessuna</p>';
            l.querySelectorAll('.del-future').forEach(b => b.addEventListener('click', () => handleDeleteFutureDeadline(b.dataset.id)));
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        function renderNotificationBanner() {
            const today = new Date(); today.setHours(0,0,0,0);
            const up = allFutureDeadlines.filter(d => { const diff = Math.ceil((new Date(d.date+'T00:00:00') - today)/86400000); return diff >= 0 && diff <= 21; });
            const b = document.getElementById('notificationBanner');
            if (up.length === 0) { b.style.display = 'none'; return; }
            b.innerHTML = `<div class="max-w-7xl mx-auto p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 flex justify-between items-center"><div class="flex items-center gap-3"><span data-lucide="alert-triangle" class="w-5 h-5"></span><p class="text-sm"><strong>Attenzione:</strong> Hai ${up.length} scadenz${up.length>1?'e':'a'} in arrivo!</p></div><button id="closeNotificationBtn" class="p-1 hover:bg-yellow-200 rounded-full"><span data-lucide="x" class="w-4 h-4"></span></button></div>`;
            b.style.display = 'block';
            document.getElementById('closeNotificationBtn').addEventListener('click', () => b.style.display = 'none');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function handleSaveTask(e) {
            e.preventDefault(); if (!userId) return;
            const id = document.getElementById('taskId').value;
            const d = { subject: document.getElementById('subject').value, description: document.getElementById('description').value, dueDate: document.getElementById('dueDate').value, completed: id ? allTasks[id].completed : false, aiChatHistory: id ? (allTasks[id].aiChatHistory || []) : [] };
            if(id) await updateDoc(doc(db, "artifacts", appId, "users", userId, "tasks", id), d);
            else await addDoc(collection(db, "artifacts", appId, "users", userId, "tasks"), d);
            closeModal(document.getElementById('taskModal'));
        }
        function handleEditTask(id) {
            const t = allTasks[id]; if (!t) return;
            populateSubjectDropdown(getDayKeyFromDate(t.dueDate));
            document.getElementById('taskId').value = id; document.getElementById('subject').value = t.subject; document.getElementById('description').value = t.description; document.getElementById('dueDate').value = t.dueDate;
            document.getElementById('modalTitle').innerText = "Modifica Compito"; openModal(document.getElementById('taskModal'));
        }
        async function handleToggleTask(id, val) { await updateDoc(doc(db, "artifacts", appId, "users", userId, "tasks", id), { completed: val }); }
        function handleDeleteTask(id) { confirmCallback = async () => await deleteDoc(doc(db, "artifacts", appId, "users", userId, "tasks", id)); openModal(document.getElementById('confirmModal')); }
        async function handleSaveFutureDeadline(e) {
            e.preventDefault(); if (!userId) return;
            await addDoc(collection(db, "artifacts", appId, "users", userId, "future_deadlines"), { description: document.getElementById('futureDeadlineDescription').value, date: document.getElementById('futureDeadlineDate').value });
            document.getElementById('futureDeadlineForm').reset();
        }
        async function handleDeleteFutureDeadline(id) { confirmCallback = async () => await deleteDoc(doc(db, "artifacts", appId, "users", userId, "future_deadlines", id)); openModal(document.getElementById('confirmModal')); }
        
        async function handleOpenAiAssistant(id) {
            const t = allTasks[id]; if (!t) return;
            currentAiTaskId = id; currentAiChatHistory = t.aiChatHistory || [];
            const el = document.getElementById('aiChatHistory'); el.innerHTML = '';
            openModal(document.getElementById('aiAssistantModal'));
            if (currentAiChatHistory.length > 0) currentAiChatHistory.forEach(m => renderAiChatMessage(m.role, m.parts[0].text));
            else { renderAiChatMessage("model", "...", true); callGeminiChatApi(true); }
        }
        async function handleAiChatSubmit(e) {
            e.preventDefault(); const i = document.getElementById('aiChatInput'); const t = i.value.trim(); if (!t) return;
            i.value = ''; renderAiChatMessage("user", t); currentAiChatHistory.push({ role: "user", parts: [{ text: t }] }); renderAiChatMessage("model", "...", true); callGeminiChatApi(true);
        }
        async function callGeminiChatApi(search) {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE"; 
            const info = localStudentInfo;
            const sys = `Agisci come tutor per ${info.name||'studente'} (${info.classRoom||'?'}). Usa HTML semplice.`;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: currentAiChatHistory, tools: search?[{"google_search":{}}]:[], systemInstruction: {parts:[{text:sys}]} }) });
                const j = await r.json(); const txt = j.candidates?.[0]?.content?.parts?.[0]?.text;
                removeAiChatLoading(); if(txt) { renderAiChatMessage("model", txt); currentAiChatHistory.push({ role: "model", parts: [{ text: txt }] }); await updateDoc(doc(db, "artifacts", appId, "users", userId, "tasks", currentAiTaskId), { aiChatHistory: currentAiChatHistory }); }
            } catch(e) { removeAiChatLoading(); renderAiChatMessage("model", "Errore."); }
        }
        function renderAiChatMessage(role, text, load=false) {
            const b = document.createElement('div'); b.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`;
            b.innerHTML = load ? '<div class="loading-bubble"><div class="loading-dot bg-gray-400"></div><div class="loading-dot bg-gray-400"></div><div class="loading-dot bg-gray-400"></div></div>' : text.replace(/\n/g, '<br>');
            const c = document.getElementById('aiChatHistory'); c.appendChild(b); c.scrollTop = c.scrollHeight;
        }
        function removeAiChatLoading() { const l = document.getElementById('ai-loading-bubble'); if(l) l.remove(); }

        async function handleOpenAiPlanner() {
            openModal(document.getElementById('aiPlannerModal'));
            const el = document.getElementById('aiPlannerChatHistory'); el.innerHTML = ''; currentAiPlannerChatHistory = [];
            renderAiPlannerChatMessage("model", "...", true);
            const today = new Date(); const start = getStartOfWeek(currentWeekStart); const end = new Date(start); end.setDate(start.getDate()+10);
            const tasks = Object.values(allTasks).filter(t => { const d = new Date(t.dueDate+'T00:00:00'); return !t.completed && d >= today && d <= end; });
            const prompt = `Tutor ${localStudentInfo.name||''} (${localStudentInfo.classRoom||''}). Piano oggi->venerd√¨. Orario: ${JSON.stringify(timetable)}. Impegni: ${JSON.stringify(localCommitments)}. Scadenze: ${JSON.stringify(allFutureDeadlines)}. Compiti: ${JSON.stringify(tasks)}. Usa HTML semplice.`;
            currentAiPlannerChatHistory.push({ role: "user", parts: [{ text: prompt }] });
            callGeminiPlannerChatApi();
        }
        async function handleAiPlannerChatSubmit(e) {
            e.preventDefault(); const i = document.getElementById('aiPlannerChatInput'); const t = i.value.trim(); if(!t) return;
            i.value=''; renderAiPlannerChatMessage("user", t); currentAiPlannerChatHistory.push({ role: "user", parts: [{ text: t }] }); renderAiPlannerChatMessage("model", "...", true); callGeminiPlannerChatApi();
        }
        async function callGeminiPlannerChatApi() {
            const apiKey = "AIzaSyDnrW-1uba9UTTyKJoGctm8eW8F5lSXmtE"; 
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: currentAiPlannerChatHistory, systemInstruction: {parts:[{text:"Sei un tutor pianificatore."}]} }) });
                const j = await r.json(); const txt = j.candidates?.[0]?.content?.parts?.[0]?.text;
                removeAiPlannerChatLoading(); if(txt) { renderAiPlannerChatMessage("model", txt); currentAiPlannerChatHistory.push({ role: "model", parts: [{ text: txt }] }); }
            } catch(e) { removeAiPlannerChatLoading(); renderAiPlannerChatMessage("model", "Errore."); }
        }
        function renderAiPlannerChatMessage(role, text, load=false) {
            const b = document.createElement('div'); b.className = `chat-bubble ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model planner'}`;
            b.innerHTML = load ? '<div class="loading-bubble"><div class="loading-dot bg-purple-400"></div><div class="loading-dot bg-purple-400"></div><div class="loading-dot bg-purple-400"></div></div>' : text.replace(/\n/g, '<br>');
            const c = document.getElementById('aiPlannerChatHistory'); c.appendChild(b); c.scrollTop = c.scrollHeight;
        }
        function removeAiPlannerChatLoading() { const l = document.getElementById('ai-planner-loading-bubble'); if(l) l.remove(); }

        // Progress
        function handleOpenProgressModal() {
            const today = new Date(); const tom = new Date(today); tom.setDate(today.getDate()+1); const tomStr = formatDate(tom);
            const weekDays = getWeekDays(currentWeekStart).map(d => formatDate(d.date));
            const arr = Object.values(allTasks);
            const tTasks = arr.filter(t => t.dueDate === tomStr);
            const tDone = tTasks.filter(t => t.completed).length;
            document.getElementById('dailyStats').innerText = `${tDone} / ${tTasks.length}`;
            const wTasks = arr.filter(t => weekDays.includes(t.dueDate));
            const wDone = wTasks.filter(t => t.completed).length;
            document.getElementById('weeklyStats').innerText = `${wDone} / ${wTasks.length}`;
            
            const ctx = document.getElementById('progressChart');
            if(progressChartInstance) progressChartInstance.destroy();
            progressChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Fatti', 'Da Fare'], datasets: [{ data: [wDone, wTasks.length-wDone], backgroundColor: ['#22C55E', '#E5E7EB'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
            document.getElementById('prizeSection').style.display = (wTasks.length>0 && wDone===wTasks.length) ? 'block' : 'none';
            openModal(document.getElementById('progressModal'));
        }

        function openModalNewTask(d, k) {
            document.getElementById('taskForm').reset(); document.getElementById('taskId').value=''; document.getElementById('dueDate').value=d; populateSubjectDropdown(k); document.getElementById('modalTitle').innerText="Nuovo"; openModal(document.getElementById('taskModal'));
        }
        function openModal(m) { m.style.display='flex'; if(typeof lucide!=='undefined') lucide.createIcons({nodes:[m]}); }
        function closeModal(m) { m.style.display='none'; if(m===document.getElementById('aiAssistantModal')) {currentAiTaskId=null; currentAiChatHistory=[];} if(m===document.getElementById('aiPlannerModal')) currentAiPlannerChatHistory=[]; }
        function showConfirm(m, cb) { document.getElementById('confirmMessage').innerText=m; confirmCallback=cb; openModal(document.getElementById('confirmModal')); }
        function closeConfirm() { closeModal(document.getElementById('confirmModal')); confirmCallback=null; }
        function getStartOfWeek(d) { d=new Date(d); d.setHours(0,0,0,0); const day=d.getDay(), diff=d.getDate()-day+(day==0?-6:1); return new Date(d.setDate(diff)); }
        function getWeekDays(start) { const a=[]; for(let i=0;i<5;i++) { let d=new Date(start); d.setDate(start.getDate()+i); a.push({date:d, name:Object.values(dayNames)[i], value:Object.keys(dayNames)[i]}); } return a; }
        function formatDate(d) { return d.toISOString().split('T')[0]; }
        function getDayKeyFromDate(s) { return ['sun','mon','tue','wed','thu','fri','sat'][new Date(s+'T00:00:00').getDay()]; }
        function formatWeekRange(s) { let e=new Date(s); e.setDate(s.getDate()+4); return `${s.getDate()}/${s.getMonth()+1} - ${e.getDate()}/${e.getMonth()+1}`; }
        function populateSubjectDropdown(k) { const s=document.getElementById('subject'); s.innerHTML='<option value="">Scegli...</option>'; [...new Set(timetable[k]||[])].forEach(v=>s.add(new Option(v,v))); }
        
        async function handleSaveCommitments(e) {
            e.preventDefault(); if (!userId) return;
            const data = {}; Object.keys(dayNames).forEach(k => data[k] = document.getElementById(`commitment-${k}`).value.trim());
            await setDoc(doc(db,"artifacts",appId,"users",userId,"data","commitments"), data);
            closeModal(document.getElementById('commitmentsModal'));
        }
        
        async function handleSaveStudentInfo(e) {
            e.preventDefault(); if (!userId) return;
            const data = { name: document.getElementById('studentName').value.trim(), surname: document.getElementById('studentSurname').value.trim(), age: document.getElementById('studentAge').value.trim(), gender: document.getElementById('studentGender').value, school: document.getElementById('studentSchool').value.trim(), classRoom: document.getElementById('studentClass').value.trim() };
            await setDoc(doc(db,"artifacts",appId,"users",userId,"data","student_info"), data);
            closeModal(document.getElementById('studentInfoModal'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const menu = document.getElementById('menuDropdown');
            document.getElementById('prevWeekBtn').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate()-7); renderWeekDisplay(currentWeekStart); };
            document.getElementById('nextWeekBtn').onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate()+7); renderWeekDisplay(currentWeekStart); };
            
            document.getElementById('menuToggleBtn').onclick = (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); };
            document.onclick = (e) => { if(!document.getElementById('menuContainer').contains(e.target)) menu.classList.add('hidden'); };
            menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => menu.classList.add('hidden')));

            document.getElementById('openAiPlannerButton').onclick = handleOpenAiPlanner;
            document.getElementById('openCommitmentsButton').onclick = () => openModal(document.getElementById('commitmentsModal'));
            document.getElementById('openFutureDeadlinesButton').onclick = () => { renderFutureDeadlinesList(); openModal(document.getElementById('futureDeadlinesModal')); };
            document.getElementById('openTimetableButton').onclick = () => openModal(document.getElementById('timetableModal'));
            document.getElementById('openProgressButton').onclick = handleOpenProgressModal;
            document.getElementById('openStudentInfoButton').onclick = () => openModal(document.getElementById('studentInfoModal'));

            document.getElementById('taskForm').onsubmit = handleSaveTask;
            document.getElementById('commitmentsForm').onsubmit = handleSaveCommitments;
            document.getElementById('futureDeadlineForm').onsubmit = handleSaveFutureDeadline;
            document.getElementById('aiChatForm').onsubmit = handleAiChatSubmit;
            document.getElementById('aiPlannerChatForm').onsubmit = handleAiPlannerChatSubmit;
            document.getElementById('studentInfoForm').onsubmit = handleSaveStudentInfo;

            document.getElementById('confirmCancel').onclick = closeConfirm;
            document.getElementById('confirmOk').onclick = () => { if(confirmCallback) confirmCallback(); closeConfirm(); };
            document.querySelectorAll('.close-modal-btn').forEach(b => b.onclick = function(){ closeModal(this.closest('.modal')); });

            initializeFirebase();
            if(typeof lucide!=='undefined') lucide.createIcons();
        });

    </script>
</body>
</html>
