<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacheca Compiti Settimanale</title>
    <!-- Caricamento di Tailwind CSS per uno stile moderno -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Caricamento della libreria di icone Lucide (standalone, senza React) -->
    <script src="https://unpkg.com/lucide/dist/umd/lucide.js"></script>

    <style>
        /* Utilizziamo un font pulito e leggibile */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Sfondo grigio chiaro */
        }
        /* Stile per un task completato */
        .task-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        /* Nasconde le modal per impostazione predefinita */
        #taskModal, #timetableModal, #confirmModal {
            display: none;
        }
        /* Stile per evidenziare il giorno corrente */
        .today-highlight {
            border-top: 4px solid #3b82f6; /* Bordo blu per "Oggi" */
        }
        /* Per nascondere la scrollbar orizzontale ma permettere lo scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- Contenitore principale dell'applicazione -->
    <div class="container mx-auto max-w-7xl p-0 sm:p-4">

        <!-- 1. Intestazione e Navigazione Settimana -->
        <header class="flex flex-col sm:flex-row justify-between items-center p-4 bg-white sm:rounded-lg shadow-md mb-4 sm:mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                Bacheca Compiti
            </h1>
            <div class="flex items-center gap-2 mt-4 sm:mt-0">
                <button id="todayButton" class="px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition">Oggi</button>
                <button id="prevWeekButton" class="p-2 text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span id="weekRangeDisplay" class="text-lg font-semibold text-gray-700 w-32 sm:w-40 text-center"></span>
                <button id="nextWeekButton" class="p-2 text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="flex gap-2 mt-4 sm:mt-0">
                <button id="openTimetableButton" class="px-4 py-2 text-base font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition">
                    Orario
                </button>
                <!-- Pulsante + Compito Rimosso da qui -->
            </div>
        </header>

        <!-- Spinner di caricamento -->
        <div id="loading" class="text-center p-10">
            <p class="text-gray-600">Caricamento dei compiti...</p>
        </div>

        <!-- 2. Contenitore a Scorrimento Orizzontale per i Giorni -->
        <div id="weekContainer" class="px-2 sm:px-0">
            <div id="weekGrid" class="flex flex-nowrap overflow-x-auto gap-3 pb-4 no-scrollbar" style="scroll-snap-type: x mandatory;">
                <!-- Le colonne dei giorni (5) verranno generate da JavaScript -->
            </div>
        </div>


    </div> <!-- Fine contenitore principale -->

    <!-- 3. Modal per Aggiungere/Modificare Compiti -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
        <!-- Contenuto della modal (invariato) -->
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <form id="taskForm">
                <h2 class="text-2xl font-bold mb-4">Nuovo Compito</h2>
                
                <!-- Campo Materia -->
                <div class="mb-4">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                    <select id="subject" name="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Seleziona una materia...</option>
                        <option value="Italiano">Italiano</option>
                        <option value="Storia">Storia</option>
                        <option value="Geografia">Geografia</option>
                        <option value="Matematica">Matematica</option>
                        <option value="Scienze">Scienze</option>
                        <option value="Inglese">Inglese</option>
                        <option value="Francese">Francese</option>
                        <option value="Spagnolo">Spagnolo</option>
                        <option value="Tedesco">Tedesco</option>
                        <option value="Latino">Latino</option>
                        <option value="Greco">Greco</option>
                        <option value="Filosofia">Filosofia</option>
                        <option value="Fisica">Fisica</option>
                        <option value="Chimica">Chimica</option>
                        <option value="Arte">Arte</option>
                        <option value="Musica">Musica</option>
                        <option value="Ed. Fisica">Ed. Fisica</option>
                        <option value="Tecnologia">Tecnologia</option>
                        <option value="Religione">Religione</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <!-- Campo Descrizione -->
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Es. Esercizi pag. 50, Studiare cap. 3..." required></textarea>
                </div>

                <!-- Campo Data di Scadenza -->
                <div class="mb-6">
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Data di Scadenza</label>
                    <input type="date" id="dueDate" name="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <!-- Pulsanti della Modal -->
                <div class="flex justify-end gap-4">
                    <button type="button" id="closeModalButton" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Annulla
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 transition">
                        Salva Compito
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal per Orario Lezioni -->
    <div id="timetableModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <form id="timetableForm">
                <h2 class="text-2xl font-bold mb-4">Orario Settimanale</h2>
                <p class="text-sm text-gray-600 mb-4">Inserisci le materie una per riga. Verranno salvate automaticamente.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Lunedì -->
                    <div>
                        <label for="tt_mon" class="block text-sm font-bold text-gray-700 mb-1">Lunedì</label>
                        <textarea id="tt_mon" name="Lun" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                    <!-- Martedì -->
                    <div>
                        <label for="tt_tue" class="block text-sm font-bold text-gray-700 mb-1">Martedì</label>
                        <textarea id="tt_tue" name="Mar" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                    <!-- Mercoledì -->
                    <div>
                        <label for="tt_wed" class="block text-sm font-bold text-gray-700 mb-1">Mercoledì</label>
                        <textarea id="tt_wed" name="Mer" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                    <!-- Giovedì -->
                    <div>
                        <label for="tt_thu" class="block text-sm font-bold text-gray-700 mb-1">Giovedì</label>
                        <textarea id="tt_thu" name="Gio" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                    <!-- Venerdì -->
                    <div>
                        <label for="tt_fri" class="block text-sm font-bold text-gray-700 mb-1">Venerdì</label>
                        <textarea id="tt_fri" name="Ven" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                </div>

                <!-- Pulsanti della Modal -->
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="closeTimetableModalButton" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Chiudi
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 transition">
                        Salva Orario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 5. Modal di Conferma Eliminazione -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Conferma eliminazione</h3>
            <p id="confirmMessage" class="text-sm text-gray-600 mb-6">Sei sicuro di voler eliminare questo compito?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Annulla
                </button>
                <button id="confirmDelete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">
                    Elimina
                </button>
            </div>
        </div>
    </div>


    <!-- =================================================== -->
    <!--          SCRIPT JAVASCRIPT E LOGICA FIREBASE        -->
    <!-- =================================================== -->

    <!-- Importazione dei moduli di Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where,
            setDoc, // Importa setDoc per salvare l'orario
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configurazione Firebase ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bacheca-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let tasksCollectionRef, timetableDocRef;
        let currentDate = new Date();
        let unsubscribeTasks = null;
        let unsubscribeTimetable = null;
        let currentTimetable = {}; // Cache per l'orario
        let deleteConfirmCallback = null; // Per la modal di conferma

        // Elementi DOM
        const loadingEl = document.getElementById('loading');
        const weekGridEl = document.getElementById('weekGrid');
        const weekRangeDisplayEl = document.getElementById('weekRangeDisplay');
        
        // Modal Compiti
        const modalEl = document.getElementById('taskModal');
        const taskFormEl = document.getElementById('taskForm');
        
        // Modal Orario
        const timetableModalEl = document.getElementById('timetableModal');
        const timetableFormEl = document.getElementById('timetableForm');

        // Modal Conferma
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmMessageEl = document.getElementById('confirmMessage');

        // Nomi dei giorni in italiano (solo feriali)
        const dayNames = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven"]; // Dom è [0], ci serve per i calcoli
        const dayKeys = ["Lun", "Mar", "Mer", "Gio", "Ven"]; // Per l'orario

        /**
         * Inizializzazione di Firebase e Autenticazione
         */
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                console.log("Autenticazione in corso...");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Utente autenticato:", user.uid);
                        userId = user.uid;
                        
                        // Path per i compiti
                        const collectionPath = `/artifacts/${appId}/users/${userId}/tasks`;
                        tasksCollectionRef = collection(db, collectionPath);
                        
                        // Path per l'orario (un singolo documento)
                        const settingsPath = `/artifacts/${appId}/users/${userId}/settings`;
                        timetableDocRef = doc(db, settingsPath, 'timetable');
                        
                        // Avvia i listener
                        listenToTimetable(); // Ascolta prima l'orario
                        renderWeekAndTasks(); // Poi renderizza la settimana (che attacca il listener dei compiti)

                    } else {
                        console.log("Nessun utente, tentativo di login...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Errore durante l'autenticazione:", authError);
                            loadingEl.innerText = "Errore di autenticazione. Impossibile caricare i compiti.";
                        }
                    }
                });
            } catch (e) {
                console.error("Errore inizializzazione Firebase:", e);
                loadingEl.innerText = "Errore di connessione. Ricarica la pagina.";
            }
        }

        /**
         * Ascolta le modifiche al documento dell'orario
         */
        function listenToTimetable() {
            if (unsubscribeTimetable) unsubscribeTimetable();

            unsubscribeTimetable = onSnapshot(timetableDocRef, (doc) => {
                if (doc.exists()) {
                    console.log("Orario caricato.");
                    currentTimetable = doc.data();
                } else {
                    console.log("Nessun orario trovato, uso oggetto vuoto.");
                    currentTimetable = {};
                }
                // Ridisegna la settimana per mostrare l'orario aggiornato
                renderWeekDisplay();
            }, (error) => {
                console.error("Errore nel listener dell'orario:", error);
            });
        }

        /**
         * Chiamata principale per renderizzare l'intera interfaccia
         */
        function renderWeekAndTasks() {
            loadingEl.style.display = 'block';
            weekGridEl.style.display = 'none';

            renderWeekDisplay(); // Disegna i 5 giorni (con l'orario se già caricato)
            attachTaskListener(); // Attacca il listener per i compiti
            
            loadingEl.style.display = 'none';
            weekGridEl.style.display = 'flex';
        }

        /**
         * Renderizza le 5 colonne dei giorni
         */
        function renderWeekDisplay() {
            weekGridEl.innerHTML = ''; // Pulisce la griglia
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const weekStart = getWeekMonday(currentDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 4); // 4 giorni dopo Lunedì = Venerdì

            weekRangeDisplayEl.innerText = `${formatDateShort(weekStart)} - ${formatDateShort(weekEnd)}`;

            for (let i = 0; i < 5; i++) { // Loop per 5 giorni
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                day.setHours(0, 0, 0, 0);

                const dayCard = document.createElement('div');
                // Classi per lo scorrimento orizzontale
                dayCard.className = 'flex-shrink-0 w-5/6 sm:w-1/3 lg:w-1/5 bg-white rounded-lg shadow p-3 flex flex-col min-h-[200px]';
                dayCard.style.scrollSnapAlign = 'start';
                
                if (day.getTime() === today.getTime()) {
                    dayCard.classList.add('today-highlight');
                }

                const dateStr = day.toISOString().split('T')[0];
                const dayKey = dayKeys[i]; // "Lun", "Mar", ...
                const dayName = dayNames[day.getDay()];
                const dayNum = day.getDate();

                // Genera HTML per l'orario
                const timetableString = currentTimetable[dayKey] || "";
                const subjects = timetableString.split('\n').filter(s => s.trim() !== '');
                let timetableHTML = '';
                if (subjects.length > 0) {
                    timetableHTML = subjects.map(s => 
                        `<div class="text-xs text-gray-700 bg-gray-50 rounded px-2 py-1 mb-1">${s}</div>`
                    ).join('');
                } else {
                    timetableHTML = `<div class="text-xs text-gray-400 italic">Nessun orario</div>`;
                }
                
                dayCard.innerHTML = `
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h2 class="text-lg font-bold text-gray-700">${dayName}</h2>
                        <span class="text-gray-500 font-medium">${dayNum}</span>
                    </div>
                    
                    <!-- Sezione Orario -->
                    <div class="mb-2">
                        <h3 class="font-semibold text-sm text-gray-500 mb-1">Orario</h3>
                        <div class="timetable-content max-h-32 overflow-y-auto pr-1">
                            ${timetableHTML}
                        </div>
                    </div>
                    <div class="border-t border-gray-100 my-2"></div>

                    <!-- Sezione Compiti -->
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm text-gray-500">Compiti</h3>
                        <button class="add-task-to-day-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow" data-date="${dateStr}">
                            <span data-lucide="plus" class="w-4 h-4"></span>
                        </button>
                    </div>
                    <div id="task-list-${dateStr}" class="task-list space-y-2 mt-2 flex-1">
                        <!-- I compiti per questo giorno verranno inseriti qui -->
                    </div>
                `;
                weekGridEl.appendChild(dayCard);
            }

            // Collega gli eventi ai nuovi pulsanti "+"
            weekGridEl.querySelectorAll('.add-task-to-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    openModal(date); // Passa la data alla funzione openModal
                });
            });
            
            // Inizializza le icone Lucide che potremmo aver aggiunto
            lucide.createIcons();
        }

        /**
         * Crea e attacca il listener di Firestore per la settimana visualizzata
         */
        function attachTaskListener() {
            if (unsubscribeTasks) {
                console.log("Staccato listener precedente.");
                unsubscribeTasks();
            }

            const weekStart = getWeekMonday(currentDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 4); // Venerdì

            const startDateStr = formatDate(weekStart);
            const endDateStr = formatDate(weekEnd);

            console.log(`Attacco listener per compiti tra ${startDateStr} e ${endDateStr}`);

            const q = query(
                tasksCollectionRef,
                where("dueDate", ">=", startDateStr),
                where("dueDate", "<=", endDateStr)
            );

            unsubscribeTasks = onSnapshot(q, (querySnapshot) => {
                console.log("Dati compiti ricevuti:", querySnapshot.docs.length, "documenti.");
                
                document.querySelectorAll('.task-list').forEach(list => {
                    list.innerHTML = '';
                });

                if (querySnapshot.empty) {
                    console.log("Nessun compito trovato per questa settimana.");
                }

                querySnapshot.docs.forEach((doc) => {
                    renderTask(doc.id, doc.data());
                });

            }, (error) => {
                console.error("Errore nel listener dei compiti:", error);
            });
        }

        /**
         * Renderizza un singolo task
         */
        function renderTask(id, data) {
            const taskListContainer = document.getElementById(`task-list-${data.dueDate}`);
            if (!taskListContainer) {
                return; // Compito non in questa settimana (o Sab/Dom)
            }

            const taskEl = document.createElement('div');
            taskEl.className = 'task-card bg-gray-50 border rounded-lg p-3 shadow-sm flex items-start gap-3';
            taskEl.dataset.id = id;

            if (data.completed) {
                taskEl.classList.add('task-completed');
            }
            
            const subjectColor = getSubjectColor(data.subject);

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = data.completed;
            checkbox.className = 'mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer';
            checkbox.addEventListener('change', () => {
                updateTaskStatus(id, checkbox.checked);
            });

            // Contenuto
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1';
            
            const subjectEl = document.createElement('div');
            subjectEl.className = `font-bold ${subjectColor}`;
            subjectEl.innerText = data.subject;

            const descriptionEl = document.createElement('div');
            descriptionEl.className = 'text-gray-700 text-sm break-words'; // Aggiunto break-words
            descriptionEl.innerText = data.description;

            contentDiv.appendChild(subjectEl);
            contentDiv.appendChild(descriptionEl);

            // Pulsante Elimina
            const deleteButton = document.createElement('button');
            deleteButton.className = 'ml-auto flex-shrink-0';
            deleteButton.addEventListener('click', () => {
                // Chiama la modal di conferma
                showConfirm("Sei sicuro di voler eliminare questo compito?", () => {
                    performDeleteTask(id);
                });
            });
            
            // Icona SVG
            // Sostituisco la chiamata a lucide.createIcon()
            // con il metodo 'data-lucide', che è più robusto
            // e ha funzionato in renderWeekDisplay.
            const trashIconSpan = document.createElement('span');
            trashIconSpan.setAttribute('data-lucide', 'Trash2');
            trashIconSpan.setAttribute('class', 'text-red-500 hover:text-red-700');
            trashIconSpan.setAttribute('width', 16);
            trashIconSpan.setAttribute('height', 16);
            deleteButton.appendChild(trashIconSpan);

            taskEl.appendChild(checkbox);
            taskEl.appendChild(contentDiv);
            taskEl.appendChild(deleteButton);

            taskListContainer.appendChild(taskEl);

            // Dico a Lucide di scansionare solo questo nuovo elemento (taskEl)
            // e convertire tutti gli span 'data-lucide' in SVG.
            lucide.createIcons({ nodes: [taskEl] });
        }

        /**
         * Gestisce il salvataggio di un nuovo compito
         */
        async function handleSaveTask(e) {
            e.preventDefault();
            if (!tasksCollectionRef) return;
            
            const formData = new FormData(taskFormEl);
            const taskData = {
                subject: formData.get('subject'),
                description: formData.get('description'),
                dueDate: formData.get('dueDate'),
                completed: false,
                userId: userId
            };

            try {
                await addDoc(tasksCollectionRef, taskData);
                closeModal();
            } catch (error) {
                console.error("Errore nell'aggiungere il compito:", error);
            }
        }

        /**
         * Gestisce il salvataggio dell'orario
         */
        async function handleSaveTimetable(e) {
            e.preventDefault();
            if (!timetableDocRef) return;

            const formData = new FormData(timetableFormEl);
            const timetableData = {
                Lun: formData.get('Lun'),
                Mar: formData.get('Mar'),
                Mer: formData.get('Mer'),
                Gio: formData.get('Gio'),
                Ven: formData.get('Ven'),
            };

            try {
                // setDoc sovrascrive il documento, che è quello che vogliamo
                await setDoc(timetableDocRef, timetableData);
                console.log("Orario salvato.");
                closeTimetableModal();
            } catch (error) {
                console.error("Errore nel salvare l'orario:", error);
            }
        }

        /**
         * Aggiorna lo stato (completato/non completato) di un task
         */
        async function updateTaskStatus(id, completed) {
            const taskDocRef = doc(db, tasksCollectionRef.path, id);
            try {
                await updateDoc(taskDocRef, { completed: completed });
            } catch (error) {
                console.error("Errore nell'aggiornare il compito:", error);
            }
        }

        /**
         * Mostra la modal di conferma
         */
        function showConfirm(message, callback) {
            confirmMessageEl.innerText = message;
            deleteConfirmCallback = callback;
            confirmModalEl.style.display = 'flex';
        }

        /**
         * Nasconde la modal di conferma
         */
        function hideConfirm() {
            deleteConfirmCallback = null;
            confirmModalEl.style.display = 'none';
        }

        /**
         * Esegue l'eliminazione effettiva del task
         */
        async function performDeleteTask(id) {
            console.log(`Elimino task ${id}`);
            const taskDocRef = doc(db, tasksCollectionRef.path, id);
            try {
                await deleteDoc(taskDocRef);
                hideConfirm();
            } catch (error) {
                console.error("Errore nell'eliminare il compito:", error);
                hideConfirm();
            }
        }

        // --- Funzioni Helper per Date e UI ---

        function getWeekMonday(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDateShort(date) {
            return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
        }
        
        function getSubjectColor(subject) {
            // ... (codice invariato)
            switch (subject.toLowerCase()) {
                case 'matematica':
                case 'fisica':
                case 'scienze':
                    return 'text-blue-700';
                case 'italiano':
                case 'storia':
                case 'filosofia':
                    return 'text-red-700';
                case 'inglese':
                case 'francese':
                case 'spagnolo':
                    return 'text-green-700';
                case 'arte':
                case 'musica':
                    return 'text-purple-700';
                default:
                    return 'text-gray-800';
            }
        }

        // --- Funzioni Modal (Compiti) ---
        function openModal(defaultDate = null) {
            taskFormEl.reset();
            
            if (defaultDate) {
                // Imposta la data passata dal pulsante
                taskFormEl.dueDate.value = defaultDate;
            } else {
                // Fallback: imposta domani se nessuna data è fornita
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                taskFormEl.dueDate.value = formatDate(tomorrow);
            }
            
            modalEl.style.display = 'flex';
        }

        function closeModal() {
            modalEl.style.display = 'none';
        }

        // --- Funzioni Modal (Orario) ---
        function openTimetableModal() {
            // Pre-compila la modal con i dati attuali
            timetableFormEl.Lun.value = currentTimetable.Lun || '';
            timetableFormEl.Mar.value = currentTimetable.Mar || '';
            timetableFormEl.Mer.value = currentTimetable.Mer || '';
            timetableFormEl.Gio.value = currentTimetable.Gio || '';
            timetableFormEl.Ven.value = currentTimetable.Ven || '';
            timetableModalEl.style.display = 'flex';
        }

        function closeTimetableModal() {
            timetableModalEl.style.display = 'none';
        }

        // --- Collegamento Eventi UI ---
        
        // Modal Compiti
        // Rimosso il listener per 'openModalButton'
        document.getElementById('closeModalButton').addEventListener('click', closeModal);
        taskFormEl.addEventListener('submit', handleSaveTask);

        // Modal Orario
        document.getElementById('openTimetableButton').addEventListener('click', openTimetableModal);
        document.getElementById('closeTimetableModalButton').addEventListener('click', closeTimetableModal);
        timetableFormEl.addEventListener('submit', handleSaveTimetable);

        // Modal Conferma
        document.getElementById('confirmCancel').addEventListener('click', hideConfirm);
        document.getElementById('confirmDelete').addEventListener('click', () => {
            if (deleteConfirmCallback) {
                deleteConfirmCallback();
            }
        });

        // Eventi di navigazione
        document.getElementById('prevWeekButton').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7);
            renderWeekAndTasks();
        });

        document.getElementById('nextWeekButton').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7);
            renderWeekAndTasks();
        });

        document.getElementById('todayButton').addEventListener('click', () => {
            currentDate = new Date();
            renderWeekAndTasks();
        });

        // Avvia l'app
        document.addEventListener('DOMContentLoaded', initFirebase);

    </script>
</body>
</html>
